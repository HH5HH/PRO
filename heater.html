<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HEATER</title>
  <style>
        :root {
      /* ==========================================================
         Spectrum 2 — Darkest theme (token map)
         ==========================================================
         Refactor goals:
         - High contrast, readable native controls (esp. <select> options)
         - Keep existing classnames/structure; swap colors to Spectrum-ish tokens
         - Avoid hard-coded hex values outside the token section
      */

      /* --- Core surfaces (Darkest) --- */
      --s2-canvas: #0b0b0c;
      --s2-surface-1: #141416;
      --s2-surface-2: #1b1b1d;
      --s2-surface-3: #242428;
      --s2-surface-4: #2c2c31;

      --s2-border: #34343a;
      --s2-border-strong: #42424a;
      --s2-divider: rgba(255, 255, 255, 0.08);

      /* --- Text --- */
      --s2-text: #f5f5f7;
      --s2-text-muted: #c9c9d4;
      --s2-text-subtle: #9fa0ad;
      --s2-text-disabled: #6f7080;

      /* --- Accent + semantics --- */
      --s2-accent: #2680eb;        /* Spectrum blue-500 */
      --s2-accent-strong: #0d66d0; /* Spectrum blue-600 */
      --s2-focus: #2680eb;
      --s2-focus-ring: rgba(38, 128, 235, 0.35);

      --s2-positive: #2d9d78; /* Spectrum green-500 */
      --s2-warning:  #e68619; /* Spectrum orange (approx) */
      --s2-negative: #e34850; /* Spectrum red-500 */
      --s2-neutral:  #5b5b66;

      --s2-link: #86b7ff;
      --s2-shadow-color: rgba(0, 0, 0, 0.55);

      /* --- App aliases (legacy variable names used throughout the app) --- */
      --bg: var(--s2-canvas);
      --panel: var(--s2-surface-1);
      --panel2: var(--s2-surface-2);
      --text: var(--s2-text);
      --muted: var(--s2-text-muted);
      --border: var(--s2-border);

      /* Heatmap semantics */
      --good: var(--s2-positive);
      --warn: var(--s2-warning);
      --bad:  var(--s2-negative);
      --unk:  var(--s2-neutral);

      --focus: var(--s2-focus);
      --shadow: var(--s2-shadow-color);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --spectrum-alias-body-text-font-family: adobe-clean, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      /* Keep a few Spectrum-ish globals for familiarity (used in a couple places) */
      --spectrum-global-color-gray-900: var(--s2-canvas);
      --spectrum-global-color-gray-800: var(--s2-surface-1);
      --spectrum-global-color-gray-700: var(--s2-border-strong);
      --spectrum-global-color-gray-200: var(--s2-text-subtle);
      --spectrum-global-color-gray-75:  #f5f5f7;
      --spectrum-global-color-gray-50:  #ffffff;
      --spectrum-global-color-blue-600: var(--s2-accent-strong);
      --spectrum-global-color-blue-500: var(--s2-accent);
      --spectrum-global-color-red-500:  var(--s2-negative);
      --spectrum-global-color-green-500: var(--s2-positive);

      /* Status-pill border helpers */
      --s2-positive-border: rgba(45, 157, 120, 0.55);
      --s2-warning-border:  rgba(230, 134, 25, 0.55);
      --s2-negative-border: rgba(227, 72, 80, 0.55);

      /* Spectrum 2: native <select> menu surfaces (Darkest)
         NOTE: Styling <option> is browser-dependent. We combine:
         - color-scheme: dark
         - explicit option bg/fg (best-effort)
      */
      --s2-select-option-bg: var(--s2-surface-2);
      --s2-select-option-bg-alt: var(--s2-surface-3);
      --s2-select-option-fg: var(--s2-text);
      --s2-select-option-fg-muted: var(--s2-text-muted);
      --s2-select-option-selected-bg: rgba(38, 128, 235, 0.35);
      --s2-select-option-selected-fg: var(--s2-text);

      /* Hint to the browser that the UI is dark (improves native control rendering) */
      color-scheme: dark;
    }


    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--spectrum-alias-body-text-font-family, var(--sans));
    }
    body {
      padding: 16px;
    }

    body[data-theme="mondrian"] {
      --border: #0a0a0a;
    }

    body[data-theme="mondrian"] .cell,
    body[data-theme="mondrian"] .signal-label {
      border-width: 2px;
    }

    body[data-theme="genome"] {
      --good: #2bdc8a;
      --warn: #ffb020;
      --bad:  #ff4d4d;
      --border: #263042;
    }

    a {
      color: var(--s2-link);
      text-decoration: none;
    }
    a:hover { text-decoration: underline; }

    .app-shell {
      display: none;
      max-width: 1780px;
      margin: 0 auto;
    }
    .app-shell.authenticated { display: block; }

    .preauth-gate {
      min-height: calc(100vh - 32px);
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .preauth-gate.hidden { display: none; }
    .preauth-card {
      width: min(760px, 94vw);
      background: var(--panel);
      border: 1px solid var(--s2-border-strong);
      border-radius: 18px;
      box-shadow: 0 24px 60px var(--shadow);
      padding: 30px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .preauth-card h1 {
      margin: 0;
      font-size: 26px;
      line-height: 1.2;
      letter-spacing: .2px;
    }
    .preauth-card p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      max-width: 64ch;
    }
    .preauth-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .preauth-status {
      display: inline-flex;
      align-items: center;
      min-height: 36px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--muted);
      font-size: 13px;
    }
    .preauth-status.ok { border-color: var(--s2-positive-border); color: var(--text); }
    .preauth-status.warn { border-color: var(--s2-warning-border); color: var(--text); }
    .preauth-status.err { border-color: var(--s2-negative-border); color: var(--text); }

    .build-corner {
      position: fixed;
      right: 10px;
      bottom: 8px;
      z-index: 5;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.05);
      background: rgba(255,255,255,.015);
      color: rgba(255,255,255,.34);
      font-size: 10px;
      letter-spacing: .2px;
      user-select: none;
      pointer-events: none;
    }

    .topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: var(--panel);
  border: 1px solid var(--s2-border-strong);
  border-radius: 14px;
  margin-bottom: 16px;
  position: sticky;
  top: 8px;
  z-index: 10;
}

    .brand {
      display: flex;
      align-items: baseline;
      gap: 10px;
      font-weight: 650;
      letter-spacing: .2px;
    }
    .brand small {
      font-weight: 500;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .controls label {
      font-size: 13px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }

    select, input[type="number"], input[type="text"], button {
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
    }


    /* Spectrum 2: Make native <select> dropdown options readable in dark UI.
       (Styling <option> is browser-dependent; these rules are best-effort.) */
    select { color-scheme: dark; }

    select option,
    select optgroup {
      background-color: var(--s2-select-option-bg) !important;
      color: var(--s2-select-option-fg) !important;
    }

    /* Alternate row backgrounds for readability */
    select option:nth-of-type(even) {
      background-color: var(--s2-select-option-bg-alt) !important;
    }

    select option:disabled {
      color: var(--s2-select-option-fg-muted) !important;
    }

    /* Selected option (some browsers ignore custom styling here) */
    select option:checked {
      background-color: var(--s2-select-option-selected-bg) !important;
      color: var(--s2-select-option-selected-fg) !important;
    }


    select:focus, input:focus, button:focus {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px var(--s2-focus-ring);
    }

    button {
      cursor: pointer;
    }
    button:hover {
      border-color: var(--s2-border-strong);
      background: var(--s2-surface-3);
    }
    button.primary {
      background: var(--s2-accent);
      border-color: var(--s2-accent-strong);
      color: #fff;
    }
    button.primary:hover {
      background: var(--s2-accent-strong);
      border-color: var(--s2-accent-strong);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.02);
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--unk);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25) inset;
    }
    .dot.busy {
      background: var(--warn);
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: .4; }
      50% { opacity: 1; }
      100% { opacity: .4; }
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.015);
    }

    .filterbox {
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 8px 18px var(--shadow);
    }

    .filterbox header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .filterbox h3 {
      font-size: 12px;
      margin: 0;
      color: var(--muted);
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: .6px;
    }

    .filterbox .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filterbox select {
      width: 100%;
      min-height: 34px;
    }

    .content {
      padding: 20px;
    }

    .dc-report-wrap {
      margin-top: 16px;
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 24px var(--shadow);
    }
    .dc-report-wrap .dc-report-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.02);
    }
    .dc-report-wrap .dc-report-head h3 {
      margin: 0;
      font-size: 13px;
      font-weight: 650;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .dc-report-wrap .esm-table-wrapper {
      margin-top: 0;
    }

    .heatmap-wrap {
      border: 1px solid var(--border);
      background: var(--panel2);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 24px var(--shadow);
    }

    .heatmap-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      gap: 10px;
      flex-wrap: wrap;
    }

    .heatmap-head .left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 220px;
    }
    .heatmap-head .title {
      font-size: 14px;
      font-weight: 700;
    }
    .heatmap-head .subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .heatmap-head .right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .legend {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }
    .legend .sw {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,.4);
    }

    .grid {
      overflow: auto;
      max-height: calc(100vh - 240px);
    }

    .grid-inner {
      min-width: 900px;
    }

    .row {
      display: grid;
      grid-template-columns: 300px repeat(var(--bucket-cols, 12), 18px);
      gap: 8px;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.04);
      align-items: center;
    }

    .row.group {
      background: rgba(0,0,0,.15);
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .row.group .signal-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
      text-transform: uppercase;
      letter-spacing: .6px;
      background: transparent;
      border: none;
      padding: 0;
    }

    .row.header {
      background: var(--panel2);
      position: sticky;
      top: 0;
      z-index: 3;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 1px 0 var(--border);
    }

    .signal-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }

    .signal-label:hover {
      border-color: rgba(134,183,255,.35);
    }

    .signal-label .name {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .signal-label .name strong {
      font-size: 13px;
      font-weight: 650;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .signal-label .name small {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .signal-label .value {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      flex: 0 0 auto;
    }

    .cell {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,.35);
      box-sizing: border-box;
      cursor: pointer;
      position: relative;
    }

    .cell.st-good { background: var(--good); }
    .cell.st-warn { background: var(--warn); }
    .cell.st-bad  { background: var(--bad);  }
    .cell.st-unk  { background: var(--unk);  }

    .cell.now {
      outline: 2px solid rgba(255,255,255,.35);
      outline-offset: 1px;
    }

    .cell:focus {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .hdr {
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
      text-align: center;
    }

    /* ---------- Drawer ---------- */
    .drawer {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 50;
      background: rgba(0,0,0,.55);
    }
    .drawer.show { display: block; }

    .drawer .panel {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: min(920px, 96vw);
      background: var(--panel);
      border-left: 1px solid var(--border);
      box-shadow: -18px 0 40px rgba(0,0,0,.45);
      display: flex;
      flex-direction: column;
    }

    .drawer header {
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .drawer header .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .drawer header .title strong {
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .drawer header .title small {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .drawer header .actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .drawer main {
      padding: 14px;
      overflow: auto;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .kpi {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      padding: 10px;
    }
    .kpi .k {
      font-size: 12px;
      color: var(--muted);
    }
    .kpi .v {
      margin-top: 4px;
      font-size: 18px;
      font-family: var(--mono);
    }

    .mini-heat {
      display: grid;
      grid-template-columns: repeat(var(--mini-cols, 12), 16px);
      gap: 6px;
      margin-top: 8px;
    }
    .mini-heat .cell {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .mini-heat .cell.sel {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
      transform: scale(1.08);
      z-index: 1;
    }
    .mini-heat .cell.latest::after {
      content: '';
      position: absolute;
      right: -2px;
      top: -2px;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #fff;
      opacity: .9;
    }

    .section {
      margin-top: 14px;
    }
    .section h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .6px;
      color: var(--muted);
    }

    .pillbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.02);
      cursor: pointer;
      user-select: none;
      font-size: 12px;
    }
    .pill:hover { border-color: rgba(134,183,255,.35); }
    .pill small {
      color: var(--muted);
      font-family: var(--mono);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
      table-layout: fixed;
    }
    .esm-table-wrapper{
      max-height: 16.5em;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      background: rgba(255,255,255,.02);
      margin-top: 6px;
    }
    .esm-table-wrapper table{
      margin-top: 0;
    }
    .esm-table-footer{
      position: sticky;
      bottom: 0;
      z-index: 4;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 7px 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: var(--panel);
    }
    .csv-footer-btn{
      border: none;
      background: transparent;
      color: var(--s2-negative);
      font-weight: 700;
      letter-spacing: .15px;
      padding: 0;
      font-size: 12px;
      cursor: pointer;
    }
    .csv-footer-btn:hover{
      border: none;
      background: transparent;
      color: var(--s2-negative);
      text-decoration: underline;
    }
    .csv-footer-btn:focus{
      border: none;
      background: transparent;
      box-shadow: 0 0 0 2px var(--s2-focus-ring);
      border-radius: 4px;
      outline: none;
    }
    th.sortable{
      cursor: pointer;
      user-select: none;
    }
    th .sort-icon{
      float: right;
      opacity: .85;
      font-size: 10px;
      margin-left: 6px;
    }
    th.active-sort{
      color: var(--text);
      text-decoration: underline;
    }
    th, td {
      border-bottom: 1px solid rgba(255,255,255,.06);
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 0;
    }
    th {
      color: var(--muted);
      font-weight: 650;
      position: sticky;
      top: 0;
      background: var(--panel);
    }
    tr:hover td {
      background: rgba(134,183,255,.06);
    }
    td.mono {
      font-family: var(--mono);
    }
    td.num {
      font-family: var(--mono);
      text-align: right;
    }

    
    /* ---------- Table helpers: numeric + RAG semantics ---------- */
    th.num {
      text-align: right;
      font-family: var(--mono);
    }

    th.rag,
    td.rag {
      text-align: center;
      font-family: var(--mono);
      font-weight: 750;
      letter-spacing: .35px;
    }

    /* RAG indicator: MILA-style color squares inside a pill */
    .rag-pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 3px 10px 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      line-height: 1.1;
      user-select: none;
    }
    .rag-sq{
      width: 12px;
      height: 12px;
      border-radius: 3px;
      background: rgba(91, 91, 102, 1);
      border: 1px solid rgba(0,0,0,.35);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
      flex: 0 0 auto;
    }

.tag {
      display: inline-flex;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      font-size: 11px;
      margin-left: 6px;
      color: var(--muted);
    }

    .smallnote {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .kbd {
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
  
    /* ---------- Session / Advanced menu ---------- */
    details.adv {
      position: relative;
    }
    details.adv > summary {
      list-style: none;
      cursor: pointer;
      user-select: none;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
    }
    details.adv > summary::-webkit-details-marker { display:none; }
    details.adv[open] > summary {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px var(--s2-focus-ring);
    }
    details.adv .adv-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 6px);
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 220px;
      box-shadow: 0 12px 28px var(--shadow);
      z-index: 50;
    }
    details.adv .adv-menu button {
      width: 100%;
      text-align: left;
      white-space: nowrap;
    }

    .status-pill.ok { border-color: var(--s2-positive-border); color: var(--text); }
    .status-pill.warn { border-color: var(--s2-warning-border); color: var(--text); }
    .status-pill.err { border-color: var(--s2-negative-border); color: var(--text); }

    /* ---------- Login Modal ---------- */
    .login-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.72);
      z-index: 1000;
      padding: 16px;
    }
    .login-modal.show { display: flex; }
    .login-dialog {
      position: relative;
      width: min(560px, 96vw);
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      padding: 18px 18px 14px 18px;
    }
    .login-dialog h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 750;
      letter-spacing: .2px;
    }
    .login-dialog p {
      margin: 0 0 10px 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .login-dialog .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .login-dialog .close-x {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 34px;
      height: 34px;
      border-radius: 10px;
      font-size: 18px;
      line-height: 1;
      padding: 0;
    }

  </style>
</head>
<body data-theme="boom">
  <!-- Credentials: keep the same hidden inputs as clickESM.html for drop-in use. -->
  <input type="hidden" name="cid" value="" />
  <input type="hidden" name="csc" value="" />
  <input type="hidden" name="access_token" value="" />

  <div id="preAuthGate" class="preauth-gate" aria-hidden="false">
    <section class="preauth-card" aria-label="Authentication required">
      <h1>HEATER</h1>
      <div class="preauth-actions">
        <button id="authGateBtn" class="primary" title="Open Adobe Pass login popup">LOGIN HERE</button>
      </div>
      <div id="preAuthStatus" class="preauth-status">Checking Adobe session…</div>
    </section>
  </div>

  <div id="appShell" class="app-shell" aria-hidden="true">
  <div class="topbar">
    <div class="brand">
      <div>HEATER</div>
      <small id="mcTag">—</small>
    </div>

    <div class="controls">
      <button id="authBtn" class="primary" title="Login required to load Media Companies / Apps">LOGIN HERE</button>

      <label title="Select the Media Company (Programmer) to monitor">
        Media Co
        <select id="programmerSelect" disabled style="min-width:220px;">
          <option value="">— login first —</option>
        </select>
      </label>

      <label title="Select a Registered Application that has the Analytics client scope (ESM)">
        ESM App
        <select id="appSelect" disabled style="min-width:220px;">
          <option value="">— select media co —</option>
        </select>
      </label>

      <button id="btnClearFilters" title="Clear Requestor/MVPD filters">Clear Filters</button>

      <label title="Filter by selected requestor-id(s). Leave unselected for media-company scope.">
        Requestor
        <select id="fltr_requestorid" multiple size="1" style="min-width:220px;" title="Filter by selected requestor-id(s). Leave unselected for media-company scope."></select>
      </label>

      <label title="Filter by selected MVPD(s)">
        MVPD
        <select id="fltr_mvpdId" multiple size="1" disabled style="display:none; min-width:220px;" title="Filter by selected MVPD(s)"></select>
      </label>

      <label title="Filter visible signals">
        Search
        <input id="searchBox" type="text" placeholder="authz, mvpd, latency, dc, device, reason…" style="min-width:200px;" />
      </label>

      <span class="tag" id="matchCount" title="Signals shown">—</span>

      <label title="Window size (auto bucket follows this)">
        Window
        <input id="lookbackValue" type="number" min="1" max="240" value="12" style="width:72px;" />
      </label>

      <label title="Window unit; bucket auto resolves to DAY/HR/MIN from this window">
        Unit
        <select id="lookbackUnit">
          <option value="minute">MIN</option>
          <option value="hour" selected>HR</option>
          <option value="day">DAY</option>
        </select>
      </label>

      <label title="Lookback from now or look forward from now">
        Direction
        <select id="lookDirection">
          <option value="backward" selected>Lookback</option>
          <option value="forward">Forward</option>
        </select>
      </label>

      <span class="tag" id="bucketAutoTag" title="Bucket is auto-resolved (not user selectable)">AUTO: HR</span>

      <label>
        Refresh
        <select id="refreshSec">
          <option value="30">30s</option>
          <option value="60" selected>60s</option>
          <option value="120">120s</option>
          <option value="300">300s</option>
        </select>
      </label>

      <label title="Auto-refresh the dashboard">
        <input id="autoRefresh" type="checkbox" checked />
        Auto
      </label>

      <button id="btnExportCsv" title="Export the current view as CSV (heatmap or RCA)">Export CSV</button>
      <button id="btnExportPng" title="Export the current view as a PNG receipt (heatmap or RCA)">Export PNG</button>

      <details class="adv">
        <summary title="Advanced tools">Advanced</summary>
        <div class="adv-menu">
          <button id="btnManualCreds" title="Manually set client_id/client_secret for the selected Media Co (stored in localStorage)">Manual cid/csc…</button>
          <button id="btnResetClient" title="Forget stored client_id/client_secret for this Media Co (forces new DCR register)">Reset client</button>
          <button id="btnClearToken" title="Clear cached access token (forces token refresh)">Clear token</button>
        </div>
      </details>

      <button class="primary" id="btnRefresh" title="Refresh now (Ctrl/⌘ + R still works)">Refresh</button>

      <span class="status-pill" title="Network activity">
        <span id="netDot" class="dot"></span>
        <span id="netText">idle</span>
      </span>

      <span class="status-pill" id="statusMsg" title="Session + provisioning status">—</span>

      <a class="status-pill" href="clickESM.html" target="_blank" rel="noopener" title="Open the full 240-URL dictionary / query runner in a new tab">
        API Dictionary (clickESM)
      </a>
    </div>
  </div>

<div class="content">
    <div class="heatmap-wrap">
      <div class="heatmap-head">
        <div class="left">
          <div class="title" id="gridTitle">HEATER (12h)</div>
          <div class="subtitle" id="gridSubtitle">—</div>
        </div>
        <div class="right">
          <div class="legend" title="RAG coloring is based on derived rates/latency thresholds (editable in code)">
            <span class="sw" style="background:var(--good)"></span> Good
            <span class="sw" style="background:var(--warn)"></span> Warn
            <span class="sw" style="background:var(--bad)"></span> Bad
            <span class="sw" style="background:var(--unk)"></span> No data
          </div>
        </div>
      </div>

      <div class="grid">
        <div id="grid" class="grid-inner"></div>
      </div>
    </div>

    <div id="dcReportWrap" class="dc-report-wrap" aria-label="DataCenter report">
      <div class="dc-report-head">
        <h3>DataCenter report (ESM URLs with /dc)</h3>
      </div>
      <div id="dcReportTableWrap"></div>
    </div>

    <div id="deviceReportWrap" class="dc-report-wrap device-report-wrap" aria-label="Device report (By Device)" style="display:none;">
      <div class="dc-report-head">
        <h3>Device report (by day) — By Device</h3>
      </div>
      <div id="deviceReportTableWrap"></div>
    </div>

    <div id="reasonReportWrap" class="dc-report-wrap reason-report-wrap" aria-label="Reason report (event • reason counts)">
      <div class="dc-report-head">
        <h3>Reason report — Only reasons that need attention (≠ None), PAR3 click to RCA</h3>
      </div>
      <div id="reasonReportTableWrap"></div>
    </div>
  </div>

  <!-- ---------- RCA Drawer ---------- -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="RCA panel">
      <header>
        <div class="title">
          <strong id="rcaTitle">—</strong>
          <small id="rcaSubtitle">—</small>
        </div>
        <div class="actions">
          <button id="btnCopyLink" title="Copy a deep link to this RCA view">Copy link</button>
          <button id="btnDownloadCsv" title="Download current table as CSV">CSV</button>
          <button id="btnCloseDrawer" class="primary" title="Close (Esc)">Close</button>
        </div>
      </header>

      <main>
        <div class="kpi-grid" id="rcaKpis"></div>

        <div class="section">
          <h4>Active buckets</h4>
          <div class="mini-heat" id="rcaMiniHeat"></div>
        </div>

        <div class="section">
          <h4>Probable RCA steps</h4>
          <div class="pillbar" id="rcaPills"></div>
        </div>

        <div class="section">
          <h4>Details</h4>
          <div id="rcaDetails" class="smallnote">—</div>
        </div>

        <div class="section">
          <h4>Data</h4>
          <div id="rcaTableWrap"></div>
        </div>

        <div class="section">
          <h4>API Dictionary</h4>
          <p class="smallnote" style="margin:0 0 8px 0;">
            Need a deeper slice? You can also open the full dictionary in <a href="clickESM.html" target="_blank" rel="noopener">clickESM</a>.
          </p>
          <div class="row" style="grid-template-columns: 1fr auto; gap: 10px; padding:0; border:none;">
            <select id="dictSelect" style="width:100%;"></select>
            <button id="btnRunDict">Run</button>
          </div>
          <div id="dictResult" style="margin-top:10px;"></div>
        </div>

        <p class="smallnote" style="margin-top:14px;">
          Note: This is a front-end only tool. It uses the same client-credentials token flow as clickESM.html.
        </p>
      </main>
    </div>
  </div>
  </div>

  
  <!-- ---------- Login Modal ---------- -->
  <div id="loginModal" class="login-modal" aria-hidden="true">
    <div class="login-dialog" role="dialog" aria-modal="true" aria-label="Adobe login required">
      <button id="closeModalBtn" class="close-x" title="Close">×</button>
      <h2>Adobe Experience Cloud Login</h2>
      <p>
        This dashboard needs an authenticated Adobe Pass console session to load Media Companies and provision ESM client credentials.
        A popup will open the Adobe Pass TVE dashboard. Complete login there, then return here.
      </p>
      <div id="modalStatus" class="smallnote">—</div>
      <div class="actions">
        <button id="cancelLoginBtn">Close</button>
        <button id="retryAuthBtn" class="primary">Re-check session</button>
      </div>
    </div>
  </div>
  <div id="buildCorner" class="build-corner" aria-hidden="true">build —</div>

<script>
    /* ============================================================
       HEATER
       - Single-file, front-end only
       - Uses the 240 URL dictionary from clickESM.html
       - Goal: “what’s happening right now” + live context + PAR3 clicks to probable RCA
       ============================================================ */

    const APP_VERSION = "1.3.0";
    const UNAUTH_MESSAGE = "⚠️ Ahoy there buckaroo, this tool requires authentication. Please login using the button, and close the popup once you're done";
    const ESM_DICTIONARY = [{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","media-company","media-tokens","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","media-company","media-tokens","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event","cols":["count","day","event","media-company","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event/requestor-id","cols":["count","day","event","media-company","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event/requestor-id/proxy","cols":["count","day","event","media-company","month","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event/requestor-id/proxy/mvpd","cols":["count","day","event","media-company","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event/requestor-id/proxy/mvpd/reason","cols":["count","day","event","media-company","month","mvpd","proxy","reason","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event/requestor-id/proxy/mvpd/reason/dc","cols":["count","day","dc","event","media-company","month","mvpd","proxy","reason","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event","cols":["count","day","event","hour","media-company","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event/requestor-id","cols":["count","day","event","hour","media-company","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event/requestor-id/proxy","cols":["count","day","event","hour","media-company","month","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event/requestor-id/proxy/mvpd","cols":["count","day","event","hour","media-company","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event/requestor-id/proxy/mvpd/reason","cols":["count","day","event","hour","media-company","month","mvpd","proxy","reason","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event/requestor-id/proxy/mvpd/reason/dc","cols":["count","day","dc","event","hour","media-company","month","mvpd","proxy","reason","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","minute","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event","cols":["count","day","event","hour","media-company","minute","month","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event/requestor-id","cols":["count","day","event","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event/requestor-id/proxy","cols":["count","day","event","hour","media-company","minute","month","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event/requestor-id/proxy/mvpd","cols":["count","day","event","hour","media-company","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event/requestor-id/proxy/mvpd/reason","cols":["count","day","event","hour","media-company","minute","month","mvpd","proxy","reason","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event/requestor-id/proxy/mvpd/reason/dc","cols":["count","day","dc","event","hour","media-company","minute","month","mvpd","proxy","reason","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","proxy","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","proxy","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt/channel/platform-version","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","hour","media-company","media-tokens","minute","month","mvpd","platform-version","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt/channel/platform-version/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","dc","hour","media-company","media-tokens","minute","month","mvpd","platform-version","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","dc","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt/sso-type","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/cdt/sso-type/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","dc","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/eap","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","minute","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/eap/platform","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/eap/platform/nsdk","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","minute","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/eap/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/eap/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","dc","eap","hour","media-company","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/sso-type","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/sso-type/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","hour","media-company","minute","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","minute","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","minute","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","minute","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","media-tokens","minute","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","hour","media-company","media-tokens","minute","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","hour","media-company","media-tokens","minute","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","hour","media-company","media-tokens","minute","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id/platform/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","minute","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","proxy","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","proxy","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","mvpd","proxy","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/cdt","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/cdt/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/cdt/channel/platform-version","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","hour","media-company","media-tokens","month","mvpd","platform-version","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/cdt/channel/platform-version/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","dc","hour","media-company","media-tokens","month","mvpd","platform-version","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/cdt/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","dc","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/customer-app","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/customer-app/content-category","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","content-category","customer-app","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/customer-app/content-category/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/customer-app/content-category/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","dc","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","mvpd","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/eap","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/eap/platform","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/eap/platform/nsdk","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/eap/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","hour","media-company","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/eap/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","dc","eap","hour","media-company","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app/content-category","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","content-category","customer-app","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app/content-category/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app/content-category/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","dc","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/sso-type","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/sso-type/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","sso-type","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","hour","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","hour","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","hour","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","hour","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","hour","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","hour","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","hour","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","hour","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","hour","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","hour","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id/platform/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","hour","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","proxy","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","proxy","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","proxy","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/eap","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","media-company","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/eap/platform","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","media-company","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/eap/platform/nsdk","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","media-company","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/eap/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","eap","media-company","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/eap/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-failed","authn-pending","authn-successful","day","dc","eap","media-company","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","unique-accounts","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/platform/nsdk","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/sso-type","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/platform/nsdk/nsdk-version/sso-type/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","sso-type","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt/channel/platform-version","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","media-company","media-tokens","month","platform-version","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt/channel/platform-version/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","channel","day","dc","media-company","media-tokens","month","platform-version","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt/sso-type","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","media-company","media-tokens","month","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/cdt/sso-type/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","cdt","day","dc","media-company","media-tokens","month","requestor-id","sso-type","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app/content-category","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","content-category","customer-app","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app/content-category/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app/content-category/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/device","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","device","media-company","media-tokens","month","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/device/os-family","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","device","media-company","media-tokens","month","os-family","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/device/os-family/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","device","media-company","media-tokens","month","os-family","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/os-family","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","os-family","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/os-family/browser-family","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","browser-family","day","media-company","media-tokens","month","os-family","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/os-family/browser-family/browser-version","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","browser-family","browser-version","day","media-company","media-tokens","month","os-family","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/os-family/browser-family/browser-version/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","browser-family","browser-version","day","dc","media-company","media-tokens","month","os-family","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name/application-version/api","cols":["api","application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name/application-version/api/dc","cols":["api","application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app/content-category","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","content-category","customer-app","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app/content-category/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","media-company","media-tokens","month","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app/content-category/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","nsdk","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","nsdk","nsdk-version","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","media-company","media-tokens","month","nsdk","nsdk-version","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","media-company","media-tokens","month","nsdk","nsdk-version","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","nsdk","nsdk-version","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/os-family","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","nsdk","nsdk-version","os-family","platform","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/os-family/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","nsdk","nsdk-version","os-family","platform","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/sso-type","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","nsdk","nsdk-version","platform","requestor-id","sso-type","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/platform/nsdk/nsdk-version/sso-type/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","nsdk","nsdk-version","platform","requestor-id","sso-type","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/device","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","device","media-company","media-tokens","month","mvpd","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/device/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","device","media-company","media-tokens","month","mvpd","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/application-name","cols":["application-name","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/application-name/application-version","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/application-name/application-version/channel","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/application-name/application-version/channel/dc","cols":["application-name","application-version","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","day","dc","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/application-name/application-version/dc","cols":["application-name","application-version","authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","customer-app","day","dc","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/channel/decision-type","cols":["channel","customer-app","day","decision-attempts","decision-failed","decision-media-tokens","decision-successful","decision-type","media-company","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/channel/decision-type/dc","cols":["channel","customer-app","day","dc","decision-attempts","decision-failed","decision-media-tokens","decision-successful","decision-type","media-company","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/content-category","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","content-category","customer-app","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/content-category/channel","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/content-category/channel/dc","cols":["authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","channel","content-category","customer-app","day","dc","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/customer-app/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","customer-app","day","dc","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/nsdk","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","nsdk","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/nsdk/nsdk-version","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/nsdk/nsdk-version/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/nsdk/nsdk-version/os-family","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","os-family","platform","proxy","requestor-id","year"]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/nsdk/nsdk-version/os-family/browser-family","cols":[]},{"url":"https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/platform/nsdk/nsdk-version/os-family/dc","cols":["authn-attempts","authn-pending","authn-successful","authz-attempts","authz-failed","authz-latency","authz-rejected","authz-successful","day","dc","media-company","media-tokens","month","mvpd","nsdk","nsdk-version","os-family","platform","proxy","requestor-id","unique-accounts","unique-sessions","year"]}];

    /* ---------- Network Busy Indicator ---------- */
    let __netInFlight = 0;
    function __setNetBusy(busy) {
      const dot = document.getElementById('netDot');
      const txt = document.getElementById('netText');
      if (dot) dot.classList.toggle('busy', !!busy);
      if (txt) txt.textContent = busy ? 'loading…' : 'idle';
    }
    function __netStart() {
      __netInFlight++;
      if (__netInFlight === 1) __setNetBusy(true);
    }
    function __netEnd() {
      __netInFlight = Math.max(0, __netInFlight - 1);
      if (__netInFlight === 0) __setNetBusy(false);
    }

    /* ---------- App / Session State ---------- */
    const STORAGE_PREFIX = 'ESM_LHH';
    const CONSOLE_BASE = 'https://console.auth.adobe.com';
    const TVE_DASHBOARD_URL = 'https://experience.adobe.com/#/@adobepass/pass/authentication/release-production';
    const CONSOLE_CONFIGURATION_VERSION = 3522;

    const state = {
      authenticated: false,
      programmersEndpoint: null,
      programmers: [],
      apps: [],
      selectedProgrammerId: '',
      selectedProgrammerName: '',
      selectedAppGuid: '',
      selectedAppName: '',
      esmClient: null,        // { client_id, client_secret, appGuid, appName, createdAt }
      accessToken: '',
      accessTokenExp: 0,      // epoch ms
      lastRenderModel: null,  // populated after refreshAll()
      lastRefreshAt: null,
      restoreRcaFromHashPending: true
    };

    function lsKey(s) { return `${STORAGE_PREFIX}.${s}`; }
    function tokenKeyForCid(cid) { return lsKey(`token.${cid}`); }
    function clientKeyForProgrammer(pid) { return lsKey(`client.${pid}`); }
    function lastAppKeyForProgrammer(pid) { return lsKey(`lastApp.${pid}`); }

    function getDefaultProgrammerId() { return localStorage.getItem(lsKey('defaultProgrammerId')) || ''; }
    function setDefaultProgrammerId(pid) { if (pid) localStorage.setItem(lsKey('defaultProgrammerId'), pid); }

    function getLastProgrammerId() { return localStorage.getItem(lsKey('lastProgrammerId')) || ''; }
    function setLastProgrammerId(pid) { if (pid) localStorage.setItem(lsKey('lastProgrammerId'), pid); }

    function setStatus(msg, tone = 'info') {
      const el = document.getElementById('statusMsg');
      if (el) {
        el.textContent = msg || '—';
        el.classList.remove('ok','warn','err');
        if (tone === 'ok') el.classList.add('ok');
        if (tone === 'warn') el.classList.add('warn');
        if (tone === 'err') el.classList.add('err');
      }

      const pre = document.getElementById('preAuthStatus');
      if (pre) {
        pre.textContent = msg || '—';
        pre.classList.remove('ok','warn','err');
        if (tone === 'ok') pre.classList.add('ok');
        if (tone === 'warn') pre.classList.add('warn');
        if (tone === 'err') pre.classList.add('err');
      }
    }

    function setAuthenticatedUi(authenticated) {
      const gate = document.getElementById('preAuthGate');
      const shell = document.getElementById('appShell');

      if (gate) {
        gate.classList.toggle('hidden', !!authenticated);
        gate.setAttribute('aria-hidden', authenticated ? 'true' : 'false');
      }
      if (shell) {
        shell.classList.toggle('authenticated', !!authenticated);
        shell.setAttribute('aria-hidden', authenticated ? 'false' : 'true');
      }

      if (!authenticated) closeDrawer();
    }

    function fmtLocalTime(d) {
      try { return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }
      catch { return String(d); }
    }

    function showLoginModal(show, message) {
      const modal = document.getElementById('loginModal');
      const status = document.getElementById('modalStatus');
      if (status) status.textContent = message || '—';
      if (!modal) return;
      modal.classList.toggle('show', !!show);
      modal.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    /* ---------- Adobe Console Authentication ---------- */
    const PROGRAMMERS_API_CANDIDATES = [
      `${CONSOLE_BASE}/rest/api/entity/Programmer?configurationVersion=${CONSOLE_CONFIGURATION_VERSION}`,
      `${CONSOLE_BASE}/rest/api/entity/Programmer`,
      `${CONSOLE_BASE}/rest/api/entity/Programmer?orderby=displayName`,
      `${CONSOLE_BASE}/rest/api/entity/Programmer?limit=500`,
      `${CONSOLE_BASE}/rest/api/entity/Programmer?orderby=displayName&limit=500`,
      `${CONSOLE_BASE}/rest/api/entity/Programmer?configurationVersion=${CONSOLE_CONFIGURATION_VERSION}&orderby=displayName`,
      `${CONSOLE_BASE}/rest/api/entity/Programmer?configurationVersion=${CONSOLE_CONFIGURATION_VERSION}&orderby=displayName&limit=500`
    ];

    function generateRequestId() {
  const timestamp = Date.now();
  const random = Math.floor(Math.random() * 1000000);
  return `${timestamp}-${random}`;
}

async function consoleFetch(url, { expect = 'json' } = {}) {
  const headers = {
    'Accept': 'application/json, text/plain, */*',
    'ap-request-id': generateRequestId()
  };

  let r;
  try {
    r = await fetch(url, {
      method: 'GET',
      mode: 'cors',
      credentials: 'include',
      headers
    });
  } catch (e) {
    const err = new Error(`Console API fetch failed for ${url}: ${e?.message || e}`);
    err.status = 0;
    err.url = url;
    throw err;
  }

  const ct = (r.headers.get('content-type') || '').toLowerCase();
  const bodyText = await r.text().catch(() => '');

  if (!r.ok) {
    const err = new Error(`Console API ${r.status} for ${url}: ${bodyText.slice(0, 180)}`);
    err.status = r.status;
    err.url = url;
    err.body = bodyText;
    err.contentType = ct;
    throw err;
  }

  if (expect === 'text') return bodyText;

  const trimmed = (bodyText || '').trim();
  const looksJson = ct.includes('application/json') || trimmed.startsWith('{') || trimmed.startsWith('[');
  if (!looksJson) {
    const err = new Error(`Console API non-JSON for ${url} (ct=${ct}): ${trimmed.slice(0, 120)}`);
    err.status = r.status;
    err.url = url;
    err.body = bodyText;
    err.contentType = ct;
    throw err;
  }

  try {
    return JSON.parse(bodyText);
  } catch (e) {
    const err = new Error(`Console API JSON parse error for ${url} (ct=${ct}): ${e?.message || e}`);
    err.status = r.status;
    err.url = url;
    err.body = bodyText;
    err.contentType = ct;
    throw err;
  }
}

async function consoleFetchJson(url) {
  return await consoleFetch(url, { expect: 'json' });
}

async function consoleFetchText(url) {
  return await consoleFetch(url, { expect: 'text' });
}

function normalizeProgrammersPayload(data) {
      const entities = Array.isArray(data)
        ? data
        : (Array.isArray(data?.entities) ? data.entities : []);
      const rows = entities
        .map(e => e?.entityData || e)
        .filter(x => x && x.id);

      // Deduplicate by id
      const byId = new Map();
      rows.forEach(p => {
        if (!byId.has(p.id)) byId.set(p.id, p);
      });

      return [...byId.values()].sort((a,b) => {
        const an = (a.displayName || a.name || a.id || '').toLowerCase();
        const bn = (b.displayName || b.name || b.id || '').toLowerCase();
        return an.localeCompare(bn);
      });
    }

    async function verifyAuthWithProgrammersApi() {
  let lastErr = null;
  for (const url of PROGRAMMERS_API_CANDIDATES) {
    try {
      const data = await consoleFetchJson(url);
      const rows = normalizeProgrammersPayload(data);
      if (rows.length) return { ok: true, url, rows };
      lastErr = new Error('Empty programmers payload');
    } catch (e) {
      lastErr = e;
      // Stop early on auth errors to avoid spamming 401s in the console.
      if (e && (e.status === 401 || e.status === 403)) {
        return { ok: false, url: null, rows: [], error: e };
      }
      // Otherwise: try next endpoint candidate.
    }
  }
  return { ok: false, url: null, rows: [], error: lastErr };
}

async function checkAuthentication() {
      setStatus('Checking Adobe session…', 'warn');
      const v = await verifyAuthWithProgrammersApi();
      state.authenticated = !!v.ok;
      state.programmersEndpoint = v.url;
      setAuthenticatedUi(state.authenticated);

      const authBtn = document.getElementById('authBtn');
      if (authBtn) authBtn.textContent = state.authenticated ? '🔄 Refresh Session' : 'LOGIN HERE';
      const authGateBtn = document.getElementById('authGateBtn');
      if (authGateBtn) authGateBtn.textContent = state.authenticated ? 'SESSION ACTIVE' : 'LOGIN HERE';

      const progSel = document.getElementById('programmerSelect');
      if (progSel) progSel.disabled = !state.authenticated;

      const appSel = document.getElementById('appSelect');
      if (appSel) appSel.disabled = true;

      if (!state.authenticated) {
        setStatus(UNAUTH_MESSAGE, 'warn');
        return false;
      }

      setStatus('Authenticated • loading Media Companies…', 'ok');
      // Cache the list we already got during auth verify (best-effort)
      if (v.rows && v.rows.length) {
        state.programmers = v.rows;
        populateProgrammerSelect();
      } else {
        await loadProgrammers();
      }
      return true;
    }

    async function initiateAdobeLogin() {
      showLoginModal(true, 'Opening Adobe Pass TVE dashboard…');

      // Must be triggered by user interaction to avoid popup blockers
      const w = window.open(TVE_DASHBOARD_URL, 'AdobeTVELogin', 'width=1100,height=740');
      if (!w) {
        showLoginModal(true, 'Popup blocked. Allow popups, then click LOGIN HERE again.');
        setStatus('Popup blocked (allow popups)', 'err');
        return;
      }

      showLoginModal(true, 'Complete login in the popup, then return here. This window will re-check automatically.');

      // Poll until popup is closed, then re-check auth
      const started = Date.now();
      const timer = window.setInterval(async () => {
        if (!w || w.closed) {
          window.clearInterval(timer);
          showLoginModal(true, 'Re-checking Adobe session…');
          try {
            const ok = await checkAuthentication();
            if (ok) {
              showLoginModal(false);
              await autoSelectProgrammerAndBoot();
            } else {
              showLoginModal(true, 'Still not authenticated. If you just logged in, wait a moment and click “Re-check session”.');
            }
          } catch (e) {
            showLoginModal(true, 'Auth check error: ' + (e?.message || e));
          }
        } else if (Date.now() - started > 1000 * 60 * 5) {
          // stop polling after 5 minutes; user can manually re-check
          window.clearInterval(timer);
        }
      }, 1000);
    }

    async function loadProgrammers() {
      const v = await verifyAuthWithProgrammersApi();
      if (!v.ok) throw new Error('Not authenticated (cannot load Media Companies).');
      state.programmersEndpoint = v.url;
      state.programmers = v.rows;
      populateProgrammerSelect();
    }

    function populateProgrammerSelect() {
      const sel = document.getElementById('programmerSelect');
      if (!sel) return;

      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '— Select Media Company —';
      sel.appendChild(opt0);

      state.programmers.forEach(p => {
        const o = document.createElement('option');
        o.value = p.id;
        o.textContent = `${p.displayName || p.name || p.id} (${p.id})`;
        sel.appendChild(o);
      });

      // Auto-select last/default if available
      const preferred = getDefaultProgrammerId() || getLastProgrammerId();
      if (preferred) {
        sel.value = preferred;
      }
    }

    async function autoSelectProgrammerAndBoot() {
      const sel = document.getElementById('programmerSelect');
      const pid = sel?.value || '';
      if (pid) {
        await onProgrammerSelected(pid, { auto: true });
        return;
      }
      setStatus('Select a Media Company to start (we’ll remember it)', 'warn');
    }

    /* ---------- Applications + DCR provisioning ---------- */
    function normalizeAppsPayload(data) {
      const entities = Array.isArray(data)
        ? data
        : (Array.isArray(data?.entities) ? data.entities : []);
      return entities
        .map(e => e?.entityData || e)
        .filter(x => x && (x.id || x.guid));
    }

    function getAppGuid(app) { return app.guid || app.id || app.applicationId || ''; }
    function getAppName(app) { return app.name || app.displayName || getAppGuid(app) || 'Application'; }
    function getAppScopes(app) { return app.scopes || app.scope || app.entityData?.scopes || []; }

    const REQUIRED_ESM_SCOPE = 'analytics:client';

function normalizeScopeList(scopes) {
  const list = Array.isArray(scopes)
    ? scopes
    : String(scopes || '').split(/[,\s]+/).filter(Boolean);
  return list.map(s => String(s).trim()).filter(Boolean);
}

function isEsmScopedApp(app) {
  const list = normalizeScopeList(getAppScopes(app));
  return list.some(s => s.toLowerCase() === REQUIRED_ESM_SCOPE);
}

async function loadAppsForProgrammer(programmerId) {
      const url = `${CONSOLE_BASE}/rest/api/applications?programmer=${encodeURIComponent(programmerId)}&configurationVersion=${CONSOLE_CONFIGURATION_VERSION}`;
      const data = await consoleFetchJson(url);
      const apps = normalizeAppsPayload(data)
        .map(a => ({ ...a, guid: getAppGuid(a), name: getAppName(a), scopes: getAppScopes(a), __raw: a }))
        .filter(a => a.guid);

      // prefer ESM-scoped apps first
      apps.sort((a,b) => {
        const ae = isEsmScopedApp(a) ? 0 : 1;
        const be = isEsmScopedApp(b) ? 0 : 1;
        if (ae !== be) return ae - be;
        return (a.name || a.guid).localeCompare(b.name || b.guid);
      });

      state.apps = apps;
      populateAppSelect();
      return apps;
    }

    function populateAppSelect() {
      const sel = document.getElementById('appSelect');
      if (!sel) return;

      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '— ESM App (analytics:client) —';
      sel.appendChild(opt0);

      // Only show ESM-scoped apps by default (less noise)
      const esmApps = state.apps.filter(isEsmScopedApp);
      if (!esmApps.length) {
        opt0.textContent = '— ESM not available (no analytics:client app) —';
        setStatus('ESM not available for this Media Company (no analytics:client scoped app).', 'warn');
      }

      esmApps.forEach(a => {
        const o = document.createElement('option');
        o.value = a.guid;
        o.textContent = `${a.name} (${a.guid})`;
        sel.appendChild(o);
      });

      const pid = state.selectedProgrammerId;
      const last = pid ? (localStorage.getItem(lastAppKeyForProgrammer(pid)) || '') : '';
      const fallback = esmApps[0]?.guid || '';

      sel.disabled = !state.authenticated || !pid || !esmApps.length;
      sel.value = (last && esmApps.some(x => x.guid === last)) ? last : fallback;
    }

    function getStoredClientForProgrammer(pid) {
      if (!pid) return null;
      const raw = localStorage.getItem(clientKeyForProgrammer(pid));
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function setStoredClientForProgrammer(pid, client) {
      if (!pid || !client?.client_id || !client?.client_secret) return;
      localStorage.setItem(clientKeyForProgrammer(pid), JSON.stringify(client));
    }

    function clearStoredClientForProgrammer(pid) {
      if (!pid) return;
      localStorage.removeItem(clientKeyForProgrammer(pid));
    }

    function clearTokenForCurrentClient() {
      const cid = getCid();
      if (!cid) return;
      localStorage.removeItem(tokenKeyForCid(cid));
      state.accessToken = '';
      state.accessTokenExp = 0;
      const input = document.querySelector('input[name=access_token]');
      if (input) input.value = '';
    }

    function setEsmClient(client) {
      state.esmClient = client || null;

      const cidInput = document.querySelector('input[name=cid]');
      const cscInput = document.querySelector('input[name=csc]');
      if (cidInput) cidInput.value = client?.client_id || '';
      if (cscInput) cscInput.value = client?.client_secret || '';

      clearTokenForCurrentClient();
    }

    function isProbablyJwt(s) {
      if (!s) return false;
      const t = String(s).trim();
      if (t.length < 60) return false;
      const parts = t.split('.');
      if (parts.length !== 3) return false;
      // base64url-ish
      return /^[A-Za-z0-9_\-]+\.[A-Za-z0-9_\-]+\.[A-Za-z0-9_\-]+$/.test(t);
    }

    function extractJwtAndUrls(obj) {
      const seen = new Set();
      const jwtCandidates = [];
      const urlCandidates = [];

      const stack = [{ v: obj, path: '' }];
      while (stack.length) {
        const { v, path } = stack.pop();

        if (typeof v === 'string') {
          const s = v.trim();
          if (isProbablyJwt(s)) {
            const p = path.toLowerCase();
            let score = 0;
            if (p.includes('software') && p.includes('statement')) score += 100;
            if (p.includes('software_statement') || p.includes('softwarestatement')) score += 100;
            if (p.includes('jwt')) score += 10;
            if (s.length > 300) score += 5;
            jwtCandidates.push({ score, s, path });
          }
          if (/^https?:\/\//.test(s) && /software/i.test(s) && /statement/i.test(s)) {
            urlCandidates.push({ url: s, path });
          }
          continue;
        }

        if (!v || typeof v !== 'object') continue;
        if (seen.has(v)) continue;
        seen.add(v);

        if (Array.isArray(v)) {
          v.forEach((item, i) => stack.push({ v: item, path: path + '[' + i + ']' }));
        } else {
          Object.entries(v).forEach(([k, val]) => {
            const p = path ? (path + '.' + k) : k;
            stack.push({ v: val, path: p });
          });
        }
      }

      jwtCandidates.sort((a,b) => b.score - a.score);
      return {
        jwt: jwtCandidates[0]?.s || '',
        jwtPath: jwtCandidates[0]?.path || '',
        urls: urlCandidates.map(x => x.url)
      };
    }

    async function fetchSoftwareStatementForApp(appGuid) {
  if (!appGuid) throw new Error('Missing app GUID for software statement.');

  // In practice this endpoint often returns the raw software statement JWT as text/plain.
  const url = `${CONSOLE_BASE}/rest/api/applications/${encodeURIComponent(appGuid)}`;
  const raw = await consoleFetchText(url);
  const trimmed = String(raw || '').trim();

  // Sometimes the console may wrap data in JSON; handle both.
  if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
    try {
      const j = JSON.parse(trimmed);
      const info = extractJwtAndUrls(j);
      if (info.jwt) return info.jwt;
    } catch (e) {
      // fall through to JWT sniffing
    }
  }

  // Most common: raw JWT (or file containing JWT).
  const m = trimmed.match(/[A-Za-z0-9_\-]+\.[A-Za-z0-9_\-]+\.[A-Za-z0-9_\-]+/);
  if (m && isProbablyJwt(m[0])) return m[0];

  throw new Error(`Software statement download did not contain a JWT for app ${appGuid}.`);
}

async function dcrRegisterClient(softwareStatement, appName) {
      const attempts = [];

      // Attempt A: JSON payload (most common)
      attempts.push(async () => {
        const payload = {
          software_statement: softwareStatement,
          grant_types: ['client_credentials'],
          token_endpoint_auth_method: 'client_secret_post',
          client_name: appName || 'HEATER'
        };
        const r = await fetch('https://sp.auth.adobe.com/o/client/register', {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload)
        });
        const text = await r.text();
        let j = null;
        try { j = JSON.parse(text); } catch {}
        if (!r.ok) throw new Error(`DCR JSON register failed (${r.status}): ${text.slice(0,180)}`);
        return j || {};
      });

      // Attempt B: x-www-form-urlencoded (fallback)
      attempts.push(async () => {
        const body = new URLSearchParams();
        body.set('software_statement', softwareStatement);
        const r = await fetch('https://sp.auth.adobe.com/o/client/register', {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type':'application/x-www-form-urlencoded', 'Accept':'application/json' },
          body: body.toString()
        });
        const text = await r.text();
        let j = null;
        try { j = JSON.parse(text); } catch {}
        if (!r.ok) throw new Error(`DCR form register failed (${r.status}): ${text.slice(0,180)}`);
        return j || {};
      });

      let lastErr = '';
      for (const attempt of attempts) {
        try {
          const j = await attempt();
          const cid = j.client_id || j.clientId || j.clientID;
          const csc = j.client_secret || j.clientSecret || j.clientSECRET;
          if (!cid || !csc) {
            throw new Error('DCR response missing client_id/client_secret.');
          }
          return { client_id: cid, client_secret: csc, raw: j };
        } catch (e) {
          lastErr = e?.message || String(e);
        }
      }
      throw new Error(lastErr || 'DCR registration failed.');
    }

    async function ensureEsmClientReady({ allowProvision = true } = {}) {
      const pid = state.selectedProgrammerId;
      if (!pid) throw new Error('No Media Company selected.');

      // If we already have it in memory, done
      if (state.esmClient?.client_id && state.esmClient?.client_secret) return state.esmClient;

      // Try localStorage
      const cached = getStoredClientForProgrammer(pid);
      if (cached?.client_id && cached?.client_secret) {
        setEsmClient(cached);
        setStatus(`ESM client: cached (${cached.appName || 'app'})`, 'ok');
        return cached;
      }

      if (!allowProvision) throw new Error('ESM client not provisioned.');

      // Provision via DCR using selected ESM app
      const appGuid = state.selectedAppGuid || document.getElementById('appSelect')?.value || '';
      if (!appGuid) throw new Error('Select an ESM App (analytics scope) first.');

      setStatus('Provisioning ESM client via DCR…', 'warn');

      const ss = await fetchSoftwareStatementForApp(appGuid);
      const app = state.apps.find(a => a.guid === appGuid);
      const appName = app?.name || appGuid;

      const reg = await dcrRegisterClient(ss, appName);
      const client = {
        client_id: reg.client_id,
        client_secret: reg.client_secret,
        appGuid: appGuid,
        appName: appName,
        createdAt: new Date().toISOString()
      };

      setStoredClientForProgrammer(pid, client);
      setEsmClient(client);
      setStatus('ESM client: provisioned + cached', 'ok');
      return client;
    }

    async function onProgrammerSelected(programmerId, { auto = false } = {}) {
      if (!programmerId) return;

      state.selectedProgrammerId = programmerId;

      const p = state.programmers.find(x => x.id === programmerId);
      state.selectedProgrammerName = p?.displayName || p?.name || programmerId;

      setLastProgrammerId(programmerId);

      // If no default exists yet, set the first successful selection as default (first run requirement)
      if (!getDefaultProgrammerId()) setDefaultProgrammerId(programmerId);

      // Update brand tag quickly while ESM loads
      const mc = document.getElementById('mcTag');
      if (mc) mc.textContent = state.selectedProgrammerName;

      // Clear current in-memory session/token so we don't mismatch
      state.esmClient = null;
      state.accessToken = '';
      state.accessTokenExp = 0;

      const appSel = document.getElementById('appSelect');
      if (appSel) {
        appSel.disabled = true;
        appSel.innerHTML = '<option value="">Loading apps…</option>';
      }

      setStatus('Loading Registered Apps…', 'warn');
      await loadAppsForProgrammer(programmerId);

      // Select app from UI (auto-selected in populateAppSelect)
      state.selectedAppGuid = appSel?.value || '';
      if (!state.selectedAppGuid) {
        setStatus(`ESM not available for ${state.selectedProgrammerName || 'this Media Company'} (no analytics:client scoped app).`, 'warn');
        return;
      }
      const a = state.apps.find(x => x.guid === state.selectedAppGuid);
      state.selectedAppName = a?.name || '';

      if (state.selectedAppGuid) localStorage.setItem(lastAppKeyForProgrammer(programmerId), state.selectedAppGuid);

      try {
        await ensureEsmClientReady({ allowProvision: true });
        await bootAfterEsmReady();
      } catch (e) {
        setStatus('ESM setup needed: ' + (e?.message || e), 'err');
        console.error(e);
      }
    }

    async function onAppSelected(appGuid) {
      state.selectedAppGuid = appGuid || '';
      const pid = state.selectedProgrammerId;
      if (pid && appGuid) localStorage.setItem(lastAppKeyForProgrammer(pid), appGuid);

      const a = state.apps.find(x => x.guid === appGuid);
      state.selectedAppName = a?.name || '';

      // If client already cached for programmer, reuse it (per requirement).
      // To force a new one for this app, use "Reset client".
      try {
        await ensureEsmClientReady({ allowProvision: true });
        await bootAfterEsmReady();
      } catch (e) {
        setStatus('ESM setup needed: ' + (e?.message || e), 'err');
        console.error(e);
      }
    }

    async function bootAfterEsmReady() {
      // Guard: must have cid/csc now
      if (!state.esmClient?.client_id) return;

      setStatus('Loading Requestor IDs…', 'warn');
      await loadRequestorIds();

      // Auto-refresh MVPD selector based on current Requestor selection (if any)
      await refreshMvpdSelector();

      // Start refresh loop (if enabled) and render immediately
      setupAutoRefresh();
      try {
        await refreshAll();
      } catch (e) {
        setStatus('Refresh failed: ' + (e?.message || e), 'err');
        throw e;
      }
    }

    /* ---------- Token Management (ESM client-credentials) ---------- */
    function getCid() {
      return state.esmClient?.client_id || '';
    }
    function getCsc() {
      return state.esmClient?.client_secret || '';
    }

    function loadCachedTokenForCid(cid) {
      if (!cid) return null;
      const raw = localStorage.getItem(tokenKeyForCid(cid));
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function setToken(cid, token, expiresInSec) {
      state.accessToken = token || '';
      const now = Date.now();
      // refresh slightly early (30s)
      state.accessTokenExp = now + Math.max(0, (Number(expiresInSec) || 300) - 30) * 1000;

      localStorage.setItem(tokenKeyForCid(cid), JSON.stringify({
        access_token: token,
        expires_at: state.accessTokenExp
      }));

      const input = document.querySelector('input[name=access_token]');
      if (input) input.value = token || '';
    }

    async function refreshToken() {
      __netStart();
      try {
        const cid = getCid();
        const csc = getCsc();
        if (!cid || !csc) throw new Error('Missing client_id/client_secret for selected Media Company.');

        const r = await fetch(
          'https://sp.auth.adobe.com/o/client/token?grant_type=client_credentials' +
            '&client_id=' + encodeURIComponent(cid) +
            '&client_secret=' + encodeURIComponent(csc),
          { method: 'POST', mode: 'cors' }
        );

        const text = await r.text();
        let j = null;
        try { j = JSON.parse(text); } catch {}
        if (!r.ok) throw new Error(`Token refresh failed (${r.status}): ${text.slice(0,160)}`);

        const token = j?.access_token || '';
        const exp = j?.expires_in || 300;
        if (!token) throw new Error('Token refresh returned no access_token.');
        setToken(cid, token, exp);
        return token;
      } finally {
        __netEnd();
      }
    }

    async function ensureAccessToken(force = false) {
      const cid = getCid();
      if (!cid) throw new Error('ESM client not ready.');
      const now = Date.now();

      if (!force && state.accessToken && now < state.accessTokenExp) return state.accessToken;

      const cached = loadCachedTokenForCid(cid);
      if (!force && cached?.access_token && cached?.expires_at && now < Number(cached.expires_at)) {
        state.accessToken = cached.access_token;
        state.accessTokenExp = Number(cached.expires_at);
        const input = document.querySelector('input[name=access_token]');
        if (input) input.value = state.accessToken;
        return state.accessToken;
      }

      return await refreshToken();
    }

    /* ---------- ESM LIMIT GUARD ---------- */
    const ESM_RESULT_LIMIT = 10000;
    const ESM_CSV_EXPORT_LIMIT = 100000;
    function __isEsmUrl(url) {
      return typeof url === 'string' && url.includes('mgmt.auth.adobe.com/esm/');
    }
    function __appendQueryParam(url, paramKV) {
      const hashIdx = url.indexOf('#');
      const base = hashIdx >= 0 ? url.slice(0, hashIdx) : url;
      const hash = hashIdx >= 0 ? url.slice(hashIdx) : '';
      if (!base.includes('?')) return base + '?' + paramKV + hash;
      if (base.endsWith('?') || base.endsWith('&')) return base + paramKV + hash;
      return base + '&' + paramKV + hash;
    }
    function ensureEsmLimit(url, limit = ESM_RESULT_LIMIT) {
      if (!__isEsmUrl(url)) return url;
      const lim = encodeURIComponent(String(limit));
      if (/[?&]limit=/.test(url)) {
        return url.replace(/([?&]limit=)([^&#]*)/, `$1${lim}`);
      }
      return __appendQueryParam(url, 'limit=' + lim);
    }

    async function fetchWithRefresh(url, opts = {}) {
      __netStart();
      try {
        const parsedLimit = Number(opts?.limit);
        const limit = Number.isFinite(parsedLimit) && parsedLimit > 0 ? Math.floor(parsedLimit) : ESM_RESULT_LIMIT;
        const finalUrl = __isEsmUrl(url) ? ensureEsmLimit(url, limit) : url;
        const tok = await ensureAccessToken(false);

        let r = await fetch(finalUrl, { headers: { Authorization: 'Bearer ' + tok } });
        if (r.status === 401) {
          const tok2 = await ensureAccessToken(true);
          r = await fetch(finalUrl, { headers: { Authorization: 'Bearer ' + tok2 } });
        }
        return r;
      } finally {
        __netEnd();
      }
    }


    /* ---------- Filters (Requestor + MVPD) ---------- */
    function getSelectedFilterValues(sel) {
      if (!sel) return [];
      const vals = [...sel.selectedOptions].map(o => o.value).filter(Boolean);

      // Guard for browsers that may auto-select the first row in compact multi-selects
      // before the user explicitly interacts with the control.
      if (sel.multiple && sel.dataset.filterTouched !== '1') {
        const firstVal = sel.options?.[0]?.value ?? '';
        if (vals.length === 1 && vals[0] === firstVal) return [];
      }
      return vals;
    }

    function setFilterTouched(sel, touched) {
      if (!sel) return;
      sel.dataset.filterTouched = touched ? '1' : '0';
    }

    function enableClickToggleMultiSelect(sel) {
      if (!sel || !sel.multiple || sel.dataset.toggleBound === '1') return;
      sel.dataset.toggleBound = '1';

      // Native multi-select often requires Ctrl/Cmd and can be inconsistent at size=1.
      // We make each click toggle selected state and emit a standard change event.
      // Also suppress native click selection so a deselected option does not get
      // immediately re-selected by the browser default behavior.
      const downEvt = (typeof window !== 'undefined' && window.PointerEvent) ? 'pointerdown' : 'mousedown';
      sel.addEventListener(downEvt, (ev) => {
        const opt = ev.target;
        if (!opt || opt.tagName !== 'OPTION') return;
        if (ev.button !== undefined && ev.button !== 0) return;
        ev.preventDefault();
        ev.stopPropagation();
        opt.selected = !opt.selected;
        setFilterTouched(sel, true);
        sel.dispatchEvent(new Event('change', { bubbles: true }));
      });
      sel.addEventListener('click', (ev) => {
        const opt = ev.target;
        if (!opt || opt.tagName !== 'OPTION') return;
        ev.preventDefault();
        ev.stopPropagation();
      });
    }

    function appendFilterParams(url) {
      const reqSel = document.getElementById('fltr_requestorid');
      const mvpdSel = document.getElementById('fltr_mvpdId');

      // Build canonical filter selections:
      // - unique
      // - non-empty
      // - stable order (first seen)
      const reqIds = [...new Set(getSelectedFilterValues(reqSel).map(v => (v ?? '').toString().trim()).filter(Boolean))];

      const mvpdIds = mvpdSel && !mvpdSel.disabled
        ? [...new Set(getSelectedFilterValues(mvpdSel).map(v => (v ?? '').toString().trim()).filter(Boolean))]
        : [];

      // Always sanitize existing filter params first so stale query state cannot leak.
      // This strictly enforces:
      // - 0 selected requestors => 0 requestor-id params
      // - 1 selected requestor => exactly 1 requestor-id param
      // - N selected requestors => exactly N requestor-id params
      const hashIdx = url.indexOf('#');
      const base = hashIdx >= 0 ? url.slice(0, hashIdx) : url;
      const hash = hashIdx >= 0 ? url.slice(hashIdx) : '';

      try {
        const u = new URL(base);
        const q = u.searchParams;
        q.delete('requestor-id');
        q.delete('mvpd');

        reqIds.forEach(id => q.append('requestor-id', id));
        mvpdIds.forEach(id => q.append('mvpd', id));

        const qs = q.toString();
        return `${u.origin}${u.pathname}${qs ? ('?' + qs) : ''}${hash}`;
      } catch {
        // Defensive fallback for malformed URLs.
        const parts = base.split('?');
        const path = parts[0];
        const rawQ = parts[1] || '';
        const kept = rawQ
          ? rawQ
              .split('&')
              .map(s => s.trim())
              .filter(Boolean)
              .filter(kv => {
                const rawK = (kv.split('=')[0] || '').trim();
                let k = rawK;
                try { k = decodeURIComponent(rawK); } catch {}
                return k !== 'requestor-id' && k !== 'mvpd';
              })
          : [];
        reqIds.forEach(id => kept.push('requestor-id=' + encodeURIComponent(id)));
        mvpdIds.forEach(id => kept.push('mvpd=' + encodeURIComponent(id)));
        return path + (kept.length ? ('?' + kept.join('&')) : '') + hash;
      }
    }

    const __mvpdCacheByRequestor = new Map();
    async function loadMvpdMapForRequestor(rid) {
      if (__mvpdCacheByRequestor.has(rid)) return __mvpdCacheByRequestor.get(rid);

      const mvpdMap = new Map();
      try {
        const r = await fetchWithRefresh(
          'https://sp.auth.adobe.com/api/v1/config/' + encodeURIComponent(rid)
        );
        if (r.ok) {
          const txt = await r.text();
          const xml = new DOMParser().parseFromString(txt, 'application/xml');
          const mvpdNodes = xml.querySelectorAll('mvpds > mvpd');

          mvpdNodes.forEach(m => {
            const idNode = m.querySelector('id');
            if (!idNode) return;

            const nameNode = m.querySelector('displayName');
            const isProxyNode = m.querySelector('isProxy');

            const id = (idNode.textContent || '').trim();
            if (!id) return;

            const nameRaw = (nameNode?.textContent || '').trim();
            const name = nameRaw || id;

            const isProxyTxt = (isProxyNode?.textContent || '').trim().toLowerCase();
            const isProxy = (isProxyTxt === 'false') ? false : true;

            if (!mvpdMap.has(id)) mvpdMap.set(id, { name, isProxy });
          });
        }
      } catch (e) {
        console.warn('MVPD load failed for', rid, e);
      }

      __mvpdCacheByRequestor.set(rid, mvpdMap);
      return mvpdMap;
    }

    function __hideMvpdSelector() {
      const mvpdSel = document.getElementById('fltr_mvpdId');
      if (!mvpdSel) return;
      mvpdSel.disabled = true;
      mvpdSel.style.display = 'none';
      mvpdSel.innerHTML = '';
      setFilterTouched(mvpdSel, false);
    }
    function __showMvpdSelector() {
      const mvpdSel = document.getElementById('fltr_mvpdId');
      if (!mvpdSel) return;
      mvpdSel.disabled = false;
      mvpdSel.style.display = '';
    }

    let __mvpdRefreshSeq = 0;
    async function refreshMvpdSelector() {
      const reqSel = document.getElementById('fltr_requestorid');
      const mvpdSel = document.getElementById('fltr_mvpdId');
      if (!reqSel || !mvpdSel) return;
      const seq = ++__mvpdRefreshSeq;

      const reqIds = getSelectedFilterValues(reqSel);
      if (reqIds.length !== 1) {
        // MVPD selector only makes sense when a single requestor is selected
        __hideMvpdSelector();
        return;
      }

      const rid = reqIds[0];
      const mvpdMap = await loadMvpdMapForRequestor(rid);
      if (seq !== __mvpdRefreshSeq) return;

      // Ignore stale async responses if requestor selection changed mid-flight.
      const stillSelected = getSelectedFilterValues(reqSel);
      if (stillSelected.length !== 1 || stillSelected[0] !== rid) {
        __hideMvpdSelector();
        return;
      }

      if (!mvpdMap || mvpdMap.size === 0) {
        __hideMvpdSelector();
        return;
      }

      __showMvpdSelector();
      const prev = new Set(getSelectedFilterValues(mvpdSel));

      mvpdSel.innerHTML = '';
      [...mvpdMap.entries()]
        .sort((a,b) => (a[1].name || a[0]).localeCompare(b[1].name || b[0]))
        .forEach(([id, meta], idx) => {
          const o = document.createElement('option');
          o.value = id;
          o.textContent = meta.name || id;
          if (prev.has(id)) o.selected = true;

          // Styling hint: proxied MVPDs are slightly dimmer by default
          if (meta.isProxy) o.style.opacity = '0.85';

          mvpdSel.appendChild(o);
        });
    }

    async function loadRequestorIds() {
      const url = 'https://mgmt.auth.adobe.com/esm/v3/media-company/year?requestor-id';
      const r = await fetchWithRefresh(url);
      if (!r.ok) return;

      const j = await r.json();
      if (!j.report || !Array.isArray(j.report)) return;

      const ids = new Set();
      let mediaCompany = null;

      j.report.forEach(row => {
        if (row['requestor-id']) ids.add(row['requestor-id']);
        if (!mediaCompany && row['media-company']) mediaCompany = row['media-company'];
      });

      if (mediaCompany) {
        document.getElementById('mcTag').textContent = mediaCompany;
        document.title = `HEATER — ${mediaCompany}`;
      }

      const sel = document.getElementById('fltr_requestorid');
      if (!sel) return;

      sel.innerHTML = '';
      [...ids].sort().forEach(id => {
        const o = document.createElement('option');
        o.value = id;
        o.textContent = id;
        o.selected = false;
        sel.appendChild(o);
      });

      // Always reset Requestor filter on media-company/app load.
      // Zero selected requestors means media-company scope (all requestor-ids).
      sel.selectedIndex = -1;
      setFilterTouched(sel, false);

      await refreshMvpdSelector();
    }

    /* ---------- Time Window ---------- */
    function iso(d) {
      return d.toISOString().replace(/\.\d{3}Z$/, 'Z');
    }
    function pad2(n) {
      return String(n).padStart(2,'0');
    }
    function hourKeyFromParts(y, m, d, h) {
      return `${y}-${pad2(m)}-${pad2(d)}T${pad2(h)}:00`;
    }
    function hourKeyFromDate(dt) {
      return hourKeyFromParts(dt.getFullYear(), dt.getMonth()+1, dt.getDate(), dt.getHours());
    }
    function dayKeyFromDate(dt) {
      return `${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}`;
    }
    function minuteKeyFromDate(dt) {
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}T${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
    }

    function clampInt(n, min, max, fallback) {
      const v = Number(n);
      if (!Number.isFinite(v)) return fallback;
      return Math.max(min, Math.min(max, Math.round(v)));
    }

    function getLookWindowConfig() {
      const valueInput = document.getElementById('lookbackValue');
      const unitSel = document.getElementById('lookbackUnit');
      const dirSel = document.getElementById('lookDirection');

      const unitRaw = (unitSel?.value || 'hour').toString().toLowerCase();
      const unit = (unitRaw === 'minute' || unitRaw === 'hour' || unitRaw === 'day') ? unitRaw : 'hour';

      const maxByUnit = unit === 'minute' ? 240 : unit === 'hour' ? 240 : 60;
      const defaultByUnit = unit === 'minute' ? 60 : unit === 'hour' ? 12 : 7;
      const value = clampInt(valueInput?.value, 1, maxByUnit, defaultByUnit);
      if (valueInput) valueInput.value = String(value);

      const directionRaw = (dirSel?.value || 'backward').toString().toLowerCase();
      const direction = (directionRaw === 'forward') ? 'forward' : 'backward';

      return { value, unit, direction };
    }

    // Management mandate: bucket is auto-resolved from lookback controls, DAY/HR/MIN only.
    function bucketUnitFromLookback(cfg) {
      if (!cfg) return 'hour';
      if (cfg.unit === 'day') return 'day';
      if (cfg.unit === 'minute') return 'minute';
      return 'hour';
    }

    function floorToBucketStart(dt, bucketSize) {
      const d = new Date(dt);
      if (bucketSize === 'day') {
        d.setHours(0, 0, 0, 0);
        return d;
      }
      if (bucketSize === 'hour') {
        d.setMinutes(0, 0, 0);
        return d;
      }
      d.setSeconds(0, 0);
      return d;
    }

    function addBucketStep(dt, bucketSize, delta) {
      const d = new Date(dt);
      if (bucketSize === 'day') {
        d.setDate(d.getDate() + delta);
        return d;
      }
      if (bucketSize === 'hour') {
        d.setHours(d.getHours() + delta);
        return d;
      }
      d.setMinutes(d.getMinutes() + delta);
      return d;
    }

    function bucketKeyFromDate(dt, bucketSize) {
      if (bucketSize === 'day') return dayKeyFromDate(dt);
      if (bucketSize === 'hour') return hourKeyFromDate(dt);
      return minuteKeyFromDate(dt);
    }

    function bucketLabelFromDate(dt, bucketSize) {
      if (bucketSize === 'day') return `${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}`;
      if (bucketSize === 'hour') return `${pad2(dt.getHours())}`;
      return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
    }

    function computeWindow() {
      const cfg = getLookWindowConfig();
      const bucketSize = bucketUnitFromLookback(cfg);
      const now = new Date();
      const anchor = floorToBucketStart(now, bucketSize);
      const buckets = [];
      if (cfg.direction === 'backward') {
        for (let i = cfg.value - 1; i >= 0; i--) {
          const d = addBucketStep(anchor, bucketSize, -i);
          buckets.push({
            start: d,
            key: bucketKeyFromDate(d, bucketSize),
            label: bucketLabelFromDate(d, bucketSize)
          });
        }
      } else {
        for (let i = 0; i < cfg.value; i++) {
          const d = addBucketStep(anchor, bucketSize, i);
          buckets.push({
            start: d,
            key: bucketKeyFromDate(d, bucketSize),
            label: bucketLabelFromDate(d, bucketSize)
          });
        }
      }

      const firstBucket = buckets[0]?.start ? new Date(buckets[0].start) : new Date(anchor);
      const lastBucket = buckets[buckets.length - 1]?.start ? new Date(buckets[buckets.length - 1].start) : new Date(anchor);
      const start = (cfg.direction === 'forward') ? new Date(now) : firstBucket;
      const end = (cfg.direction === 'forward') ? addBucketStep(lastBucket, bucketSize, 1) : new Date(now);

      return {
        start,
        end,
        buckets,
        startIso: iso(start),
        endIso: iso(end),
        bucketSize,
        lookbackValue: cfg.value,
        lookbackUnit: cfg.unit,
        direction: cfg.direction
      };
    }

    /** Day window for device (by day) ESM: past/future N days, one bucket per day. */
    function computeDayWindow(days = 7, direction = 'backward') {
      const n = Math.max(1, Math.min(31, Number(days) || 7));
      const forward = (direction === 'forward');
      const now = new Date();
      const start = new Date(now);
      start.setHours(0, 0, 0, 0);
      if (!forward) start.setDate(start.getDate() - (n - 1));
      const end = new Date(start);
      end.setDate(start.getDate() + (n - 1));
      end.setHours(23, 59, 59, 999);
      const buckets = [];
      for (let i = 0; i < n; i++) {
        const d = new Date(start);
        d.setDate(d.getDate() + i);
        const key = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
        buckets.push({ start: new Date(d), key, label: key.slice(5) });
      }
      return {
        start,
        end,
        buckets,
        startIso: iso(start),
        endIso: iso(end),
        bucketSize: 'day',
        direction: forward ? 'forward' : 'backward'
      };
    }

    /* ---------- ESM Fetch Helpers + Cache ---------- */
    const CACHE = new Map(); // key -> { ts, report }
    const CACHE_TTL_MS = 20_000;

    function withTimeParams(baseUrl, win) {
      const sep = baseUrl.includes('?') ? '&' : '?';
      const full = `${baseUrl}${sep}start=${encodeURIComponent(win.startIso)}&end=${encodeURIComponent(win.endIso)}&format=json`;
      // Match clickESM behavior: force full ESM queries to include the max server-side row limit.
      return ensureEsmLimit(full);
    }

    async function fetchReport(baseUrl, win) {
      const url = appendFilterParams(withTimeParams(baseUrl, win));
      const cacheKey = url;
      const now = Date.now();

      const cached = CACHE.get(cacheKey);
      if (cached && (now - cached.ts) < CACHE_TTL_MS) return cached.report;

      const r = await fetchWithRefresh(url);
      if (!r.ok) {
        console.warn('Fetch failed', r.status, url);
        return [];
      }
      const j = await r.json();
      const report = (j && Array.isArray(j.report)) ? j.report : [];
      CACHE.set(cacheKey, { ts: now, report });
      return report;
    }

    /* ---------- Indexing + Aggregations ---------- */
    const METRIC_FIELDS = [
      'authn-attempts','authn-successful','authn-failed','authn-pending',
      'authz-attempts','authz-successful','authz-failed','authz-rejected','authz-latency','media-tokens',
      'unique-accounts','unique-sessions',
      'count',
      'decision-attempts','decision-successful','decision-failed','decision-media-tokens'
    ];
    const EXCLUDED_LEGACY_COLUMNS = new Set(['clientless-failures', 'clientless-tokens']);

    function safeNum(x) {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    function initAgg() {
      const o = {};
      METRIC_FIELDS.forEach(f => o[f] = 0);
      // ESM authz-latency is a total across attempts in the bucket.
      // We derive avg latency as: sum(authz-latency) / max(1, sum(authz-attempts)).
      o.__latSum = 0;
      o.__latAttempts = 0;
      return o;
    }

    function addRowToAgg(agg, row) {
      METRIC_FIELDS.forEach(f => {
        if (f === 'authz-latency') return;
        agg[f] += safeNum(row[f]);
      });
      const lat = safeNum(row['authz-latency']);
      const attempts = safeNum(row['authz-attempts']) || 0;
      agg.__latSum += lat;
      agg.__latAttempts += attempts;
    }

    function finalizeAgg(agg) {
      // Compute avg MVPD authz latency per attempt for this aggregate bucket.
      agg['authz-latency'] = agg.__latSum / Math.max(1, agg.__latAttempts);
      return agg;
    }

    function bucketKeyForRow(row, win) {
      const y = safeNum(row.year) || 1970;
      const m = safeNum(row.month) || 1;
      const d = safeNum(row.day) || 1;

      if (win.bucketSize === 'day') {
        return `${y}-${pad2(m)}-${pad2(d)}`;
      }

      const h = safeNum(row.hour) || 0;
      if (win.bucketSize === 'hour') {
        return hourKeyFromParts(y,m,d,h);
      }

      const min = safeNum(row.minute) || 0;
      return `${y}-${pad2(m)}-${pad2(d)}T${pad2(h)}:${pad2(min)}`;
    }

    function indexReport(rows, win, dimKeys=[]) {
      const byBucket = new Map(); // bucketKey -> agg
      const byDim = new Map();    // dimKey -> Map(dimVal -> Map(bucketKey -> agg))

      for (const row of rows) {
        const bk = bucketKeyForRow(row, win);
        if (!byBucket.has(bk)) byBucket.set(bk, initAgg());
        addRowToAgg(byBucket.get(bk), row);

        for (const dk of dimKeys) {
          const dv = (row[dk] ?? '').toString().trim() || '(blank)';
          if (!byDim.has(dk)) byDim.set(dk, new Map());
          const dimMap = byDim.get(dk);
          if (!dimMap.has(dv)) dimMap.set(dv, new Map());
          const bucketMap = dimMap.get(dv);
          if (!bucketMap.has(bk)) bucketMap.set(bk, initAgg());
          addRowToAgg(bucketMap.get(bk), row);
        }
      }

      // finalize latency calculations
      for (const [k, agg] of byBucket) finalizeAgg(agg);
      for (const [dk, dimMap] of byDim) {
        for (const [dv, bucketMap] of dimMap) {
          for (const [bk, agg] of bucketMap) finalizeAgg(agg);
        }
      }

      return { byBucket, byDim };
    }

    /* ---------- Signal Definitions (Stories → Metrics) ---------- */
    const THRESHOLDS = {
      authnSuccess: { green: 0.98, amber: 0.95, better: 'higher' },
      authnPendingRate: { green: 0.01, amber: 0.03, better: 'lower' },
      authnFailRate: { green: 0.01, amber: 0.03, better: 'lower' },

      authzSuccess: { green: 0.98, amber: 0.95, better: 'higher' },
      authzRejectRate: { green: 0.02, amber: 0.05, better: 'lower' },
      authzFailRate: { green: 0.005, amber: 0.01, better: 'lower' },
      authzLatencyMs: { green: 500, amber: 1000, better: 'lower' },

      trafficAnomaly: { green: 1.25, amber: 1.6, better: 'lower' } // ratio beyond threshold is bad
    };

    const ESM_URL_COLS = new Map((ESM_DICTIONARY || []).map(entry => [entry.url, Array.isArray(entry.cols) ? entry.cols : []]));

    const ESM_TREE = {
      overall: {
        day: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day',
        hour: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour',
        minute: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute'
      },
      requestor: {
        day: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id',
        hour: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/requestor-id',
        minute: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/requestor-id'
      },
      mvpd: {
        day: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd',
        hour: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd',
        minute: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd'
      },
      mvpdRequestor: {
        day: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id',
        hour: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id',
        minute: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id'
      },
      dc: {
        day: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/dc',
        day_mvpd: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/dc',
        day_mvpd_requestor: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/proxy/mvpd/requestor-id/dc',
        hour: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/dc',
        hour_mvpd: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/dc',
        hour_mvpd_requestor: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/proxy/mvpd/requestor-id/dc',
        // MIN-level dc tree does not expose a lightweight /minute/dc endpoint.
        // Use the full requestor/mvpd path and aggregate by dc client-side.
        minute: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/proxy/mvpd/requestor-id/dc'
      },
      reason: {
        day: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/event/requestor-id/proxy/mvpd/reason/dc',
        hour: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/event/requestor-id/proxy/mvpd/reason/dc',
        minute: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/hour/minute/event/requestor-id/proxy/mvpd/reason/dc'
      },
      device: {
        day_requestor: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/device/os-family/dc',
        day_mvpd: 'https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day/requestor-id/proxy/mvpd/device/dc'
      }
    };

    function normalizeBucketSize(size) {
      if (size === 'day' || size === 'hour' || size === 'minute') return size;
      return 'hour';
    }

    function getEsmCols(url) {
      return ESM_URL_COLS.get(url) || [];
    }

    function shortEsmPath(url) {
      return (url || '').replace('https://mgmt.auth.adobe.com/esm/v3/media-company/year/month/day', '…/day');
    }

    function fmtEsmSourceLabel(url, maxCols = 8) {
      const cols = getEsmCols(url);
      if (!cols.length) return shortEsmPath(url);
      const shown = cols.slice(0, maxCols).join(', ');
      const more = cols.length > maxCols ? `, +${cols.length - maxCols}` : '';
      return `${shortEsmPath(url)} · cols: ${shown}${more}`;
    }

    function requireTreeUrl(url) {
      if (ESM_URL_COLS.has(url)) return url;
      console.warn('[ESM tree] URL missing from dictionary', url);
      return url;
    }

    function pickCoreDataSourceUrl(kind, win) {
      const bucket = normalizeBucketSize(win?.bucketSize);
      const node = ESM_TREE[kind];
      if (!node) return '';
      return requireTreeUrl(node[bucket]);
    }

    function getActiveFilters() {
      const reqSel = document.getElementById('fltr_requestorid');
      const mvpdSel = document.getElementById('fltr_mvpdId');

      const reqIds = getSelectedFilterValues(reqSel);
      const mvpdIds = (mvpdSel && !mvpdSel.disabled) ? getSelectedFilterValues(mvpdSel) : [];

      return { reqIds, mvpdIds };
    }

    // Some ESM endpoints reject certain filter parameters (400 Bad Request).
    // Route to richer URLs when requestor/mvpd filters are active.
    function pickDcDataSourceUrl(win, filters = null) {
      const bucket = normalizeBucketSize(win?.bucketSize);
      const f = filters || getActiveFilters();
      if (bucket === 'minute') return requireTreeUrl(ESM_TREE.dc.minute);
      if (f.reqIds && f.reqIds.length) return requireTreeUrl(ESM_TREE.dc[`${bucket}_mvpd_requestor`]);
      if (f.mvpdIds && f.mvpdIds.length) return requireTreeUrl(ESM_TREE.dc[`${bucket}_mvpd`]);
      return requireTreeUrl(ESM_TREE.dc[bucket]);
    }

    /** Device (by day) ESM: requestor required; with MVPD filter use proxy/mvpd/device/dc. */
    function pickDeviceDataSourceUrl(filters = null) {
      const f = filters || getActiveFilters();
      if (f.mvpdIds && f.mvpdIds.length) return requireTreeUrl(ESM_TREE.device.day_mvpd);
      return requireTreeUrl(ESM_TREE.device.day_requestor);
    }

    function getDeviceSourceLabel() {
      return fmtEsmSourceLabel(pickDeviceDataSourceUrl());
    }

    /** Reason (event • reason counts): follows active DAY/HR/MIN bucket tree. */
    function pickReasonDataSourceUrl(win) {
      const bucket = normalizeBucketSize(win?.bucketSize);
      return requireTreeUrl(ESM_TREE.reason[bucket]);
    }

    function getReasonSourceLabel(win) {
      return fmtEsmSourceLabel(pickReasonDataSourceUrl(win));
    }

    function getDcSourceLabel(win, filters = null) {
      return fmtEsmSourceLabel(pickDcDataSourceUrl(win, filters));
    }

    function isDcSignal(signal) {
      return (signal?.ds === 'dc' || signal?.ds === 'dc_hour');
    }

    function pickSignalDataSourceUrl(signal, win) {
      if (isDcSignal(signal)) return pickDcDataSourceUrl(win);
      return pickCoreDataSourceUrl('overall', win);
    }

    function pickDimDataSourceUrl(dimKey, win) {
      if (dimKey === 'requestor-id') return pickCoreDataSourceUrl('requestor', win);
      if (dimKey === 'mvpd' || dimKey === 'proxy') return pickCoreDataSourceUrl('mvpd', win);
      if (dimKey === 'dc') return pickDcDataSourceUrl(win);
      return pickCoreDataSourceUrl('overall', win);
    }

    function requiredSignalColumns(signal) {
      if (!signal) return [];
      if (signal.type === 'rate') return [signal.numer, signal.denom].filter(Boolean);
      if (signal.type === 'latency') return [signal.value].filter(Boolean);
      if (signal.type === 'anomaly') return [signal.value].filter(Boolean);
      return [];
    }

    function signalSupportedBySource(signal, sourceUrl) {
      const cols = getEsmCols(sourceUrl);
      if (!cols.length) return true;
      const required = requiredSignalColumns(signal);
      return required.every(col => cols.includes(col));
    }

    const CORE_SIGNALS = [
      {
        id: 'authn_success',
        group: 'AuthN',
        label: 'AuthN success rate',
        story: 'Viewers can sign in',
        type: 'rate',
        numer: 'authn-successful',
        denom: 'authn-attempts',
        ds: 'overall',
        thresholds: THRESHOLDS.authnSuccess,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'authn_pending',
        group: 'AuthN',
        label: 'AuthN pending rate',
        story: 'AuthN backlog / slow upstream responses',
        type: 'rate',
        numer: 'authn-pending',
        denom: 'authn-attempts',
        ds: 'overall',
        thresholds: THRESHOLDS.authnPendingRate,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'authz_success',
        group: 'AuthZ',
        label: 'AuthZ success rate',
        story: 'Viewers can start playback',
        type: 'rate',
        numer: 'authz-successful',
        denom: 'authz-attempts',
        ds: 'overall',
        thresholds: THRESHOLDS.authzSuccess,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'authz_reject',
        group: 'AuthZ',
        label: 'AuthZ reject rate',
        story: 'Entitlements are being denied (expected or outage-driven)',
        type: 'rate',
        numer: 'authz-rejected',
        denom: 'authz-attempts',
        ds: 'overall',
        thresholds: THRESHOLDS.authzRejectRate,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'authz_fail',
        group: 'AuthZ',
        label: 'AuthZ failure rate',
        story: 'AuthZ hard errors (timeouts, 5xx, integration failures)',
        type: 'rate',
        numer: 'authz-failed',
        denom: 'authz-attempts',
        ds: 'overall',
        thresholds: THRESHOLDS.authzFailRate,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'authz_latency',
        group: 'AuthZ',
        label: 'AuthZ latency (avg)',
        story: 'Average MVPD authz latency in seconds (authz-latency ÷ authz-attempts)',
        type: 'latency',
        value: 'authz-latency',
        ds: 'overall',
        thresholds: THRESHOLDS.authzLatencyMs,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'traffic_authz',
        group: 'Traffic',
        label: 'AuthZ attempts (anomaly)',
        story: 'Detect traffic spikes/drops that precede failures',
        type: 'anomaly',
        value: 'authz-attempts',
        ds: 'overall',
        thresholds: THRESHOLDS.trafficAnomaly,
        drill: ['requestor','mvpd','proxy','dc']
      },
      {
        id: 'traffic_sessions',
        group: 'Traffic',
        label: 'Unique sessions (anomaly)',
        story: 'Audience level shift (spike/drop)',
        type: 'anomaly',
        value: 'unique-sessions',
        ds: 'dc',
        thresholds: THRESHOLDS.trafficAnomaly,
        drill: ['requestor','mvpd','proxy','dc']
      }
    ];

    /* ---------- Formatting ---------- */
    function fmtPct(x) {
      if (!Number.isFinite(x)) return '—';
      return (x*100).toFixed(2) + '%';
    }
    function fmtRatio(x) {
      if (!Number.isFinite(x)) return '—';
      return x.toFixed(2) + '×';
    }
    function fmtMs(x) {
      if (!Number.isFinite(x)) return '—';
      return (x / 1000).toFixed(2) + ' s';
    }
    /** Latency in ms as integer (for DC report: avg_mvpd_authz_latency_ms). */
    function fmtMsInt(x) {
      if (!Number.isFinite(x)) return '—';
      return Math.round(x) + ' ms';
    }
    function fmtInt(x) {
      if (!Number.isFinite(x)) return '—';
      return Math.round(x).toLocaleString();
    }

    /* ---------- Status Classification ---------- */
    /** Infer "better" direction when thresholds.better is missing (positive = higher is better). */
    function inferBetter(typeHint, thresholds) {
      if (thresholds && (thresholds.better === 'higher' || thresholds.better === 'lower'))
        return thresholds.better;
      if (typeHint === 'latency' || typeHint === 'anomaly') return 'lower';
      return 'higher';
    }

    /** Normalize value for classification: rate in 0–100 becomes 0–1 so thresholds (0–1) match. */
    function normalizeValueForClassify(value, typeHint) {
      if (!Number.isFinite(value)) return NaN;
      if (typeHint === 'rate' && value > 1.5) return value / 100;
      return value;
    }

    function classify(value, thresholds, typeHint='') {
      const v = normalizeValueForClassify(value, typeHint);
      if (!Number.isFinite(v)) return 'unk';
      if (!thresholds || typeof thresholds !== 'object') return 'unk';

      const g = Number(thresholds.green);
      const a = Number(thresholds.amber);

      // Special: anomaly uses ratio where > threshold means bad (lower ratio is better)
      if (typeHint === 'anomaly') {
        if (Number.isFinite(g) && v <= g) return 'good';
        if (Number.isFinite(a) && v <= a) return 'warn';
        return 'bad';
      }

      const better = inferBetter(typeHint, thresholds);

      if (better === 'higher') {
        if (Number.isFinite(g) && v >= g) return 'good';
        if (Number.isFinite(a) && v >= a) return 'warn';
        return 'bad';
      }

      if (Number.isFinite(g) && v <= g) return 'good';
      if (Number.isFinite(a) && v <= a) return 'warn';
      return 'bad';
    }

    /** Classify using the signal's full context. Use for RCA when we need to re-derive (e.g. no bucket.status). */
    function classifyForSignal(signal, value) {
      if (!signal || !Number.isFinite(value)) return 'unk';
      const thresholds = signal.thresholds || null;
      const typeHint = signal.type || 'rate';
      if (!thresholds || typeof thresholds !== 'object') return (typeHint === 'rate' && normalizeValueForClassify(value, typeHint) >= 0.95 ? 'good' : 'unk');
      return classify(value, thresholds, typeHint);
    }


    /* ---------- MILA-style color ramps (from MILA.html) ---------- */
    function milaGetColor(percentage) {
      // Red → Yellow → Green ramp (0..100)
      const p = Math.max(0, Math.min(100, Number(percentage) || 0));
      const red = p < 50 ? 255 : Math.floor(255 - ((p - 50) * 5.1));
      const green = p > 50 ? 255 : Math.floor(p * 5.1);
      return `rgb(${red}, ${green}, 0)`;
    }

    function milaGetRedColor(percentage) {
      // Yellow → Red ramp (0..100)
      const p = Math.max(0, Math.min(100, Number(percentage) || 0));
      const red = 255;
      const green = Math.floor(255 * (1 - p / 100));
      return `rgb(${red}, ${green}, 0)`;
    }

    function clampPct(v) {
      return Math.max(0, Math.min(100, Number(v) || 0));
    }

    function ragMetricPercent(metric, kind='rate', thresholds=null) {
      if (!Number.isFinite(metric)) return NaN;

      if (kind === 'rate') {
        const pctRaw = (metric <= 1.5) ? (metric * 100) : metric;
        return clampPct(pctRaw);
      }

      if (kind === 'latency') {
        const a = thresholds && Number.isFinite(thresholds.amber) ? Number(thresholds.amber) : NaN;
        const denom = (Number.isFinite(a) && a > 0) ? a : 1000;
        return clampPct((metric / denom) * 100);
      }

      if (kind === 'anomaly') {
        const a = thresholds && Number.isFinite(thresholds.amber) ? Number(thresholds.amber) : NaN;
        if (Number.isFinite(a) && a > 1) {
          return clampPct(((metric - 1) / (a - 1)) * 100);
        }
        return clampPct(metric * 100);
      }

      const pctRaw = (metric <= 1.5) ? (metric * 100) : metric;
      return clampPct(pctRaw);
    }

    function ragNegativeImpactColor(percentage) {
      // Outage context: 0% = light red, 100% = hot red.
      const p = clampPct(percentage);
      const gb = Math.round(230 - (230 * (p / 100)));
      return `rgb(255, ${gb}, ${gb})`;
    }

    function milaRagSquareColor(value, better='higher') {
      // Accept either a ratio (0..1) or a percentage (0..100).
      if (!Number.isFinite(value)) return 'rgb(91, 91, 102)';

      let pct = value;
      if (value <= 1.5) pct = value * 100; // treat as ratio
      pct = Math.max(0, Math.min(100, pct));

      return (better === 'lower') ? milaGetRedColor(pct) : milaGetColor(pct);
    }


    // Unified MILA-style value coloring across the app.
    // The RCA table RAG column uses milaRagSquareColor(value, better) directly.
    // Everything else (heatmap squares, mini-heat, PNG exports) should call
    // milaColorForPoint(signal, value) so color logic stays consistent.
    function milaColorForValue(value, better='higher', kind='rate', thresholds=null) {
      if (!Number.isFinite(value)) return 'rgb(91, 91, 102)';

      // Rate-like metrics (ratios or %).
      if (kind === 'rate') {
        return milaRagSquareColor(value, better);
      }

      // Latency is in ms. Convert to a pseudo-% scale so we can reuse MILA ramps.
      // Heuristic: treat (amber * 2) as “100%” badness so amber ≈ 50% (orange-ish).
      if (kind === 'latency') {
        const a = thresholds && Number.isFinite(thresholds.amber) ? Number(thresholds.amber) : NaN;
        const denom = (Number.isFinite(a) && a > 0) ? (a * 2) : 2000;
        const pct = (value / denom) * 100;
        return (better === 'lower') ? milaGetRedColor(pct) : milaGetColor(pct);
      }

      // Anomaly is a ratio around 1.0. Convert “spike amount” into a pseudo-%.
      // Map (amber) to 100%, and clamp anything <= 1.0 to 0%.
      if (kind === 'anomaly') {
        const a = thresholds && Number.isFinite(thresholds.amber) ? Number(thresholds.amber) : NaN;
        let pct = 0;
        if (Number.isFinite(a) && a > 1) {
          pct = ((value - 1) / (a - 1)) * 100;
        } else {
          pct = value * 100;
        }
        return (better === 'lower') ? milaGetRedColor(pct) : milaGetColor(pct);
      }

      // Fallback: treat as ratio/%.
      return milaRagSquareColor(value, better);
    }

    function milaColorForPoint(signal, value) {
      const better = (signal && signal.thresholds && signal.thresholds.better) ? signal.thresholds.better : 'higher';
      const kind = (signal && signal.type) ? signal.type : 'rate';
      const thresholds = (signal && signal.thresholds) ? signal.thresholds : null;
      return milaColorForValue(value, better, kind, thresholds);
    }


    function statusClass(st) {
      if (st === 'good') return 'st-good';
      if (st === 'warn') return 'st-warn';
      if (st === 'bad') return 'st-bad';
      return 'st-unk';
    }

    function ragColorFromStatus(status) {
      if (status === 'good') return 'rgb(0, 255, 0)';
      if (status === 'warn') return 'rgb(255, 255, 0)';
      if (status === 'bad') return 'rgb(255, 0, 0)';
      return 'rgb(91, 91, 102)';
    }

    function ragPositivePercentText(metric) {
      if (!Number.isFinite(metric)) return '—';
      const pct = ragMetricPercent(metric, 'rate', null);
      if (!Number.isFinite(pct)) return '—';
      return `${Math.round(pct)}%`;
    }

    /* ---------- Signal Computation ---------- */
    function computeSignalSeries(signal, idx, win, opts={}) {
      // idx is { byBucket, byDim }
      const series = win.buckets.map(b => {
        const agg = idx.byBucket.get(b.key);
        if (!agg) return { key: b.key, label: b.label, value: NaN, status: 'unk', extra: null };
        let v = NaN;
        let extra = null;

        if (signal.type === 'rate') {
          const num = safeNum(agg[signal.numer]);
          const den = Math.max(1, safeNum(agg[signal.denom]));
          v = den ? (num / den) : NaN;
          extra = { num, den };
        } else if (signal.type === 'latency') {
          v = safeNum(agg[signal.value]);
          extra = { attempts: safeNum(agg['authz-attempts']) };
        } else if (signal.type === 'anomaly') {
          // ratio vs baseline mean of previous buckets (excluding current bucket)
          const vals = win.buckets.map(bb => {
            const a2 = idx.byBucket.get(bb.key);
            return a2 ? safeNum(a2[signal.value]) : NaN;
          });
          const curIdx = win.buckets.findIndex(bb => bb.key === b.key);
          const baseline = vals.slice(0, curIdx).filter(Number.isFinite);
          const cur = vals[curIdx];
          const mean = baseline.length ? baseline.reduce((s,x)=>s+x,0)/baseline.length : NaN;
          v = (Number.isFinite(mean) && mean > 0) ? (cur / mean) : NaN;
          extra = { cur, mean };
        }

        const st = classify(v, signal.thresholds, signal.type);
        return { key: b.key, label: b.label, value: v, status: st, extra };
      });

      return series;
    }

    function fmtSignalValue(signal, value) {
      if (!signal) return '—';
      if (signal.type === 'latency') return fmtMs(value);
      if (signal.type === 'anomaly') return fmtRatio(value);
      return fmtPct(value);
    }

    function isPositiveRcaSignal(signal) {
      if (!signal || signal.type !== 'rate') return false;
      const better = signal?.thresholds?.better || 'higher';
      return better === 'higher';
    }

    function rcaRankingMode(signal) {
      return isPositiveRcaSignal(signal) ? 'positive' : 'outage';
    }

    function drillVolumeLabel(signal) {
      if (!signal) return 'attempts';
      if (signal.type === 'anomaly') return signal.value || 'current';
      if (signal.type === 'latency') return 'authz-attempts';
      return signal.denom || 'attempts';
    }

    /* ---------- Dynamic “Top offenders” signals ---------- */
    function topOffendersFromDim(dimKey, dimIndexMap, win, signal, bucketKey=null, minAttempts=50, rankingMode='outage', maxRows=6) {
      // Supports rate + anomaly ranking while keeping bucket/window behavior consistent.
      if (!signal) return [];
      const fallbackKey = win.buckets[win.buckets.length - 1]?.key;
      const targetKey = bucketKey || fallbackKey;
      if (!targetKey) return [];

      const orderedKeys = (win.buckets || []).map(b => b.key);
      const offenders = [];
      for (const [dimVal, bucketMap] of dimIndexMap.entries()) {
        const agg = bucketMap.get(targetKey) || (fallbackKey ? bucketMap.get(fallbackKey) : null);
        if (!agg) continue;

        if (signal.type === 'anomaly') {
          const effectiveKey = bucketMap.has(targetKey)
            ? targetKey
            : (fallbackKey && bucketMap.has(fallbackKey) ? fallbackKey : '');
          if (!effectiveKey) continue;

          const curAgg = bucketMap.get(effectiveKey);
          if (!curAgg) continue;

          const cur = safeNum(curAgg[signal.value]);
          if (minAttempts && cur < minAttempts) continue; // ignore tiny samples

          const keyIdx = orderedKeys.indexOf(effectiveKey);
          const baselineVals = [];
          if (keyIdx > 0) {
            for (let i = 0; i < keyIdx; i++) {
              const prevAgg = bucketMap.get(orderedKeys[i]);
              if (!prevAgg) continue;
              const pv = safeNum(prevAgg[signal.value]);
              if (Number.isFinite(pv) && pv > 0) baselineVals.push(pv);
            }
          }

          const mean = baselineVals.length
            ? baselineVals.reduce((s, x) => s + x, 0) / baselineVals.length
            : NaN;
          const v = (Number.isFinite(mean) && mean > 0) ? (cur / mean) : NaN;
          if (!Number.isFinite(v)) continue;

          offenders.push({ dimVal, attempts: cur, value: v, current: cur, mean });
          continue;
        }

        if (signal.type === 'latency') {
          const attempts = safeNum(agg['authz-attempts']);
          if (minAttempts && attempts < minAttempts) continue; // ignore tiny samples

          const v = safeNum(agg[signal.value]);
          if (!Number.isFinite(v)) continue;

          offenders.push({ dimVal, attempts, value: v });
          continue;
        }

        const attempts = safeNum(agg[signal.denom || 'authz-attempts']);
        if (minAttempts && attempts < minAttempts) continue; // ignore tiny samples

        const num = safeNum(agg[signal.numer]);
        const den = Math.max(1, safeNum(agg[signal.denom]));
        const v = den ? (num / den) : NaN;
        if (!Number.isFinite(v)) continue;

        offenders.push({ dimVal, attempts, value: v });
      }

      // Sort by RCA mode:
      // - outage: worst first (triage)
      // - positive: best first (where success is strongest)
      const better = signal?.thresholds?.better || (signal?.type === 'anomaly' ? 'lower' : 'higher');
      if (rankingMode === 'positive') {
        if (better === 'lower') offenders.sort((a,b) => a.value - b.value);
        else offenders.sort((a,b) => b.value - a.value);
      } else {
        if (better === 'lower') offenders.sort((a,b) => b.value - a.value); // high is bad
        else offenders.sort((a,b) => a.value - b.value); // low is bad
      }

      if (Number.isFinite(maxRows) && maxRows > 0) {
        return offenders.slice(0, maxRows);
      }
      return offenders;
    }

    function rcaLevelScore(status, rankingMode='outage') {
      const st = (status || '').toString().toLowerCase();
      if (rankingMode === 'positive') {
        if (st === 'good') return 100;
        if (st === 'warn') return 50;
        if (st === 'bad') return 0;
        return 50;
      }
      if (st === 'good') return 0;
      if (st === 'warn') return 50;
      if (st === 'bad') return 100;
      return 50;
    }

    function metricGoodPercent(value, signal) {
      const kind = signal?.type || 'rate';
      const thresholds = signal?.thresholds || null;
      const better = signal?.thresholds?.better || (signal?.type === 'anomaly' ? 'lower' : 'higher');
      const pct = ragMetricPercent(value, kind, thresholds);
      if (!Number.isFinite(pct)) return NaN;
      return better === 'lower' ? (100 - pct) : pct;
    }

    function metricImpactPercent(value, signal) {
      const goodPct = metricGoodPercent(value, signal);
      if (!Number.isFinite(goodPct)) return NaN;
      return Math.max(0, Math.min(100, 100 - goodPct));
    }

    function topMvpdFromDim(dimIndexMap, win, signal, bucketKey=null, minAttempts=50, rankingMode='outage', maxRows=10) {
      if (!signal) return [];
      const fallbackKey = win.buckets[win.buckets.length - 1]?.key;
      const targetKey = bucketKey || fallbackKey;
      if (!targetKey) return [];

      const orderedKeys = (win.buckets || []).map(b => b.key);
      const offenders = [];

      for (const [dimVal, bucketMap] of dimIndexMap.entries()) {
        const selectedKey = bucketMap.has(targetKey)
          ? targetKey
          : (fallbackKey && bucketMap.has(fallbackKey) ? fallbackKey : '');
        if (!selectedKey) continue;

        const selectedAgg = bucketMap.get(selectedKey);
        if (!selectedAgg) continue;

        // Keep the displayed "value" aligned with selected bucket semantics.
        let selectedAttempts = safeNum(selectedAgg[signal.denom || 'authz-attempts']);
        let selectedValue = NaN;

        if (signal.type === 'anomaly') {
          const cur = safeNum(selectedAgg[signal.value]);
          if (minAttempts && cur < minAttempts) continue;
          selectedAttempts = cur;

          const keyIdx = orderedKeys.indexOf(selectedKey);
          const baselineVals = [];
          if (keyIdx > 0) {
            for (let i = 0; i < keyIdx; i++) {
              const prevAgg = bucketMap.get(orderedKeys[i]);
              if (!prevAgg) continue;
              const pv = safeNum(prevAgg[signal.value]);
              if (Number.isFinite(pv) && pv > 0) baselineVals.push(pv);
            }
          }
          const mean = baselineVals.length
            ? baselineVals.reduce((s, x) => s + x, 0) / baselineVals.length
            : NaN;
          selectedValue = (Number.isFinite(mean) && mean > 0) ? (cur / mean) : NaN;
        } else if (signal.type === 'latency') {
          selectedAttempts = safeNum(selectedAgg['authz-attempts']);
          if (minAttempts && selectedAttempts < minAttempts) continue;
          selectedValue = safeNum(selectedAgg[signal.value]);
        } else {
          if (minAttempts && selectedAttempts < minAttempts) continue;
          const num = safeNum(selectedAgg[signal.numer]);
          const den = Math.max(1, safeNum(selectedAgg[signal.denom]));
          selectedValue = den ? (num / den) : NaN;
        }

        if (!Number.isFinite(selectedValue)) continue;

        // Window-level scoring: combine selected bucket + weighted window average + severity levels.
        const values = [];
        let weightedSum = 0;
        let weightTotal = 0;
        let levelSum = 0;
        let levelCount = 0;

        for (let i = 0; i < orderedKeys.length; i++) {
          const key = orderedKeys[i];
          const agg = bucketMap.get(key);
          if (!agg) continue;

          let v = NaN;
          let w = 1;
          if (signal.type === 'anomaly') {
            const cur = safeNum(agg[signal.value]);
            const baselineVals = [];
            for (let j = 0; j < i; j++) {
              const prevAgg = bucketMap.get(orderedKeys[j]);
              if (!prevAgg) continue;
              const pv = safeNum(prevAgg[signal.value]);
              if (Number.isFinite(pv) && pv > 0) baselineVals.push(pv);
            }
            const mean = baselineVals.length
              ? baselineVals.reduce((s, x) => s + x, 0) / baselineVals.length
              : NaN;
            v = (Number.isFinite(mean) && mean > 0) ? (cur / mean) : NaN;
            w = Math.max(1, cur);
          } else if (signal.type === 'latency') {
            v = safeNum(agg[signal.value]);
            w = Math.max(1, safeNum(agg['authz-attempts']));
          } else {
            const num = safeNum(agg[signal.numer]);
            const den = Math.max(1, safeNum(agg[signal.denom]));
            v = den ? (num / den) : NaN;
            w = Math.max(1, safeNum(agg[signal.denom || 'authz-attempts']));
          }

          if (!Number.isFinite(v)) continue;
          values.push(v);
          weightedSum += (v * w);
          weightTotal += w;

          const st = classify(v, signal.thresholds, signal.type);
          levelSum += rcaLevelScore(st, rankingMode);
          levelCount += 1;
        }

        const avgValue = weightTotal > 0
          ? (weightedSum / weightTotal)
          : (values.length ? (values.reduce((s, x) => s + x, 0) / values.length) : NaN);

        const selectedGood = metricGoodPercent(selectedValue, signal);
        const avgGood = metricGoodPercent(avgValue, signal);
        const selectedImpact = metricImpactPercent(selectedValue, signal);
        const avgImpact = metricImpactPercent(avgValue, signal);
        const levelAvg = levelCount ? (levelSum / levelCount) : 50;

        const score = (rankingMode === 'positive')
          ? ((Number.isFinite(selectedGood) ? selectedGood : 0) * 0.5)
            + ((Number.isFinite(avgGood) ? avgGood : 0) * 0.3)
            + (levelAvg * 0.2)
          : ((Number.isFinite(selectedImpact) ? selectedImpact : 0) * 0.5)
            + ((Number.isFinite(avgImpact) ? avgImpact : 0) * 0.3)
            + (levelAvg * 0.2);

        offenders.push({
          dimVal,
          attempts: selectedAttempts,
          value: selectedValue,
          avgValue,
          levelAvg,
          score
        });
      }

      offenders.sort((a, b) => b.score - a.score);
      if (Number.isFinite(maxRows) && maxRows > 0) {
        return offenders.slice(0, maxRows);
      }
      return offenders;
    }

    function computeDrillWindow() {
      return computeWindow();
    }

    function normalizeDrillBucketKey(win, bucketKey) {
      const fallbackKey = win?.buckets?.[win.buckets.length - 1]?.key || '';
      const raw = bucketKey || fallbackKey;
      if (!raw) return '';
      return (raw ?? '').toString();
    }

    function parseBucketDate(bucketKey) {
      const s = (bucketKey ?? '').toString();
      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        const y = Number(m[1]);
        const mon = Number(m[2]);
        const day = Number(m[3]);
        if ([y, mon, day].every(Number.isFinite)) return new Date(y, mon - 1, day, 0, 0, 0, 0);
      }
      m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):00$/);
      if (m) {
        const y = Number(m[1]);
        const mon = Number(m[2]);
        const day = Number(m[3]);
        const hour = Number(m[4]);
        if ([y, mon, day, hour].every(Number.isFinite)) return new Date(y, mon - 1, day, hour, 0, 0, 0);
      }
      m = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);
      if (m) {
        const y = Number(m[1]);
        const mon = Number(m[2]);
        const day = Number(m[3]);
        const hour = Number(m[4]);
        const minute = Number(m[5]);
        if ([y, mon, day, hour, minute].every(Number.isFinite)) return new Date(y, mon - 1, day, hour, minute, 0, 0);
      }
      return null;
    }

    function describeReasonBucketAge(win, bucketKey) {
      const d = parseBucketDate(bucketKey);
      if (!d || !win?.start || !win?.end) return 'Current Time Window';

      if (win.direction === 'forward') {
        const aheadMin = Math.max(0, Math.round((d.getTime() - win.start.getTime()) / 60_000));
        if (!Number.isFinite(aheadMin)) return 'Current Time Window';
        if (win.bucketSize === 'minute') {
          if (aheadMin <= 1) return 'Current Minute';
          if (aheadMin < 60) return `Next ${aheadMin} Minutes`;
          return `Next ${Math.floor(aheadMin / 60)} Hours`;
        }
        if (win.bucketSize === 'day') {
          const aheadDays = Math.max(0, Math.floor(aheadMin / 1440));
          if (aheadDays <= 0) return 'Today';
          if (aheadDays === 1) return 'Tomorrow';
          return `Next ${aheadDays} Days`;
        }
        if (aheadMin < 60) return 'Current Hour';
        if (aheadMin < 120) return 'Next Hour';
        return `Next ${Math.floor(aheadMin / 60)} Hours`;
      }

      const ageMin = Math.max(0, Math.round((win.end.getTime() - d.getTime()) / 60_000));
      if (!Number.isFinite(ageMin)) return 'Current Time Window';
      if (win.bucketSize === 'minute') {
        if (ageMin <= 1) return 'Current Minute (real-time)';
        if (ageMin < 60) return `Last ${ageMin} Minutes`;
        return `Last ${Math.floor(ageMin / 60)} Hours`;
      }
      if (win.bucketSize === 'day') {
        const ageDays = Math.max(0, Math.floor(ageMin / 1440));
        if (ageDays <= 0) return 'Today';
        if (ageDays === 1) return 'Last Day';
        return `Last ${ageDays} Days`;
      }
      if (ageMin < 60) return 'Less than Last Hour (real-time)';
      if (ageMin < 120) return 'Last Hour';
      return `Last ${Math.floor(ageMin / 60)} Hours`;
    }

    /** Window duration in minutes from actual start/end (so correct for any bucket size). */
    function getWindowDurationMinutes(win) {
      if (!win || !win.start || !win.end) return Math.max(1, (win?.buckets?.length || 12) * 60);
      const ms = win.end.getTime() - win.start.getTime();
      return Math.max(1, Math.round(ms / 60_000));
    }

    /**
     * Build DataCenter report rows: Region (dc), RPM, Latency (ms).
     * Caller must pass dcIdx from the same ESM DC URL as current context (pickDcDataSourceUrl()).
     * ESM: authz-latency is sum(ms) per row; we use avg_mvpd_authz_latency_ms = authz-latency / max(1, authz-attempts)
     * per bucket, then weight by attempts across buckets for overall avg latency.
     */
    function buildDcReportRows(dcIdx, win) {
      if (!dcIdx || !win) return [];
      const dimMap = dcIdx.byDim.get('dc');
      if (!dimMap) return [];
      const durationMinutes = getWindowDurationMinutes(win);
      const rows = [];
      for (const [region, bucketMap] of dimMap.entries()) {
        let totalAttempts = 0;
        let weightedLatSum = 0;
        for (const agg of bucketMap.values()) {
          const attempts = safeNum(agg['authz-attempts']);
          const avgMs = safeNum(agg['authz-latency']);
          totalAttempts += attempts;
          weightedLatSum += avgMs * attempts;
        }
        const avgLatencyMs = totalAttempts > 0 ? weightedLatSum / totalAttempts : NaN;
        const rpm = totalAttempts / durationMinutes;
        rows.push({ region: (region === '(blank)' ? '—' : region), rpm, latencyMs: avgLatencyMs, attempts: totalAttempts });
      }
      rows.sort((a, b) => (b.rpm - a.rpm) || String(a.region).localeCompare(String(b.region)));
      return rows;
    }

    function rowsHaveDim(rows, dimKey) {
      return Array.isArray(rows) && rows.some(r => r && Object.prototype.hasOwnProperty.call(r, dimKey));
    }

    function filterRowsByCtx(rows, ctx) {
      if (!ctx?.dimKey || !ctx?.dimVal) return rows;
      if (!rowsHaveDim(rows, ctx.dimKey)) return rows;
      return rows.filter(r => (r[ctx.dimKey] ?? '').toString() === ctx.dimVal);
    }

    function makeRawExportSpec(signal, win, baseUrl, ctx, suffix = '', extraFilter = null) {
      const url = appendFilterParams(withTimeParams(baseUrl, win));
      const postFilter = (row) => {
        if (ctx?.dimKey && ctx?.dimVal && Object.prototype.hasOwnProperty.call(row, ctx.dimKey)) {
          if ((row[ctx.dimKey] ?? '').toString() !== ctx.dimVal) return false;
        }
        if (typeof extraFilter === 'function' && !extraFilter(row)) return false;
        return true;
      };
      const name = safeFileToken(`raw_esm_${signal?.id || 'signal'}${suffix ? '_' + suffix : ''}`);
      return { url, postFilter, name };
    }

    /** True if reason is None/(none)/blank. Live event monitoring: only show rows where !isReasonNone (reason needs attention). */
    function isReasonNone(row) {
      if (!row || typeof row !== 'object') return true;
      const r = (row.reason ?? '').toString().trim().toLowerCase();
      return r === '' || r === 'none' || r === '(none)';
    }

    function shouldHidePositiveNoneReasonRow(row) {
      return isReasonNone(row) && (() => {
        const eventNorm = (row.event ?? '').toString().trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        return eventNorm.endsWith('r') || eventNorm.endsWith('g') || eventNorm.endsWith('p');
      })();
    }

    function normalizeEventCode(eventVal) {
      return (eventVal ?? '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '');
    }

    function isFailureEventForRca(eventVal) {
      const code = normalizeEventCode(eventVal);
      if (!code) return false;
      // RCA "By Event" should only show denied/failure families.
      return code.endsWith('d') || code.endsWith('f');
    }

    function isPositiveEventForRca(eventVal) {
      const code = normalizeEventCode(eventVal);
      if (!code) return false;
      return code.endsWith('r') || code.endsWith('p') || code.endsWith('g');
    }

    function isEventAllowedForRca(signal, eventVal) {
      if (isPositiveRcaSignal(signal)) return isPositiveEventForRca(eventVal);
      return isFailureEventForRca(eventVal);
    }

    function rcaEventModeLabel(signal) {
      return isPositiveRcaSignal(signal) ? 'r/p/g' : 'd/f';
    }

    function renderDrillFallback(kind, err) {
      const msg = (err && err.message) ? err.message : 'No data available.';
      renderSimpleTable(
        `RCA drill failed: ${kind}`,
        ['message'],
        [[msg]],
        {}
      );
    }

    /* ---------- Rendering ---------- */
    function clear(el) { while (el && el.firstChild) el.removeChild(el.firstChild); }

    function renderDcReportPanel(dcIdx, win, dcSourceLabel) {
      const wrap = document.getElementById('dcReportTableWrap');
      if (!wrap) return;
      clear(wrap);
      const rows = buildDcReportRows(dcIdx, win);
      const sourceNote = (dcSourceLabel && dcSourceLabel.trim()) ? dcSourceLabel.trim() : getDcSourceLabel(win);
      const titleHtml = `<strong>DataCenter report</strong> — Source: <span class="kbd">${sourceNote}</span> · avg latency = authz-latency ÷ authz-attempts (ms) · RPM = requests/min over window`;
      if (!rows.length) {
        const p = document.createElement('p');
        p.className = 'smallnote';
        p.style.padding = '14px 16px';
        p.textContent = 'No DataCenter data for this window.';
        wrap.appendChild(p);
        return;
      }
      const columns = [
        { label: 'Region', isNum: false, cellValue: (r) => r.region, sortValue: (r) => (r.region || '').toString().toLowerCase() },
        { label: 'RPM', isNum: true, cellValue: (r) => fmtInt(r.rpm), sortValue: (r) => r.rpm },
        { label: 'Latency (ms)', isNum: true, cellValue: (r) => fmtMsInt(r.latencyMs), sortValue: (r) => r.latencyMs }
      ];
      const dcRawEsmUrl = appendFilterParams(withTimeParams(pickDcDataSourceUrl(win), win));
      const base = safeFileToken(state.selectedProgrammerName || state.selectedProgrammerId || 'esm');
      const f = getActiveFilters();
      const sourceToken = (f.reqIds && f.reqIds.length) ? 'requestor' : (f.mvpdIds && f.mvpdIds.length) ? 'mvpd' : win.bucketSize;
      createSortableTable(wrap, titleHtml, columns, rows, {
        footerCsv: true,
        footerCsvLabel: 'CSV',
        footerCsvTitle: 'Export raw ESM that powers this table (same request as table)',
        onFooterCsv: (tableState) => {
          const stamp = new Date().toISOString().replace(/[:.]/g, '-');
          downloadEsmCsv({ url: dcRawEsmUrl, name: `dc-report-raw-${base}-${sourceToken}-${stamp}`, state: tableState });
        }
      });
    }

    /**
     * Build Device report rows from raw day-based ESM report.
     * Groups by device (and optionally os-family, dc); aggregates authz attempts/success/latency; computes AuthZ %, Latency (ms), RPM.
     */
    function buildDeviceReportRows(deviceRows, dayWin) {
      if (!Array.isArray(deviceRows) || !dayWin) return [];
      const durationMinutes = getWindowDurationMinutes(dayWin);
      const hasOsFamily = deviceRows.some(r => r && Object.prototype.hasOwnProperty.call(r, 'os-family'));
      const hasDc = deviceRows.some(r => r && Object.prototype.hasOwnProperty.call(r, 'dc'));
      const byKey = new Map();
      for (const row of deviceRows) {
        const device = (row.device ?? '').toString().trim() || '—';
        const osFamily = hasOsFamily ? ((row['os-family'] ?? '').toString().trim() || '—') : '';
        const dc = hasDc ? ((row.dc ?? '').toString().trim() || '—') : '';
        const key = `${device}|${osFamily}|${dc}`;
        if (!byKey.has(key)) {
          byKey.set(key, { device, osFamily, dc, authzAttempts: 0, authzSuccessful: 0, latSum: 0 });
        }
        const agg = byKey.get(key);
        const attempts = safeNum(row['authz-attempts']);
        agg.authzAttempts += attempts;
        agg.authzSuccessful += safeNum(row['authz-successful']);
        agg.latSum += safeNum(row['authz-latency']);
      }
      const rows = [];
      for (const agg of byKey.values()) {
        const attempts = agg.authzAttempts;
        const authzRate = attempts > 0 ? agg.authzSuccessful / attempts : NaN;
        const latencyMs = attempts > 0 ? agg.latSum / Math.max(1, attempts) : NaN;
        const rpm = attempts / durationMinutes;
        rows.push({
          device: agg.device,
          osFamily: agg.osFamily,
          dc: agg.dc,
          authzRate,
          latencyMs,
          rpm,
          attempts
        });
      }
      rows.sort((a, b) => (b.rpm - a.rpm) || String(a.device).localeCompare(String(b.device)));
      return rows;
    }

    function renderDeviceReportPanel(deviceRows, dayWin, deviceSourceLabel) {
      const wrap = document.getElementById('deviceReportTableWrap');
      const reportWrap = document.getElementById('deviceReportWrap');
      if (!wrap || !reportWrap) return;
      clear(wrap);
      const rows = buildDeviceReportRows(deviceRows, dayWin);
      const sourceNote = (deviceSourceLabel && deviceSourceLabel.trim()) ? deviceSourceLabel.trim() : getDeviceSourceLabel();
      const dayDirLabel = dayWin?.direction === 'forward' ? 'next' : 'last';
      const titleHtml = `<strong>Device report</strong> — Source: <span class="kbd">${sourceNote}</span> · By day (${dayDirLabel} ${dayWin.buckets.length} days) · AuthZ % = authz-successful ÷ authz-attempts · Latency (ms) · RPM = requests/min over window`;
      if (!rows.length) {
        const p = document.createElement('p');
        p.className = 'smallnote';
        p.style.padding = '14px 16px';
        p.textContent = 'No Device data. Select a Requestor to see the Device report (by day).';
        wrap.appendChild(p);
        reportWrap.style.display = 'block';
        return;
      }
      const hasOs = rows.some(r => r.osFamily !== undefined && r.osFamily !== '');
      const hasDc = rows.some(r => r.dc !== undefined && r.dc !== '');
      const columns = [
        { label: 'Device', isNum: false, cellValue: (r) => r.device, sortValue: (r) => (r.device || '').toString().toLowerCase() },
        ...(hasOs ? [{ label: 'OS family', isNum: false, cellValue: (r) => r.osFamily || '—', sortValue: (r) => (r.osFamily || '').toString().toLowerCase() }] : []),
        ...(hasDc ? [{ label: 'DC', isNum: false, cellValue: (r) => r.dc || '—', sortValue: (r) => (r.dc || '').toString().toLowerCase() }] : []),
        { label: 'AuthZ %', isNum: true, cellValue: (r) => Number.isFinite(r.authzRate) ? (r.authzRate * 100).toFixed(2) + '%' : '—', sortValue: (r) => r.authzRate },
        { label: 'Latency (ms)', isNum: true, cellValue: (r) => fmtMsInt(r.latencyMs), sortValue: (r) => r.latencyMs },
        { label: 'RPM', isNum: true, cellValue: (r) => fmtInt(r.rpm), sortValue: (r) => r.rpm }
      ];
      const deviceRawEsmUrl = appendFilterParams(withTimeParams(pickDeviceDataSourceUrl(), dayWin));
      const base = safeFileToken(state.selectedProgrammerName || state.selectedProgrammerId || 'esm');
      const f = getActiveFilters();
      const sourceToken = (f.reqIds && f.reqIds.length) ? 'requestor' : (f.mvpdIds && f.mvpdIds.length) ? 'mvpd' : 'day';
      createSortableTable(wrap, titleHtml, columns, rows, {
        footerCsv: true,
        footerCsvLabel: 'CSV',
        footerCsvTitle: 'Export raw ESM that powers this table',
        onFooterCsv: (tableState) => {
          const stamp = new Date().toISOString().replace(/[:.]/g, '-');
          downloadEsmCsv({ url: deviceRawEsmUrl, name: `device-report-raw-${base}-${sourceToken}-${stamp}`, state: tableState });
        }
      });
      reportWrap.style.display = 'block';
    }

    /**
     * Build Reason report rows from raw event/reason ESM report (count per event, reason, dc, mvpd).
     * Only includes reasons that need attention (reason != None). PAR3 click-to-RCA, live event monitoring.
     */
    function buildReasonReportRows(reasonRows) {
      if (!Array.isArray(reasonRows)) return [];
      const attention = reasonRows.filter(row => !isReasonNone(row));
      const hasDc = attention.some(r => r && Object.prototype.hasOwnProperty.call(r, 'dc'));
      const hasMvpd = attention.some(r => r && Object.prototype.hasOwnProperty.call(r, 'mvpd'));
      const byKey = new Map();
      for (const row of attention) {
        const reason = (row.reason ?? '').toString().trim() || '—';
        const event = (row.event ?? '').toString().trim() || '—';
        const dc = hasDc ? ((row.dc ?? '').toString().trim() || '—') : '';
        const mvpd = hasMvpd ? ((row.mvpd ?? '').toString().trim() || '—') : '';
        const key = `${reason}|${event}|${dc}|${mvpd}`;
        if (!byKey.has(key)) byKey.set(key, { reason, event, dc, mvpd, count: 0 });
        byKey.get(key).count += safeNum(row.count);
      }
      const rows = [...byKey.values()];
      rows.sort((a, b) => (b.count - a.count) || String(a.reason).localeCompare(String(b.reason)));
      return rows;
    }

    function pickSignalForReasonRow(row) {
      const code = normalizeEventCode(row?.event);
      if (code.startsWith('d')) return CORE_SIGNALS.find(s => s.id === 'authz_reject') || CORE_SIGNALS[0];
      if (code.startsWith('r') || code.startsWith('g') || code.startsWith('p')) return CORE_SIGNALS.find(s => s.id === 'authz_success') || CORE_SIGNALS[0];
      return CORE_SIGNALS.find(s => s.id === 'authz_fail') || CORE_SIGNALS[0];
    }

    async function openPar3RcaFromReasonRow(row) {
      const signal = pickSignalForReasonRow(row);
      const mvpd = (row?.mvpd ?? '').toString().trim();
      const dc = (row?.dc ?? '').toString().trim();

      if (mvpd && mvpd !== '—') {
        await openScopedRca(signal, 'mvpd', mvpd);
        return;
      }
      if (dc && dc !== '—') {
        await openScopedRca(signal, 'dc', dc);
        return;
      }

      const win = computeWindow();
      const base = pickSignalDataSourceUrl(signal, win);
      const rows = await fetchReport(base, win);
      const idx = indexReport(rows, win, []);
      const series = computeSignalSeries(signal, idx, win);
      openRca(signal, series, { kind: 'core' }, null);
    }

    function renderReasonReportPanel(reasonRows, win, reasonSourceLabel) {
      const wrap = document.getElementById('reasonReportTableWrap');
      const reportWrap = document.getElementById('reasonReportWrap');
      if (!wrap || !reportWrap) return;
      clear(wrap);
      const rows = buildReasonReportRows(reasonRows);
      const sourceNote = (reasonSourceLabel && reasonSourceLabel.trim()) ? reasonSourceLabel.trim() : getReasonSourceLabel(win);
      const bucketLabel = (win && win.bucketSize) ? (win.bucketSize === 'minute' ? 'minute' : win.bucketSize === 'day' ? 'day' : 'hour') : 'hour';
      const titleHtml = `<strong>Reason report</strong> — Source: <span class="kbd">${sourceNote}</span> · Only reasons that need attention (≠ None), ${bucketLabel} window · PAR3 click-to-RCA (row click)`;
      if (!rows.length) {
        const p = document.createElement('p');
        p.className = 'smallnote';
        p.style.padding = '14px 16px';
        p.textContent = 'No reasons that need attention (≠ None) in this window. Try selecting a Requestor or MVPD and refresh.';
        wrap.appendChild(p);
        reportWrap.style.display = 'block';
        return;
      }
      const hasDc = rows.some(r => r.dc !== undefined && r.dc !== '');
      const hasMvpd = rows.some(r => r.mvpd !== undefined && r.mvpd !== '');
      const columns = [
        { label: 'Reason', isNum: false, cellValue: (r) => r.reason, sortValue: (r) => (r.reason || '').toString().toLowerCase() },
        { label: 'Event', isNum: false, cellValue: (r) => r.event, sortValue: (r) => (r.event || '').toString().toLowerCase() },
        ...(hasDc ? [{ label: 'DC', isNum: false, cellValue: (r) => r.dc || '—', sortValue: (r) => (r.dc || '').toString().toLowerCase() }] : []),
        ...(hasMvpd ? [{ label: 'MVPD', isNum: false, cellValue: (r) => r.mvpd || '—', sortValue: (r) => (r.mvpd || '').toString().toLowerCase() }] : []),
        { label: 'Count', isNum: true, cellValue: (r) => fmtInt(r.count), sortValue: (r) => r.count }
      ];
      const reasonRawEsmUrl = appendFilterParams(withTimeParams(pickReasonDataSourceUrl(win), win));
      const base = safeFileToken(state.selectedProgrammerName || state.selectedProgrammerId || 'esm');
      const f = getActiveFilters();
      const sourceToken = (f.reqIds && f.reqIds.length) ? 'requestor' : (f.mvpdIds && f.mvpdIds.length) ? 'mvpd' : 'reason';
      createSortableTable(wrap, titleHtml, columns, rows, {
        footerCsv: true,
        footerCsvLabel: 'CSV',
        footerCsvTitle: 'Export raw ESM that powers this table',
        onRowClick: (row) => {
          openPar3RcaFromReasonRow(row).catch((err) => {
            console.error('[RCA] reason-row open failed', err);
            toast('RCA open failed for selected reason row.');
          });
        },
        onFooterCsv: (tableState) => {
          const stamp = new Date().toISOString().replace(/[:.]/g, '-');
          downloadEsmCsv({ url: reasonRawEsmUrl, name: `reason-report-raw-${base}-${sourceToken}-${stamp}`, state: tableState, postFilter: (row) => !isReasonNone(row) });
        }
      });
      reportWrap.style.display = 'block';
    }

    function renderHeaderRow(container, win) {
      const row = document.createElement('div');
      row.className = 'row header';

      const label = document.createElement('div');
      label.className = 'signal-label';
      label.style.cursor = 'default';
      label.innerHTML = '<div class="name"><strong>Signal</strong><small>click any square → RCA</small></div><div class="value">Now</div>';
      row.appendChild(label);

      win.buckets.forEach((b, i) => {
        const c = document.createElement('div');
        c.className = 'hdr';
        c.textContent = b.label;
        row.appendChild(c);
      });

      container.appendChild(row);
    }

    function renderGroupRow(container, name, win) {
      const row = document.createElement('div');
      row.className = 'row group';
      const label = document.createElement('div');
      label.className = 'signal-label';
      label.style.cursor = 'default';
      label.innerHTML = `<div class="name"><strong>${name}</strong><small>—</small></div>`;
      row.appendChild(label);

      // filler cells to preserve grid columns
      const cols = Math.max(1, win?.buckets?.length || 12);
      for (let i=0; i<cols; i++) {
        const c = document.createElement('div');
        c.className = 'hdr';
        c.textContent = '';
        row.appendChild(c);
      }

      container.appendChild(row);
    }

    function renderSignalRow(container, signal, series, ctx) {
      // ctx: { kind: 'core'|'mvpd'|'requestor'|'dc'|'proxy', dimKey?, dimVal? }
      const row = document.createElement('div');
      row.className = 'row';

      const label = document.createElement('div');
      label.className = 'signal-label';
      label.tabIndex = 0;

      const cur = series[series.length - 1];
      let curTxt = '—';
      if (signal.type === 'rate') curTxt = fmtPct(cur.value);
      else if (signal.type === 'latency') curTxt = fmtMs(cur.value);
      else if (signal.type === 'anomaly') curTxt = fmtRatio(cur.value);

      label.innerHTML = `
        <div class="name">
          <strong>${signal.label}</strong>
          <small>${signal.story}</small>
        </div>
        <div class="value">${curTxt}</div>
      `;

      label.addEventListener('click', () => openRca(signal, series, ctx, null));
      label.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openRca(signal, series, ctx, null);
        }
      });

      row.appendChild(label);

      series.forEach((pt, idx) => {
        const cell = document.createElement('div');
        cell.className = 'cell ' + statusClass(pt.status) + (idx === series.length - 1 ? ' now' : '');
        cell.tabIndex = 0;

        // Use the same MILA-style value coloring as the RCA table RAG squares.
        // This keeps the rest of the app from looking “all red” due to overly strict
        // threshold buckets, while still keeping `pt.status` for tooltips/export.
        cell.style.background = milaColorForPoint(signal, pt.value);

        const tooltip = buildTooltip(signal, pt, ctx);
        cell.title = tooltip;

        cell.addEventListener('click', () => openRca(signal, series, ctx, idx));
        cell.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openRca(signal, series, ctx, idx);
          }
        });

        row.appendChild(cell);
      });

      container.appendChild(row);
    }

    function buildTooltip(signal, pt, ctx) {
      const parts = [];
      parts.push(`${signal.label}`);
      parts.push(`bucket: ${pt.key}`);
      if (ctx?.dimKey && ctx?.dimVal) parts.push(`${ctx.dimKey}: ${ctx.dimVal}`);

      if (signal.type === 'rate') {
        parts.push(`value: ${fmtPct(pt.value)}`);
        if (pt.extra) parts.push(`${signal.numer}=${fmtInt(pt.extra.num)}, ${signal.denom}=${fmtInt(pt.extra.den)}`);
      } else if (signal.type === 'latency') {
        parts.push(`value: ${fmtMs(pt.value)}`);
        if (pt.extra) parts.push(`attempts=${fmtInt(pt.extra.attempts)}`);
      } else if (signal.type === 'anomaly') {
        parts.push(`ratio: ${fmtRatio(pt.value)}`);
        if (pt.extra) parts.push(`cur=${fmtInt(pt.extra.cur)}, mean(prev)=${fmtInt(pt.extra.mean)}`);
      }

      parts.push(`status: ${pt.status.toUpperCase()}`);
      return parts.join('\n');
    }

    /* ---------- RCA Drawer State ---------- */
    const rcaState = {
      open: false,
      signal: null,
      series: null,
      ctx: null,
      bucketIdx: null,
      table: null,
      tableName: null,
      tableCsv: null,      // legacy (kept for backward compatibility)
      tableExport: null    // { kind: 'matrix' | 'esm', ... }
    };

    function openDrawer() {
      const d = document.getElementById('drawer');
      if (!d) return;
      d.classList.add('show');
      d.setAttribute('aria-hidden','false');
      rcaState.open = true;
    }
    function closeDrawer() {
      const d = document.getElementById('drawer');
      if (!d) return;
      d.classList.remove('show');
      d.setAttribute('aria-hidden','true');
      rcaState.open = false;
      clearRcaHashState();
      // clear dict output on close
      document.getElementById('dictResult').innerHTML = '';
    }

    function parseHash() {
      const h = (location.hash || '').replace(/^#/, '');
      const out = {};
      if (!h) return out;
      h.split('&').forEach(kv => {
        const [k,v] = kv.split('=');
        if (!k) return;
        out[decodeURIComponent(k)] = decodeURIComponent(v || '');
      });
      return {
        sig: out.sig || '',
        bucket: out.bucket || '',
        dimk: out.dimk || '',
        dimv: out.dimv || '',
        req: out.req || '',
        mvpd: out.mvpd || ''
      };
    }

    function clearRcaHashState() {
      const raw = (location.hash || '').replace(/^#/, '');
      if (!raw) return;

      const p = new URLSearchParams(raw);
      const before = p.toString();
      ['sig', 'bucket', 'dimk', 'dimv', 'req', 'mvpd'].forEach(k => p.delete(k));
      const after = p.toString();
      if (before === after) return;

      const next = location.pathname + location.search + (after ? ('#' + after) : '');
      history.replaceState(null, '', next);
    }

    function setHashFromRca(signal, bucketKey, ctx) {
      const kv = [];
      kv.push('sig=' + encodeURIComponent(signal?.id || ''));
      kv.push('bucket=' + encodeURIComponent(bucketKey || ''));
      if (ctx?.dimKey) kv.push('dimk=' + encodeURIComponent(ctx.dimKey));
      if (ctx?.dimVal) kv.push('dimv=' + encodeURIComponent(ctx.dimVal));
      location.hash = kv.join('&');
    }

    function resolveRcaBucketIndex(series, requestedIdx = null, requestedKey = '') {
      if (!Array.isArray(series) || !series.length) return -1;

      const hasIdx = Number.isInteger(requestedIdx) && requestedIdx >= 0 && requestedIdx < series.length;
      if (hasIdx) return requestedIdx;
      if (requestedIdx >= 0 && requestedIdx >= series.length) return Math.max(0, series.length - 1);

      if (requestedKey) {
        const exact = series.findIndex(pt => pt?.key === requestedKey);
        if (exact >= 0) return exact;

        const loose = (requestedKey ?? '').toString();
        const looseMatch = series.findIndex(pt => {
          const k = (pt?.key ?? '').toString();
          return k && loose && (k.startsWith(loose) || loose.startsWith(k));
        });
        if (looseMatch >= 0) return looseMatch;
      }

      // Prefer the latest bucket that actually has computed data.
      for (let i = series.length - 1; i >= 0; i--) {
        if (series[i] && series[i].status !== 'unk') return i;
      }

      // Fallback: very latest rendered bucket.
      return series.length - 1;
    }

    function openRca(signal, series, ctx, bucketIdx = null, bucketKey = '') {
      const resolvedIdx = resolveRcaBucketIndex(series, bucketIdx, bucketKey);
      if (resolvedIdx < 0) return;

      rcaState.signal = signal;
      rcaState.series = series;
      rcaState.ctx = ctx;
      rcaState.bucketIdx = resolvedIdx;

      const bucket = series[resolvedIdx];
      setHashFromRca(signal, bucket?.key, ctx);

      renderRca();
      openDrawer();
    }

    function renderRca() {
      const signal = rcaState.signal;
      const series = rcaState.series;
      const ctx = rcaState.ctx;
      const requestedIdx = rcaState.bucketIdx;

      const bucketIdx = resolveRcaBucketIndex(series, requestedIdx);
      if (bucketIdx < 0) return;
      if (bucketIdx !== requestedIdx) rcaState.bucketIdx = bucketIdx;

      const bucket = series?.[bucketIdx];
      if (!signal || !series || !bucket) return;
      const latestBucket = series[series.length - 1] || null;

      const derivedStatus = statusForRcaDetails(signal, bucket);

      document.getElementById('rcaTitle').textContent =
        ctx?.dimKey && ctx?.dimVal
          ? `${signal.label} — ${ctx.dimKey}=${ctx.dimVal}`
          : signal.label;

      document.getElementById('rcaSubtitle').textContent =
        `Story: ${signal.story} • selected: ${bucket.key} (${bucketIdx + 1}/${series.length}) • latest: ${latestBucket?.key || '—'} • status: ${derivedStatus.toUpperCase()}`;

      // KPIs
      const kpiWrap = document.getElementById('rcaKpis');
      clear(kpiWrap);

      const kpis = [
        { k: 'Selected bucket', v: bucket.key },
        { k: 'Latest bucket', v: latestBucket?.key || '—' }
      ];
      if (signal.type === 'rate') {
        kpis.push({ k: 'Value', v: fmtPct(bucket.value) });
        if (bucket.extra) {
          kpis.push({ k: signal.denom, v: fmtInt(bucket.extra.den) });
          kpis.push({ k: signal.numer, v: fmtInt(bucket.extra.num) });
        }
      } else if (signal.type === 'latency') {
        kpis.push({ k: 'Value', v: fmtMs(bucket.value) });
        if (bucket.extra) kpis.push({ k: 'AuthZ attempts', v: fmtInt(bucket.extra.attempts) });
      } else if (signal.type === 'anomaly') {
        kpis.push({ k: 'Ratio', v: fmtRatio(bucket.value) });
        if (bucket.extra) {
          kpis.push({ k: 'Current', v: fmtInt(bucket.extra.cur) });
          kpis.push({ k: 'Mean(prev)', v: fmtInt(bucket.extra.mean) });
        }
      }

      // Context KPIs
      if (ctx?.dimKey && ctx?.dimVal) {
        kpis.push({ k: ctx.dimKey, v: ctx.dimVal });
      }

      kpis.forEach(k => {
        const div = document.createElement('div');
        div.className = 'kpi';
        div.innerHTML = `<div class="k">${k.k}</div><div class="v">${k.v}</div>`;
        kpiWrap.appendChild(div);
      });

      // Mini heat
      const mini = document.getElementById('rcaMiniHeat');
      clear(mini);
      mini.style.setProperty('--mini-cols', String(Math.max(1, series.length)));
      series.forEach((pt, idx) => {
        const isSelected = idx === bucketIdx;
        const isLatest = idx === (series.length - 1);
        const c = document.createElement('div');
        c.className = 'cell ' + statusClass(pt.status) + (isSelected ? ' sel' : '') + (isLatest ? ' latest' : '');
        c.style.background = milaColorForPoint(signal, pt.value);
        c.title = buildTooltip(signal, pt, ctx) + (isSelected ? '\nSELECTED' : '') + (isLatest ? '\nLATEST' : '');
        c.addEventListener('click', () => {
          rcaState.bucketIdx = idx;
          renderRca();
        });
        mini.appendChild(c);
      });

      // Probable RCA Pills
      renderRcaPills(signal, ctx, bucket.key);

      // Narrative detail
      document.getElementById('rcaDetails').innerHTML = buildNarrative(signal, bucket, ctx);

      // Default data table: if core signal, show top offenders automatically
      renderRcaDefaultTable(signal, ctx, bucket.key);
    }

    /**
     * Resolve status for RCA Details so it always matches the displayed value.
     * Derives from bucket.value and signal only (same value we show in Details).
     * Safeguard: for positive rate (higher=good), never show BAD when value >= 0.95.
     */
    function statusForRcaDetails(signal, bucket) {
      const value = bucket.value;
      if (!signal || !Number.isFinite(value)) return (bucket.status === 'good' || bucket.status === 'warn' || bucket.status === 'bad') ? bucket.status : 'unk';

      const typeHint = signal.type || 'rate';
      const thresholds = signal.thresholds || null;
      const better = inferBetter(typeHint, thresholds);
      const v = normalizeValueForClassify(value, typeHint);
      if (!Number.isFinite(v)) return 'unk';
      if (!thresholds || typeof thresholds !== 'object') return (typeHint === 'rate' && better === 'higher' && v >= 0.95 ? 'good' : 'unk');

      let st = classify(v, thresholds, typeHint);
      if (st === 'bad' && typeHint === 'rate' && better === 'higher' && v >= 0.95) st = 'warn';
      return st;
    }

    function buildNarrative(signal, bucket, ctx) {
      if (!signal || !bucket) return '<div class="smallnote">No selection.</div>';

      const value = bucket.value;
      const st = statusForRcaDetails(signal, bucket);
      const statusWord = st === 'good' ? 'GOOD' : (st === 'warn' ? 'WARNING' : (st === 'bad' ? 'BAD' : 'UNKNOWN'));

      const valueLabel = signal.type === 'rate' ? fmtPct(value) : (signal.type === 'latency' ? fmtMs(value) : (signal.type === 'anomaly' ? fmtRatio(value) : (Number.isFinite(value) ? String(value) : '—')));

      const lines = [];
      lines.push(`<div><strong>Status:</strong> ${statusWord} <span class="smallnote">(value: ${valueLabel} for selected bucket)</span></div>`);
      lines.push(`<div><strong>Bucket:</strong> <span class="kbd">${bucket.key || '—'}</span></div>`);

      if (signal.type === 'rate') {
        lines.push(`<div><strong>Definition:</strong> ${signal.numer} ÷ ${signal.denom}</div>`);
      } else if (signal.type === 'latency') {
        lines.push(`<div><strong>Definition:</strong> avg MVPD latency = <span class="kbd">authz-latency</span> ÷ <span class="kbd">max(1, authz-attempts)</span> (server-to-server only, displayed in seconds)</div>`);
      } else if (signal.type === 'anomaly') {
        lines.push(`<div><strong>Definition:</strong> current ÷ mean(previous buckets)</div>`);
      }

      if (!ctx?.dimKey) {
        lines.push(`<div style="margin-top:6px;"><strong>Why this matters:</strong> ${signal.story}.</div>`);
      } else {
        lines.push(`<div style="margin-top:6px;"><strong>Scoped view:</strong> this is already filtered to <span class="kbd">${ctx.dimKey}=${ctx.dimVal}</span>.</div>`);
      }

      return lines.join('');
    }

    function renderRcaPills(signal, ctx, bucketKey) {
      const pills = document.getElementById('rcaPills');
      clear(pills);
      const positiveMode = isPositiveRcaSignal(signal);

      const drill = signal.drill || [];
      const add = (id, label, hint) => {
        const p = document.createElement('div');
        p.className = 'pill';
        p.title = hint || '';
        p.innerHTML = `<strong>${label}</strong> <small>${hint || ''}</small>`;
        p.addEventListener('click', () => handleDrill(id, signal, ctx, bucketKey));
        pills.appendChild(p);
      };

      if (drill.includes('requestor')) add('requestor', 'By Requestor', positiveMode ? 'who has the highest success? (with top event+reason)' : 'who is impacted? (with top event+reason)');
      if (drill.includes('mvpd')) add('mvpd', 'By MVPD', positiveMode ? 'which MVPD has the highest success? (with top event+reason)' : 'which MVPD is failing? (with top event+reason)');
      if (drill.includes('proxy')) add('proxy', 'By Proxy', positiveMode ? 'where success is strongest (direct/proxy + top event+reason)' : 'direct vs proxied failures (with top event+reason)');
      if (drill.includes('dc')) add('dc', 'By DC', positiveMode ? 'where success is strongest by data center (with top event+reason)' : 'data center hot spot (with top event+reason)');

      // Context-sensitive extra pills
      if (!ctx?.dimKey) {
        add('raw', 'Raw ESM rows', 'open the underlying aggregated rows');
      } else {
        add('pivot', 'Pivot deeper', 'drill one level down');
        add('raw', 'Raw ESM rows', 'open the underlying rows for this slice');
      }
    }

    async function handleDrill(kind, signal, ctx, bucketKey) {
      try {
        if (kind === 'raw') {
          await renderRawRows(signal, ctx);
          return;
        }

        if (kind === 'pivot') {
          // Choose a next logical dimension based on current ctx
          if (ctx?.dimKey === 'mvpd') return await drillWithinMvpd(signal, ctx, bucketKey);
          if (ctx?.dimKey === 'requestor-id') return await drillWithinRequestor(signal, ctx, bucketKey);
          if (ctx?.dimKey === 'dc') return await drillWithinDc(signal, ctx, bucketKey);
          return await renderRcaDefaultTable(signal, ctx, bucketKey);
        }

        if (kind === 'requestor') return await drillByRequestor(signal, ctx, bucketKey);
        if (kind === 'mvpd') return await drillByMvpd(signal, ctx, bucketKey);
        if (kind === 'proxy') return await drillByProxy(signal, ctx, bucketKey);
        if (kind === 'dc') return await drillByDc(signal, ctx, bucketKey);
        return await renderRcaDefaultTable(signal, ctx, bucketKey);
      } catch (err) {
        console.error('[RCA drill] failed', kind, err);
        renderDrillFallback(kind, err);
      }
    }

    /* ---------- Drilldown implementations ---------- */
    function mkRateSignalFromCore(signal) {
      if (signal.type === 'rate') return signal;
      if (signal.type === 'anomaly') return signal;
      if (signal.type === 'latency') return signal;
      // For any unknown type, pick a companion success rate in the same protocol family.
      if (signal.companionSignalId) {
        const explicit = CORE_SIGNALS.find(s => s.id === signal.companionSignalId);
        if (explicit) return explicit;
      }
      const family = ((signal.value || signal.numer || signal.denom || '') + '').toLowerCase();
      if (family.includes('authz')) return CORE_SIGNALS.find(s => s.id === 'authz_success');
      if (family.includes('authn')) return CORE_SIGNALS.find(s => s.id === 'authn_success');
      if (signal.group === 'AuthZ') return CORE_SIGNALS.find(s => s.id === 'authz_success');
      return CORE_SIGNALS.find(s => s.id === 'authn_success');
    }

    async function loadReasonSummaryByDim(dimKey, signal, ctx, win, bucketKey) {
      const none = { byDim: new Map(), note: 'reasons that need attention (≠ None): no data in current window' };

      const fallbackKey = win?.buckets?.[win.buckets.length - 1]?.key || '';
      const requestedKey = normalizeDrillBucketKey(win, bucketKey || fallbackKey);
      if (!requestedKey) return none;

      const reasonUrl = pickReasonDataSourceUrl(win);

      let reasonRows = [];
      try {
        reasonRows = await fetchReport(reasonUrl, win);
      } catch (e) {
        console.warn('[RCA] reason summary fetch failed', e);
        return none;
      }

      const scopedRows = filterRowsByCtx(reasonRows, ctx).filter(row => !isReasonNone(row));
      if (!scopedRows.length) return none;

      const bucketRows = new Map();
      for (const row of scopedRows) {
        const bk = bucketKeyForRow(row, win);
        if (!bk) continue;
        bucketRows.set(bk, (bucketRows.get(bk) || 0) + 1);
      }

      const orderedWindowKeys = (win.buckets || []).map(b => b.key);
      const latestBucketWithData = [...orderedWindowKeys].reverse().find(k => (bucketRows.get(k) || 0) > 0) || '';
      if (!latestBucketWithData) return none;

      const selectedHasData = (bucketRows.get(requestedKey) || 0) > 0;
      const effectiveKey = selectedHasData ? requestedKey : latestBucketWithData;

      // Build top event+reason per selected dimension value inside the effective bucket.
      const perDim = new Map();
      for (const row of scopedRows) {
        const bk = bucketKeyForRow(row, win);
        if (bk !== effectiveKey) continue;

        const dimVal = (row?.[dimKey] ?? '').toString().trim() || '(blank)';
        const reason = (row.reason ?? '').toString().trim() || '(blank)';
        const ev = (row.event ?? '').toString().trim() || '(event?)';
        const reasonKey = `${ev} • ${reason}`;
        const c = safeNum(row.count);

        if (!perDim.has(dimVal)) perDim.set(dimVal, new Map());
        const reasonMap = perDim.get(dimVal);
        reasonMap.set(reasonKey, (reasonMap.get(reasonKey) || 0) + c);
      }

      const byDim = new Map();
      for (const [dimVal, reasonMap] of perDim.entries()) {
        const arr = [...reasonMap.entries()].map(([label, count]) => ({ label, count }));
        arr.sort((a, b) => b.count - a.count);
        if (!arr.length) continue;
        byDim.set(dimVal, arr[0]);
      }

      const selectedLabel = `${requestedKey} (${describeReasonBucketAge(win, requestedKey)})`;
      const shownLabel = `${effectiveKey} (${describeReasonBucketAge(win, effectiveKey)})`;
      const note = selectedHasData
        ? `reasons from ${shownLabel}`
        : `selected ${selectedLabel} had no reason rows; showing ${shownLabel}`;

      return { byDim, note };
    }

    async function drillByRequestor(signal, ctx, bucketKey) {
      const win = computeDrillWindow();
      const base = pickCoreDataSourceUrl('requestor', win);
      const rows = await fetchReport(base, win);
      const scopedRows = filterRowsByCtx(rows, ctx);
      const idx = indexReport(scopedRows, win, ['requestor-id']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('requestor-id') || new Map();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);
      const offenders = topOffendersFromDim('requestor-id', dimMap, win, rateSig, targetKey, 0, rankingMode, 0);
      const reasonInfo = await loadReasonSummaryByDim('requestor-id', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'requestor');
      renderDimTable('requestor-id', offenders, rateSig, signal, ctx, win, '', targetKey, { reasonInfo, rawExport });
    }

    async function drillByMvpd(signal, ctx, bucketKey) {
      const win = computeDrillWindow();
      const base = pickCoreDataSourceUrl('mvpd', win);
      const rows = await fetchReport(base, win);
      const scopedRows = filterRowsByCtx(rows, ctx);
      const idx = indexReport(scopedRows, win, ['mvpd']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('mvpd') || new Map();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);
      const offenders = topMvpdFromDim(dimMap, win, rateSig, targetKey, 50, rankingMode, 10);
      const reasonInfo = await loadReasonSummaryByDim('mvpd', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'mvpd');
      renderDimTable('mvpd', offenders, rateSig, signal, ctx, win, '', targetKey, { reasonInfo, rawExport });
    }

    async function drillByProxy(signal, ctx, bucketKey) {
      const win = computeDrillWindow();
      const base = pickCoreDataSourceUrl('mvpd', win);
      const rows = await fetchReport(base, win);
      const scopedRows = filterRowsByCtx(rows, ctx);
      const idx = indexReport(scopedRows, win, ['proxy']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('proxy') || new Map();

      const fallbackKey = win.buckets[win.buckets.length - 1]?.key;
      const targetKey = normalizeDrillBucketKey(win, bucketKey || fallbackKey);
      // Proxy is usually small (direct/proxy), keep tiny samples for parity with legacy behavior.
      const offenders = topOffendersFromDim('proxy', dimMap, win, rateSig, targetKey, 0, rankingMode);
      const reasonInfo = await loadReasonSummaryByDim('proxy', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'proxy');
      renderDimTable('proxy', offenders, rateSig, signal, ctx, win, '', targetKey, { reasonInfo, rawExport });
    }

    async function drillByDc(signal, ctx, bucketKey) {
      const win = computeDrillWindow();
      const base = pickDcDataSourceUrl(win);
      const rows = await fetchReport(base, win);
      const scopedRows = filterRowsByCtx(rows, ctx);
      const idx = indexReport(scopedRows, win, ['dc']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('dc') || new Map();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);
      const offenders = topOffendersFromDim('dc', dimMap, win, rateSig, targetKey, 50, rankingMode);
      const reasonInfo = await loadReasonSummaryByDim('dc', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'dc');
      renderDimTable('dc', offenders, rateSig, signal, ctx, win, '', targetKey, { reasonInfo, rawExport });
    }

    async function drillWithinMvpd(signal, ctx, bucketKey) {
      // Break down selected MVPD by requestor-id
      const win = computeDrillWindow();
      const base = pickCoreDataSourceUrl('mvpdRequestor', win);
      const rows = await fetchReport(base, win);
      const mvpd = ctx.dimVal;

      const filtered = rows.filter(r => (r.mvpd ?? '').toString() === mvpd);
      const idx = indexReport(filtered, win, ['requestor-id']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('requestor-id') || new Map();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);
      const offenders = topOffendersFromDim('requestor-id', dimMap, win, rateSig, targetKey, 0, rankingMode, 0);
      const reasonInfo = await loadReasonSummaryByDim('requestor-id', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'within_mvpd', (row) => (row.mvpd ?? '').toString() === mvpd);
      renderDimTable('requestor-id', offenders, rateSig, signal, ctx, win, `Within MVPD=${mvpd}`, targetKey, { reasonInfo, rawExport });
    }

    async function drillWithinRequestor(signal, ctx, bucketKey) {
      // Break down selected requestor-id by mvpd
      const win = computeDrillWindow();
      const base = pickCoreDataSourceUrl('mvpdRequestor', win);
      const rows = await fetchReport(base, win);
      const rid = ctx.dimVal;

      const filtered = rows.filter(r => (r['requestor-id'] ?? '').toString() === rid);
      const idx = indexReport(filtered, win, ['mvpd']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('mvpd') || new Map();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);
      const offenders = topMvpdFromDim(dimMap, win, rateSig, targetKey, 50, rankingMode, 10);
      const reasonInfo = await loadReasonSummaryByDim('mvpd', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'within_requestor', (row) => (row['requestor-id'] ?? '').toString() === rid);
      renderDimTable('mvpd', offenders, rateSig, signal, ctx, win, `Within Requestor=${rid}`, targetKey, { reasonInfo, rawExport });
    }

    async function drillWithinDc(signal, ctx, bucketKey) {
      // Break down selected DC by MVPD
      const win = computeDrillWindow();
      const base = pickDcDataSourceUrl(win);
      const rows = await fetchReport(base, win);
      const dc = ctx.dimVal;

      const filtered = rows.filter(r => (r.dc ?? '').toString() === dc);
      const idx = indexReport(filtered, win, ['mvpd']);

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const dimMap = idx.byDim.get('mvpd') || new Map();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);
      const offenders = topMvpdFromDim(dimMap, win, rateSig, targetKey, 50, rankingMode, 10);

      const reasonInfo = await loadReasonSummaryByDim('mvpd', signal, ctx, win, targetKey);
      const rawExport = makeRawExportSpec(signal, win, base, ctx, 'within_dc', (row) => (row.dc ?? '').toString() === dc);
      renderDimTable('mvpd', offenders, rateSig, signal, ctx, win, `Within DC=${dc}`, targetKey, { reasonInfo, rawExport });
    }

    function renderDimTable(dimKey, offenders, rateSig, signal, ctx, win, subtitleExtra='', bucketKey=null, opts={}) {
      const positiveMode = isPositiveRcaSignal(signal);
      const reasonInfo = opts?.reasonInfo || { byDim: new Map(), note: '' };
      const reasonByDim = reasonInfo.byDim || new Map();
      const reasonNote = reasonInfo.note || '';
      const title = positiveMode
        ? `Top success by ${dimKey} (ranked by ${rateSig.label})`
        : `Top offenders by ${dimKey} (ranked by ${rateSig.label})`;

      const rows = offenders.map(o => {
        const st = classifyForSignal(rateSig, o.value);
        const rag = positiveMode ? ragPositivePercentText(o.value) : st.toUpperCase();
        const reason = reasonByDim.get((o.dimVal ?? '').toString()) || null;
        const reasonLabel = reason?.label || '—';
        const reasonCount = Number.isFinite(reason?.count) ? fmtInt(reason.count) : '—';

        // Build the display row as an Array, but attach the raw metric so the RAG
        // column can color using MILA-style ramps. Use signal context so positive/negative is correct.
        const arr = [
          o.dimVal,
          fmtSignalValue(rateSig, o.value),
          fmtInt(o.attempts),
          reasonLabel,
          reasonCount,
          rag
        ];
        arr.__ragValue = o.value;
        arr.__ragStatus = st;
        arr.__ragKind = rateSig?.type || 'rate';
        arr.__ragThresholds = rateSig?.thresholds || null;
        arr.__ragBetter = inferBetter(rateSig?.type, rateSig?.thresholds);
        arr.__ragMode = positiveMode ? 'positive' : 'outage';
        return arr;
      });

      renderSimpleTable(
        title + (subtitleExtra ? ' — ' + subtitleExtra : '') + (reasonNote ? ' — ' + reasonNote : ''),
        [dimKey, rateSig.label, drillVolumeLabel(rateSig), 'Top event • reason', 'Reason count', 'RAG'],
        rows,
        {
          rawExport: opts?.rawExport || null,
          onRowClick: (rowArr) => {
            const dimVal = rowArr?.[0];
            if (!dimVal) return;
            // Open a scoped RCA view for that dimension (same signal, same series but recomputed for the slice)
            openScopedRca(signal, dimKey, dimVal, bucketKey).catch((err) => {
              console.error('[RCA] openScopedRca failed', err);
              renderDrillFallback(`open ${dimKey}`, err);
            });
          }
        }
      );
    }

    function __stripTags(s) {
      return (s ?? '').toString().replace(/<[^>]*>/g, '').trim();
    }

    function __toNumberLoose(v) {
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number' && Number.isFinite(v)) return v;
      let s = ('' + v).trim();
      if (!s) return NaN;
      if (s === '—' || s.toLowerCase() === 'na' || s.toLowerCase() === 'n/a') return NaN;

      // common numeric decorations
      s = s.replace(/,/g, '');
      s = s.replace(/%$/g, '');
      s = s.replace(/[x×]$/i, '');
      // duration units used in UI: "123 ms", "1.23 s", "2 sec"
      const dur = s.match(/^(-?\d+(?:\.\d+)?)\s*(ms|msec|msecs|s|sec|secs|second|seconds)$/i);
      if (dur) s = dur[1];

      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function __normSort(v) {
      if (v === null || v === undefined) return { kind: 'null', value: null };

      // Prefer numeric sorting when possible
      const n = __toNumberLoose(v);
      if (Number.isFinite(n)) return { kind: 'num', value: n };

      const s = ('' + v).trim();
      if (!s || s === '—') return { kind: 'null', value: null };
      return { kind: 'text', value: s.toLowerCase() };
    }

    function __cmpSort(a, b) {
      const va = __normSort(a);
      const vb = __normSort(b);

      if (va.kind === 'null' && vb.kind === 'null') return 0;
      if (va.kind === 'null') return 1;      // nulls last
      if (vb.kind === 'null') return -1;

      if (va.kind === 'num' && vb.kind === 'num') {
        if (va.value < vb.value) return -1;
        if (va.value > vb.value) return 1;
        return 0;
      }

      const sa = va.kind === 'text' ? va.value : ('' + a).toLowerCase();
      const sb = vb.kind === 'text' ? vb.value : ('' + b).toLowerCase();
      if (sa < sb) return -1;
      if (sa > sb) return 1;
      return 0;
    }

    function __sortByStack(rows, sortStack, columns) {
      if (!sortStack || !sortStack.length) return rows.slice();

      const decorated = rows.map((row, idx) => ({ row, idx }));
      decorated.sort((a, b) => {
        for (const spec of sortStack) {
          const col = columns[spec.col];
          if (!col) continue;

          const va = col.sortValue ? col.sortValue(a.row) : col.cellValue(a.row);
          const vb = col.sortValue ? col.sortValue(b.row) : col.cellValue(b.row);
          const c = __cmpSort(va, vb);
          if (c !== 0) {
            const mul = spec.dir === 'ASC' ? 1 : -1;
            return c * mul;
          }
        }
        // stable tie-breaker
        return a.idx - b.idx;
      });
      return decorated.map(o => o.row);
    }

    function handleRcaCsvExport() {
      const exp = rcaState.tableExport;
      if (!exp) {
        toast('No table to export.');
        return;
      }

      if (exp.kind === 'esm') {
        downloadEsmCsv(exp);
        return;
      }

      if (exp.kind === 'matrix') {
        const rows = exp.state?.viewRows || [];
        downloadCsv(exp.name || rcaState.tableName || 'esm', exp.headers || [], rows);
        return;
      }

      toast('Unknown export type.');
    }

    function createSortableTable(hostEl, titleHtml, columns, baseRows, opts={}) {
      clear(hostEl);

      if (titleHtml) {
        const tdiv = document.createElement('div');
        tdiv.className = 'smallnote';
        tdiv.innerHTML = titleHtml;
        hostEl.appendChild(tdiv);
      }

      const wrapper = document.createElement('div');
      wrapper.className = 'esm-table-wrapper';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      const state = {
        hostEl,
        wrapper,
        table,
        thead,
        tbody: null,
        columns,
        baseRows: baseRows || [],
        viewRows: [],
        sortStack: (opts.sortStack && opts.sortStack.length) ? opts.sortStack.slice() : []
      };

      // Build header
      state._ths = [];
      columns.forEach((col, idx) => {
        const th = document.createElement('th');
        th.className = 'sortable';
        th.textContent = col.label;

        if (col.isNum) th.classList.add('num');

        const isRagCol = (col.role === 'rag') || ((col.label || '').toString().trim().toLowerCase() === 'rag');
        if (isRagCol) th.classList.add('rag');

        const icon = document.createElement('span');
        icon.className = 'sort-icon';
        icon.textContent = '';
        th.appendChild(icon);

        th.addEventListener('click', (ev) => {
          const shift = !!ev.shiftKey;

          const existingIdx = state.sortStack.findIndex(s => s.col === idx);
          const existing = existingIdx >= 0 ? state.sortStack[existingIdx] : null;

          if (shift) {
            if (existing) {
              existing.dir = (existing.dir === 'ASC') ? 'DESC' : 'ASC';
            } else {
              state.sortStack.push({ col: idx, dir: 'DESC' });
            }
          } else {
            if (state.sortStack.length && state.sortStack[0].col === idx) {
              // toggle primary direction
              state.sortStack[0].dir = (state.sortStack[0].dir === 'ASC') ? 'DESC' : 'ASC';
            } else {
              state.sortStack = [{ col: idx, dir: 'DESC' }];
            }
          }

          state.viewRows = __sortByStack(state.baseRows, state.sortStack, state.columns);
          __renderBody(state, opts);
          __refreshHeaderStates(state);
        });

        trh.appendChild(th);
        state._ths.push(th);
      });

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      table.appendChild(tbody);
      state.tbody = tbody;

      wrapper.appendChild(table);
      if (opts.footerCsv !== false) {
        const footer = document.createElement('div');
        footer.className = 'esm-table-footer';

        const csvBtn = document.createElement('button');
        csvBtn.type = 'button';
        csvBtn.className = 'csv-footer-btn';
        csvBtn.textContent = opts.footerCsvLabel || 'CSV';
        csvBtn.title = opts.footerCsvTitle || 'Download CSV for this table';
        csvBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          ev.stopPropagation();
          if (typeof opts.onFooterCsv === 'function') {
            opts.onFooterCsv(state);
            return;
          }
          handleRcaCsvExport();
        });

        footer.appendChild(csvBtn);
        wrapper.appendChild(footer);
        state.footer = footer;
        state.footerCsvBtn = csvBtn;
      }
      hostEl.appendChild(wrapper);

      // Initial render
      state.viewRows = state.sortStack.length ? __sortByStack(state.baseRows, state.sortStack, state.columns) : state.baseRows.slice();
      __renderBody(state, opts);
      __refreshHeaderStates(state);

      return state;
    }

    function __refreshHeaderStates(state) {
      const primary = state.sortStack[0] || null;
      state._ths.forEach((th, idx) => {
        const icon = th.querySelector('.sort-icon');
        const isActive = primary && primary.col === idx;

        th.classList.toggle('active-sort', isActive);
        if (!icon) return;

        if (!isActive) {
          icon.textContent = '';
          return;
        }
        icon.textContent = primary.dir === 'ASC' ? '▲' : '▼';
      });
    }

    function __renderBody(state, opts={}) {
      state.tbody.innerHTML = '';
      const frag = document.createDocumentFragment();

      if (!state.viewRows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = state.columns.length || 1;
        td.className = 'smallnote';
        td.textContent = 'No data';
        tr.appendChild(td);
        frag.appendChild(tr);
        state.tbody.appendChild(frag);
        return;
      }

      state.viewRows.forEach((row, rIdx) => {
        const tr = document.createElement('tr');

        if (typeof opts.onRowClick === 'function') {
          tr.style.cursor = 'pointer';
          tr.addEventListener('click', () => opts.onRowClick(row, rIdx));
        }

        state.columns.forEach((col) => {
          const td = document.createElement('td');

          const raw = col.cellValue ? col.cellValue(row) : '';
          const text = (raw === null || raw === undefined) ? '' : ('' + raw);

          td.textContent = text;
          td.title = text;

          if (col.isNum) td.classList.add('num');

          // RAG status cell rendering (MILA-style colored square + label)
          const isRagCol = (col.role === 'rag') || ((col.label || '').toString().trim().toLowerCase() === 'rag');
          if (isRagCol) {
            td.classList.add('rag');

            const v = (text || '').toString().trim().toUpperCase();
            const textNorm = (v === 'GOOD' || v === 'GREEN' || v === 'OK')
              ? 'good'
              : (v === 'WARN' || v === 'AMBER' || v === 'YELLOW')
              ? 'warn'
              : (v === 'BAD' || v === 'RED')
              ? 'bad'
              : 'unk';

            // RCA row builders attach metric metadata so RAG label+color can be derived
            // from the same classification logic and stay in sync. Use effectiveBetter so
            // positive (higher=good) vs negative (lower=good) context is correct.
            const metric = (row && Number.isFinite(row.__ragValue)) ? row.__ragValue : NaN;
            const kind = (row && row.__ragKind) ? row.__ragKind : 'rate';
            const thresholds = (row && row.__ragThresholds) ? row.__ragThresholds : null;
            const ragMode = (row && row.__ragMode) ? row.__ragMode : 'outage';
            const effectiveBetter = (row && row.__ragBetter) ? row.__ragBetter : inferBetter(kind, thresholds);

            let norm = (row && row.__ragStatus) ? row.__ragStatus : textNorm;
            if ((!row || !row.__ragStatus) && Number.isFinite(metric) && thresholds) {
              norm = classify(metric, thresholds, kind);
            }
            if (norm !== 'good' && norm !== 'warn' && norm !== 'bad') norm = 'unk';

            td.textContent = '';
            const pill = document.createElement('span');
            pill.className = 'rag-pill';

            const sq = document.createElement('span');
            sq.className = 'rag-sq';

            // RAG color is percentage-driven in both contexts:
            // - positive: classic red -> amber -> green (higher metric % = greener)
            // - outage: light red -> hot red by impact percentage
            let color = ragColorFromStatus(norm);
            const metricPct = ragMetricPercent(metric, kind, thresholds);
            if (Number.isFinite(metricPct)) {
              const impactPct = (effectiveBetter === 'higher' && ragMode !== 'positive')
                ? (100 - metricPct)
                : metricPct;
              color = (ragMode === 'positive')
                ? milaGetColor(metricPct)
                : ragNegativeImpactColor(impactPct);
            } else if (Number.isFinite(metric) && effectiveBetter) {
              color = milaColorForValue(metric, effectiveBetter, kind, thresholds);
            }
            sq.style.background = color;

            const lbl = document.createElement('span');
            if (ragMode === 'positive' && Number.isFinite(metric)) {
              lbl.textContent = ragPositivePercentText(metric);
            } else {
              lbl.textContent = (norm === 'unk') ? (v || '—') : norm.toUpperCase();
            }

            pill.appendChild(sq);
            pill.appendChild(lbl);
            td.appendChild(pill);
          }

          tr.appendChild(td);
        });

        frag.appendChild(tr);
      });

      state.tbody.appendChild(frag);
    }

    function renderSimpleTable(title, headers, rows, opts={}) {
      const wrap = document.getElementById('rcaTableWrap');
      if (!wrap) return;

      const titleHtml = `<strong>${title}</strong>`;

      // Column-type heuristics:
      // - We want numeric alignment for metrics (%, counts) but NOT for identifier-ish fields
      //   like requestor-id which are numeric but conceptually labels.
      const __forceTextCol = (label) => {
        const s = (label ?? '').toString().trim().toLowerCase();
        if (!s) return false;
        if (s === 'rag') return true;
        if (s === 'type' || s === 'dimkey' || s === 'dimval') return true;
        if (s === 'dc') return true;
        // common dimension-ish columns
        if (s.includes('mvpd') || s.includes('proxy') || s.includes('reason') || s.includes('event')) return true;
        // IDs are often numeric, but we want them left-aligned like labels
        if (s.endsWith('-id') || s.includes(' id') || s.includes('requestor')) return true;
        return false;
      };

      const columns = (headers || []).map((h, idx) => {
        const label = (h ?? '').toString();
        const labelLc = label.trim().toLowerCase();

        // Determine if column is mostly numeric for alignment.
        let isNum = false;
        if (!__forceTextCol(label)) {
          let hits = 0;
          let seen = 0;
          for (let i = 0; i < Math.min(25, rows.length); i++) {
            const v = rows[i]?.[idx];
            if (v === null || v === undefined || v === '') continue;
            seen++;
            if (Number.isFinite(__toNumberLoose(v))) hits++;
          }
          // require that at least half of sampled non-empty values look numeric
          isNum = (seen > 0) ? (hits / seen >= 0.5) : false;
        }

        return {
          label,
          isNum,
          role: (labelLc === 'rag') ? 'rag' : '',
          cellValue: (row) => row?.[idx],
          sortValue: (row) => row?.[idx]
        };
      });

      const state = createSortableTable(wrap, titleHtml, columns, rows || [], {
        onRowClick: opts.onRowClick || null,
        sortStack: opts.sortStack || [],
        footerCsv: true,
        footerCsvLabel: 'CSV',
        footerCsvTitle: (opts.rawExport && opts.rawExport.url)
          ? 'Export raw ESM CSV for this table (limit=100000)'
          : 'Export this RCA table as CSV',
        onFooterCsv: () => handleRcaCsvExport()
      });

      // Store export meta for the drawer CSV button.
      const name = __stripTags(title) || 'esm';
      rcaState.tableName = name;
      rcaState.tableCsv = { headers: headers || [], rows: rows || [] };
      if (opts.rawExport && opts.rawExport.url) {
        rcaState.tableExport = {
          kind: 'esm',
          name: opts.rawExport.name || name,
          url: opts.rawExport.url,
          postFilter: opts.rawExport.postFilter || null,
          state
        };
      } else {
        rcaState.tableExport = { kind: 'matrix', name, headers: headers || [], state };
      }

      return state;
    }

    function __safeRate(numer, denom) {
      const d = Math.max(1, safeNum(denom));
      return safeNum(numer) / d;
    }

    function __buildDateString(row) {
      const y = safeNum(row.year) || 1970;
      const m = safeNum(row.month) || 1;
      const d = safeNum(row.day) || 1;
      const h = safeNum(row.hour) || 0;
      const min = safeNum(row.minute) || 0;
      return new Date(y, m - 1, d, h, min).toLocaleString();
    }

    function __buildDateMs(row) {
      const y = safeNum(row.year) || 1970;
      const m = safeNum(row.month) || 1;
      const d = safeNum(row.day) || 1;
      const h = safeNum(row.hour) || 0;
      const min = safeNum(row.minute) || 0;
      return new Date(y, m - 1, d, h, min).getTime();
    }

    function renderEsmReportTable(hostEl, title, reportRows, opts={}) {
      if (!hostEl) return;

      const rows = Array.isArray(reportRows) ? reportRows : [];
      const row0 = rows[0] || null;

      const DATE_PARTS = ['year','month','day','hour','minute'];
      const METRICS = new Set(METRIC_FIELDS || []);

      const hasDate = !!(row0 && (row0.year !== undefined || row0.month !== undefined || row0.day !== undefined));
      const hasAuthN = !!(row0 && row0['authn-attempts'] !== undefined && row0['authn-successful'] !== undefined);
      const hasAuthZ = !!(row0 && row0['authz-attempts'] !== undefined && row0['authz-successful'] !== undefined);
      const hasCount = !!(row0 && row0.count !== undefined);

      const displayCols = row0
        ? Object.keys(row0).filter(c =>
            !METRICS.has(c) &&
            !DATE_PARTS.includes(c) &&
            c !== 'media-company' &&
            !EXCLUDED_LEGACY_COLUMNS.has(c)
          )
        : [];

      const columns = [];

      if (hasDate) {
        columns.push({
          label: 'DATE',
          isNum: false,
          cellValue: (r) => __buildDateString(r),
          sortValue: (r) => __buildDateMs(r)
        });
      }

      if (hasAuthN) {
        columns.push({
          label: 'AuthN Success',
          isNum: true,
          cellValue: (r) => fmtPct(__safeRate(r['authn-successful'], r['authn-attempts'])),
          sortValue: (r) => __safeRate(r['authn-successful'], r['authn-attempts'])
        });
      }

      if (hasAuthZ) {
        columns.push({
          label: 'AuthZ Success',
          isNum: true,
          cellValue: (r) => fmtPct(__safeRate(r['authz-successful'], r['authz-attempts'])),
          sortValue: (r) => __safeRate(r['authz-successful'], r['authz-attempts'])
        });
      }

      if (!hasAuthN && !hasAuthZ && hasCount) {
        columns.push({
          label: 'COUNT',
          isNum: true,
          cellValue: (r) => fmtInt(safeNum(r.count)),
          sortValue: (r) => safeNum(r.count)
        });
      }

      displayCols.forEach((c) => {
        columns.push({
          label: c,
          isNum: false,
          cellValue: (r) => (r && r[c] !== undefined && r[c] !== null) ? r[c] : '',
          sortValue: (r) => (r && r[c] !== undefined && r[c] !== null) ? r[c] : ''
        });
      });

      const urlNote = opts.esmUrl ? `<br/>URL: <span class="kbd">${opts.esmUrl.replace('https://mgmt.auth.adobe.com', '')}</span>` : '';
      const rowNote = `<br/>Rows: ${rows.length.toLocaleString()}`;
      const titleHtml = `<strong>${title}</strong>${urlNote}${rowNote}`;

      // Default sort to DATE DESC (like fullsort.html), if DATE exists.
      const defaultSort = (hasDate && columns.length) ? [{ col: 0, dir: 'DESC' }] : [];

      const state = createSortableTable(hostEl, titleHtml, columns, rows, {
        sortStack: defaultSort,
        onRowClick: opts.onRowClick || null,
        footerCsv: true,
        footerCsvLabel: 'CSV',
        footerCsvTitle: 'Export raw ESM CSV for this table (limit=100000)',
        onFooterCsv: () => handleRcaCsvExport()
      });

      // Set export spec for drawer CSV button.
      if (opts.setExport !== false) {
        const name = opts.exportName || (__stripTags(title) || 'esm_report');
        rcaState.tableName = name;
        rcaState.tableExport = {
          kind: 'esm',
          name,
          url: opts.esmUrl || null,
          postFilter: opts.postFilter || null,
          state
        };
      }

      return state;
    }

    function __csvEscape(val) {
      if (val === null || val === undefined) return '';
      let s = ('' + val);
      // Escape CR/LF too
      if (/["\n\r,]/.test(s)) {
        s = '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    }

    async function downloadEsmCsv(exportSpec) {
      if (!exportSpec?.url) {
        toast('No ESM URL available for CSV export.');
        return;
      }

      try {
        __netStart('csv');
        const r = await fetchWithRefresh(exportSpec.url, { limit: ESM_CSV_EXPORT_LIMIT });
        if (!r.ok) {
          console.warn('[CSV] fetch failed', r.status, r.statusText);
          toast(`CSV export failed (${r.status})`);
          return;
        }
        const j = await r.json();
        let report = Array.isArray(j.report) ? j.report : [];

        if (typeof exportSpec.postFilter === 'function') {
          report = report.filter(exportSpec.postFilter);
        }

        if (!report.length) {
          toast('CSV export: no rows.');
          return;
        }

        // Sort report to match current table sort (multi-sort supported).
        const state = exportSpec.state;
        if (state?.sortStack?.length && state?.columns?.length) {
          report = __sortByStack(report, state.sortStack, state.columns);
        }

        const headers = Object.keys(report[0]).filter(h => !EXCLUDED_LEGACY_COLUMNS.has(h));
        const lines = [];
        lines.push(headers.map(__csvEscape).join(','));

        for (const row of report) {
          lines.push(headers.map(h => __csvEscape(row[h])).join(','));
        }

        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (exportSpec.name || 'esm') + '.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          URL.revokeObjectURL(a.href);
          a.remove();
        }, 250);
      } catch (e) {
        console.error('[CSV] export error', e);
        toast('CSV export failed (exception).');
      } finally {
        __netEnd('csv');
      }
    }

    async function openScopedRca(signal, dimKey, dimVal, bucketKey=null) {
      const win = computeDrillWindow();

      // Choose a datasource that includes dimKey
      let base = pickDimDataSourceUrl(dimKey, win);

      const rows = await fetchReport(base, win);

      // Filter rows for the slice (if datasource has that dim)
      const scopedRows = rows.filter(r => (r[dimKey] ?? '').toString() === dimVal);

      // Build index for slice
      const idx = indexReport(scopedRows, win, []);
      const series = computeSignalSeries(signal, idx, win);

      // Keep clicked bucket context when possible; otherwise auto-pick latest valid.
      const normalizedBucketKey = normalizeDrillBucketKey(win, bucketKey);
      openRca(signal, series, { dimKey, dimVal }, null, normalizedBucketKey);
    }

    async function renderRawRows(signal, ctx) {
      const win = computeWindow();

      // For raw rows we want a datasource that actually contains the ctx dimension.
      let base = pickSignalDataSourceUrl(signal, win);

      if (ctx?.dimKey) {
        base = pickDimDataSourceUrl(ctx.dimKey, win);
      }

      const url = appendFilterParams(withTimeParams(base, win));

      const rows = await fetchReport(base, win);
      const positiveMode = isPositiveRcaSignal(signal);
      const postFilter = (row) => {
        if (row && Object.prototype.hasOwnProperty.call(row, 'event')) {
          if (!isEventAllowedForRca(signal, row.event)) return false;
          if (!positiveMode && shouldHidePositiveNoneReasonRow(row)) return false;
        }
        if (!ctx?.dimKey || !ctx?.dimVal) return true;
        return (row[ctx.dimKey] ?? '').toString() === ctx.dimVal;
      };

      const filtered = rows.filter(postFilter);

      const title = ctx?.dimKey && ctx?.dimVal
        ? `Raw ESM rows — ${ctx.dimKey}=${ctx.dimVal}`
        : 'Raw ESM rows';

      renderEsmReportTable(
        document.getElementById('rcaTableWrap'),
        title,
        filtered,
        {
          esmUrl: url,
          exportName: (ctx?.dimKey && ctx?.dimVal)
            ? `raw_esm_${signal.id}_${ctx.dimKey}_${ctx.dimVal}`
            : `raw_esm_${signal.id}`,
          postFilter
        }
      );
    }

    async function renderRcaDefaultTable(signal, ctx, bucketKey) {
      // If we're already scoped, default table is a context-sensitive pivot.
      if (ctx?.dimKey) {
        if (ctx.dimKey === 'mvpd') return await drillWithinMvpd(signal, ctx, bucketKey);
        if (ctx.dimKey === 'requestor-id') return await drillWithinRequestor(signal, ctx, bucketKey);
        if (ctx.dimKey === 'dc') return await drillWithinDc(signal, ctx, bucketKey);
      }

      const rateSig = mkRateSignalFromCore(signal);
      const rankingMode = rcaRankingMode(signal);
      const win = computeDrillWindow();
      const targetKey = normalizeDrillBucketKey(win, bucketKey);

      const [mvpdRows, reqRows, dcRows] = await Promise.all([
        fetchReport(pickCoreDataSourceUrl('mvpd', win), win),
        fetchReport(pickCoreDataSourceUrl('requestor', win), win),
        fetchReport(pickDcDataSourceUrl(win), win)
      ]);

      const mvpdIdx = indexReport(mvpdRows, win, ['mvpd']);
      const reqIdx  = indexReport(reqRows,  win, ['requestor-id']);
      const dcIdx   = indexReport(dcRows,   win, ['dc']);

      const mvpdOff = topMvpdFromDim(mvpdIdx.byDim.get('mvpd') || new Map(), win, rateSig, targetKey, 50, rankingMode, 10);
      const reqOff  = topOffendersFromDim('requestor-id', reqIdx.byDim.get('requestor-id') || new Map(), win, rateSig, targetKey, 0, rankingMode, 0);
      const dcOff   = topOffendersFromDim('dc', dcIdx.byDim.get('dc') || new Map(), win, rateSig, targetKey, 50, rankingMode);

      const rows = [];
      const positiveMode = isPositiveRcaSignal(signal);
      const addRows = (type, dimKey, offenders) => {
        offenders.forEach(o => {
          const st = classifyForSignal(rateSig, o.value);
          const rag = positiveMode ? ragPositivePercentText(o.value) : st.toUpperCase();
          const arr = [
            type,
            dimKey,
            o.dimVal,
            fmtSignalValue(rateSig, o.value),
            fmtInt(o.attempts),
            rag
          ];
          arr.__ragValue = o.value;
          arr.__ragStatus = st;
          arr.__ragKind = rateSig?.type || 'rate';
          arr.__ragThresholds = rateSig?.thresholds || null;
          arr.__ragBetter = inferBetter(rateSig?.type, rateSig?.thresholds);
          arr.__ragMode = positiveMode ? 'positive' : 'outage';
          rows.push(arr);
        });
      };

      addRows('MVPD', 'mvpd', mvpdOff);
      addRows('Requestor', 'requestor-id', reqOff);
      addRows('DC', 'dc', dcOff);

      const title = isPositiveRcaSignal(signal)
        ? `Top success distribution for ${rateSig.label} — bucket ${targetKey || win.buckets[win.buckets.length-1]?.key || ''}`
        : `Probable RCA offenders for ${rateSig.label} — bucket ${targetKey || win.buckets[win.buckets.length-1]?.key || ''}`;

      renderSimpleTable(
        title,
        ['Type','dimKey','dimVal', rateSig.label, drillVolumeLabel(rateSig), 'RAG'],
        rows,
        {
          onRowClick: (row) => {
            // row = [Type, dimKey, dimVal, ...]
            const dimKey = row[1];
            const dimVal = row[2];
            openScopedRca(signal, dimKey, dimVal, targetKey).catch((err) => {
              console.error('[RCA] scoped offender open failed', err);
              renderDrillFallback(`open ${dimKey}`, err);
            });
          }
        }
      );
    }

    /* ---------- Dictionary runner inside drawer ---------- */
    function populateDictSelect() {
      const sel = document.getElementById('dictSelect');
      if (!sel) return;
      sel.innerHTML = '';

      // Show live monitoring tree first: minute -> hour -> day.
      const options = [...ESM_DICTIONARY]
        .slice()
        .sort((a,b) => {
          const rank = (url) => {
            if (url.includes('/hour/minute')) return 0;
            if (url.includes('/day/hour')) return 1;
            if (url.includes('/day')) return 2;
            return 3;
          };
          const ah = rank(a.url);
          const bh = rank(b.url);
          if (ah !== bh) return ah - bh;
          return a.url.localeCompare(b.url);
        });

      options.forEach((e, idx) => {
        const o = document.createElement('option');
        o.value = e.url;
        const cols = (e.cols && e.cols.length) ? e.cols.join(', ') : 'no columns listed';
        o.textContent = e.url.replace('https://mgmt.auth.adobe.com','') + '  —  ' + cols;
        sel.appendChild(o);
      });
    }

    async function runDictQuery() {
      const sel = document.getElementById('dictSelect');
      if (!sel) return;
      const baseUrl = sel.value;
      if (!baseUrl) return;

      const win = computeWindow();
      const fullUrl = appendFilterParams(withTimeParams(baseUrl, win));

      const rows = await fetchReport(baseUrl, win);

      const out = document.getElementById('dictResult');
      if (!out) return;

      renderEsmReportTable(out, 'Dictionary query', rows, {
        esmUrl: fullUrl,
        exportName: 'dictionary_query'
      });
    }

    /* ---------- Main Refresh Flow ---------- */
    let __refreshTimer = null;

    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      // theme also changes signal rendering density (bucket labels etc) via CSS only for now.
    }

    async function refreshAll() {
      if (!state.esmClient?.client_id) {
        setStatus('Login + select Media Co/ESM App to load', 'warn');
        return;
      }

      const win = computeWindow();
      const view = document.body.getAttribute('data-theme') || 'boom';
      applyTheme(view);

      const unitLabel = win.lookbackUnit === 'day' ? 'd' : win.lookbackUnit === 'minute' ? 'm' : 'h';
      const dirLabel = win.direction === 'forward' ? 'Next' : 'Last';
      document.getElementById('gridTitle').textContent =
        `HEATER (${dirLabel} ${win.lookbackValue}${unitLabel} • AUTO ${win.bucketSize.toUpperCase()})`;
      const bucketTag = document.getElementById('bucketAutoTag');
      if (bucketTag) bucketTag.textContent = `AUTO: ${win.bucketSize.toUpperCase()}`;

      const reqSel = document.getElementById('fltr_requestorid');
        const mvpdSel = document.getElementById('fltr_mvpdId');
        const reqIds = getSelectedFilterValues(reqSel);
        const mvpdIds = (mvpdSel && !mvpdSel.disabled) ? getSelectedFilterValues(mvpdSel) : [];

        const bits = [];
        if (reqIds.length) bits.push('requestor-id=' + reqIds.join(','));
        if (mvpdIds.length) bits.push('mvpd=' + mvpdIds.join(','));
        const filtersText = bits.length ? ('Filters: ' + bits.join(' • ')) : 'No filters';

      const overallUrl = pickCoreDataSourceUrl('overall', win);
      const requestorUrl = pickCoreDataSourceUrl('requestor', win);
      const mvpdUrl = pickCoreDataSourceUrl('mvpd', win);
      const dcUrl = pickDcDataSourceUrl(win);

      const exportModel = {
        exportedAt: new Date().toISOString(),
        view,
        programmerId: state.selectedProgrammerId || '',
        programmerName: state.selectedProgrammerName || '',
        appGuid: state.selectedAppGuid || '',
        appName: state.selectedAppName || '',
        mediaCompany: (document.getElementById('mcTag')?.textContent || '').trim(),
        windowStart: win.startIso,
        windowEnd: win.endIso,
        bucketSize: win.bucketSize,
        lookbackValue: win.lookbackValue,
        lookbackUnit: win.lookbackUnit,
        lookDirection: win.direction,
        filters: { requestorIds: reqIds, mvpdIds: mvpdIds },
        buckets: win.buckets.map(b => ({ key: b.key, label: b.label })),
        rows: []
      };

      document.getElementById('gridSubtitle').textContent =
        `Window: ${win.startIso} → ${win.endIso} • Grain: ${win.bucketSize.toUpperCase()} • Core: ${shortEsmPath(overallUrl)} (${getEsmCols(overallUrl).length} cols) • ${filtersText} • v${APP_VERSION}`;

      // Fetch core data once (auto DAY/HR/MIN tree from lookback)
      const [overallRows, reqRows, mvpdRows, dcRows] = await Promise.all([
        fetchReport(overallUrl, win),
        fetchReport(requestorUrl, win),
        fetchReport(mvpdUrl, win),
        fetchReport(dcUrl, win)
      ]);

      const overallIdx = indexReport(overallRows, win, []);
      const reqIdx = indexReport(reqRows, win, ['requestor-id']);
      const mvpdIdx = indexReport(mvpdRows, win, ['mvpd','proxy']);
      const dcIdx = indexReport(dcRows, win, ['dc']);

      // Build render list
      const search = (document.getElementById('searchBox')?.value || '').trim().toLowerCase();
      const grid = document.getElementById('grid');
      clear(grid);
      grid.style.setProperty('--bucket-cols', String(Math.max(1, win.buckets.length)));
      grid.style.minWidth = `${Math.max(900, 340 + (win.buckets.length * 26))}px`;

      renderHeaderRow(grid, win);

      // Core groups
      const groups = [
        { name: 'AuthN', items: CORE_SIGNALS.filter(s => s.group === 'AuthN') },
        { name: 'AuthZ', items: CORE_SIGNALS.filter(s => s.group === 'AuthZ') },
        { name: 'Traffic', items: CORE_SIGNALS.filter(s => s.group === 'Traffic') }
      ];

      // Count matches for UX
      let matchCount = 0;

      for (const g of groups) {
        const visible = g.items.filter(s => {
          const hay = (s.label + ' ' + s.story + ' ' + s.group).toLowerCase();
          if (search && !hay.includes(search)) return false;
          const sourceUrl = isDcSignal(s) ? dcUrl : overallUrl;
          return signalSupportedBySource(s, sourceUrl);
        });
        if (!visible.length) continue;

        renderGroupRow(grid, g.name, win);

        visible.forEach(sig => {
          const series = computeSignalSeries(sig, isDcSignal(sig) ? dcIdx : overallIdx, win);
          renderSignalRow(grid, sig, series, { kind: 'core' });
          exportModel.rows.push(makeExportRow(sig, series, { kind: 'core' }));
          matchCount++;
        });
      }

      document.getElementById('matchCount').textContent = matchCount + ' signals';

      renderDcReportPanel(dcIdx, win, getDcSourceLabel(win));

      const deviceReportWrap = document.getElementById('deviceReportWrap');
      if (reqIds.length > 0) {
        const daySpan = Math.max(1, Math.min(31, Math.ceil(getWindowDurationMinutes(win) / 1440)));
        const dayWin = computeDayWindow(daySpan, win.direction);
        const deviceRows = await fetchReport(pickDeviceDataSourceUrl(), dayWin);
        renderDeviceReportPanel(deviceRows, dayWin, getDeviceSourceLabel());
      } else {
        if (deviceReportWrap) deviceReportWrap.style.display = 'none';
        const deviceTableWrap = document.getElementById('deviceReportTableWrap');
        if (deviceTableWrap) clear(deviceTableWrap);
      }

      const reasonReportWrap = document.getElementById('reasonReportWrap');
      try {
        const reasonUrl = pickReasonDataSourceUrl(win);
        const reasonRows = await fetchReport(reasonUrl, win);
        renderReasonReportPanel(reasonRows, win, getReasonSourceLabel(win));
      } catch (e) {
        if (reasonReportWrap) reasonReportWrap.style.display = 'block';
        const reasonTableWrap = document.getElementById('reasonReportTableWrap');
        if (reasonTableWrap) {
          clear(reasonTableWrap);
          const p = document.createElement('p');
          p.className = 'smallnote';
          p.style.padding = '14px 16px';
          p.textContent = 'Reason report unavailable: ' + (e?.message || e);
          reasonTableWrap.appendChild(p);
        }
      }

      state.lastRenderModel = exportModel;
      state.lastRefreshAt = new Date();
      setStatus('Ready • last refresh ' + fmtLocalTime(state.lastRefreshAt), 'ok');

      // Restore RCA from URL hash only once per page load.
      // This prevents the panel from popping open repeatedly during auto-refresh.
      if (state.restoreRcaFromHashPending) {
        state.restoreRcaFromHashPending = false;
        if (!rcaState.open) {
          const h = parseHash();
          if (h.sig) {
            const sig = CORE_SIGNALS.find(s => s.id === h.sig);
            if (sig) {
              const hasScopedCtx = !!(h.dimk && h.dimv);
              if (hasScopedCtx) {
                try {
                  await openScopedRca(sig, h.dimk, h.dimv, h.bucket);
                } catch (e) {
                  console.error('[hash restore] scoped RCA failed', e);
                  const series = computeSignalSeries(sig, isDcSignal(sig) ? dcIdx : overallIdx, win);
                  openRca(sig, series, { kind:'core' }, null, h.bucket);
                }
              } else {
                const series = computeSignalSeries(sig, isDcSignal(sig) ? dcIdx : overallIdx, win);
                openRca(sig, series, { kind:'core' }, null, h.bucket);
              }
            }
          }
        }
      }
    }

    function setupAutoRefresh() {
      const auto = document.getElementById('autoRefresh')?.checked;
      const sec = Number(document.getElementById('refreshSec')?.value || 60);

      if (__refreshTimer) {
        clearInterval(__refreshTimer);
        __refreshTimer = null;
      }

      if (auto) {
        __refreshTimer = setInterval(() => {
          refreshAll().catch(e => {
          setStatus('Auto refresh failed: ' + (e?.message || e), 'err');
          console.error(e);
        });
        }, sec * 1000);
      }
    }

    /* ---------- CSV Download ---------- */
    function downloadCsv(name, headers, rows) {
      const esc = (s) => {
        const v = String(s ?? '');
        if (/[",\n]/.test(v)) return '"' + v.replace(/"/g,'""') + '"';
        return v;
      };

      const lines = [];
      lines.push(headers.map(esc).join(','));
      rows.forEach(r => lines.push(r.map(esc).join(',')));

      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (name || 'esm_heatmap') + '.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    /* ---------- Export helpers ---------- */
    function safeFileToken(s) {
      return String(s || 'esm')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 80) || 'esm';
    }

    function makeExportRow(sig, series, ctx) {
      return {
        group: sig.group || '',
        signal_id: sig.id || '',
        label: sig.label || '',
        story: sig.story || '',
        type: sig.type || 'rate',
        // Include thresholds so exports can reproduce the same MILA-style coloring
        // used in the live UI (and the RCA table RAG column).
        thresholds: sig.thresholds || null,
        ctx: ctx || {},
        series: (series || []).map(pt => ({
          key: pt.key,
          label: pt.label,
          value: pt.value,
          status: pt.status
        }))
      };
    }

    function exportHeatmapCsv(model) {
      if (!model) return;

      const headers = [
        'exported_at','media_company','programmer_id','programmer_name','app_guid','app_name',
        'view','bucket_size','lookback_value','lookback_unit','look_direction','window_start','window_end',
        'filter_requestor_ids','filter_mvpd_ids',
        'group','signal_id','label','story','type','ctx_kind','ctx_dimKey','ctx_dimVal',
        'bucket_key','bucket_label','value','status'
      ];

      const req = (model.filters?.requestorIds || []).join('|');
      const mv = (model.filters?.mvpdIds || []).join('|');

      const rows = [];
      for (const row of model.rows || []) {
        for (const pt of row.series || []) {
          rows.push([
            model.exportedAt,
            model.mediaCompany,
            model.programmerId,
            model.programmerName,
            model.appGuid,
            model.appName,
            model.view,
            model.bucketSize,
            model.lookbackValue,
            model.lookbackUnit,
            model.lookDirection,
            model.windowStart,
            model.windowEnd,
            req,
            mv,
            row.group,
            row.signal_id,
            row.label,
            row.story,
            row.type,
            row.ctx?.kind || '',
            row.ctx?.dimKey || '',
            row.ctx?.dimVal || '',
            pt.key,
            pt.label,
            pt.value,
            pt.status
          ]);
        }
      }

      const base = safeFileToken(model.mediaCompany || model.programmerName || 'esm');
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      downloadCsv(`esm-heatmap-${base}-${stamp}`, headers, rows);
    }

    function cssVar(name, fallback) {
      const v = getComputedStyle(document.documentElement).getPropertyValue(name);
      const s = (v || '').trim();
      return s || fallback;
    }

    function statusColor(status) {
      const unk = cssVar('--unk', '#485063');
      const good = cssVar('--good', '#2aa95c');
      const warn = cssVar('--warn', '#f2cc0c');
      const bad  = cssVar('--bad',  '#e02f44');
      if (status === 'good') return good;
      if (status === 'warn') return warn;
      if (status === 'bad') return bad;
      return unk;
    }

    function downloadCanvasPng(canvas, filenameBase) {
      canvas.toBlob((blob) => {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filenameBase + '.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      }, 'image/png');
    }

    function exportHeatmapPng(model) {
      if (!model) return;

      const title = 'HEATER';
      const subtitleBits = [
        model.mediaCompany || model.programmerName || '',
        `Window: ${model.windowStart} → ${model.windowEnd}`,
      ];
      if ((model.filters?.requestorIds || []).length) subtitleBits.push('requestor-id=' + model.filters.requestorIds.join(','));
      if ((model.filters?.mvpdIds || []).length) subtitleBits.push('mvpd=' + model.filters.mvpdIds.join(','));
      const subtitle = subtitleBits.filter(Boolean).join(' • ');

      const buckets = model.buckets || [];
      const rows = model.rows || [];

      const pad = 18;
      const labelW = 320;
      const cell = 18;
      const gap = 4;
      const headerH = 92;
      const footerH = 22;

      const w = pad + labelW + (buckets.length * (cell + gap)) + pad;
      const h = pad + headerH + (rows.length * (cell + gap)) + footerH + pad;

      const canvas = document.createElement('canvas');
      canvas.width = Math.max(640, w);
      canvas.height = Math.max(240, h);
      const ctx = canvas.getContext('2d');

      const bg = cssVar('--bg', '#0b0f14');
      const text = cssVar('--text', '#e7e9ee');
      const muted = cssVar('--muted', '#98a2b3');
      const border = cssVar('--border', 'rgba(255,255,255,.08)');

      ctx.fillStyle = bg;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Title
      ctx.fillStyle = text;
      ctx.font = '700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(title, pad, pad + 22);

      ctx.fillStyle = muted;
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      wrapText(ctx, subtitle, pad, pad + 44, canvas.width - pad*2, 14);

      // Legend
      const legendY = pad + 70;
      const legend = [
        ['good','Good'],
        ['warn','Warn'],
        ['bad','Bad'],
        ['unk','No data']
      ];
      let lx = pad;
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      for (const [k, lbl] of legend) {
        ctx.fillStyle = statusColor(k==='unk'?'unk':k);
        ctx.fillRect(lx, legendY, 12, 12);
        ctx.strokeStyle = border;
        ctx.strokeRect(lx, legendY, 12, 12);
        lx += 18;
        ctx.fillStyle = muted;
        ctx.fillText(lbl, lx, legendY + 11);
        lx += ctx.measureText(lbl).width + 18;
      }

      // Column labels
      const gridX = pad + labelW;
      const gridY = pad + headerH;

      ctx.fillStyle = muted;
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      buckets.forEach((b, i) => {
        const x = gridX + i*(cell+gap);
        ctx.fillText(String(b.label || ''), x, gridY - 10);
      });

      // Rows
      let y = gridY;
      let lastGroup = null;
      rows.forEach((r, ri) => {
        const group = r.group || '';
        if (group && group !== lastGroup) {
          // group separator line
          ctx.strokeStyle = border;
          ctx.beginPath();
          ctx.moveTo(pad, y - 8);
          ctx.lineTo(canvas.width - pad, y - 8);
          ctx.stroke();
          lastGroup = group;
        }

        // label
        ctx.fillStyle = text;
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        const label = (r.label || r.signal_id || '').slice(0, 80);
        ctx.fillText(label, pad, y + 13);

        // cells
        (r.series || []).forEach((pt, i) => {
          const x = gridX + i*(cell+gap);
          const better = (r && r.thresholds && r.thresholds.better) ? r.thresholds.better : 'higher';
          ctx.fillStyle = milaColorForValue(pt.value, better, r.type || 'rate', r.thresholds || null);
          ctx.fillRect(x, y, cell, cell);
          ctx.strokeStyle = border;
          ctx.strokeRect(x, y, cell, cell);
        });

        y += (cell + gap);
      });

      // Footer
      ctx.fillStyle = muted;
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const foot = `Exported ${model.exportedAt}`;
      ctx.fillText(foot, pad, canvas.height - pad);

      const base = safeFileToken(model.mediaCompany || model.programmerName || 'esm');
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      downloadCanvasPng(canvas, `esm-heatmap-${base}-${stamp}`);
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = String(text || '').split(/\s+/);
      let line = '';
      let yy = y;
      for (const w of words) {
        const test = line ? (line + ' ' + w) : w;
        if (ctx.measureText(test).width > maxWidth && line) {
          ctx.fillText(line, x, yy);
          line = w;
          yy += lineHeight;
        } else {
          line = test;
        }
      }
      if (line) ctx.fillText(line, x, yy);
    }

    function exportRcaCsv() {
      if (!rcaState.tableCsv) return;
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      const base = safeFileToken(state.selectedProgrammerName || state.selectedProgrammerId || 'esm');
      downloadCsv(`esm-rca-${base}-${stamp}`, rcaState.tableCsv.headers, rcaState.tableCsv.rows);
    }

    function exportRcaPng() {
      if (!rcaState.open || !rcaState.signal || !rcaState.series) return;
      const sig = rcaState.signal;
      const series = rcaState.series;
      const b = series[rcaState.bucketIdx] || null;

      const pad = 18;
      const w = 980;
      const rowH = 18;
      const maxRows = 18;

      const table = rcaState.tableCsv;
      const rows = table?.rows || [];
      const headers = table?.headers || [];

      const h = 210 + Math.min(rows.length, maxRows) * rowH + pad;

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      const bg = cssVar('--bg', '#0b0f14');
      const text = cssVar('--text', '#e7e9ee');
      const muted = cssVar('--muted', '#98a2b3');
      const border = cssVar('--border', 'rgba(255,255,255,.08)');

      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);

      ctx.fillStyle = text;
      ctx.font = '700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('ESM RCA Receipt', pad, pad + 22);

      ctx.fillStyle = muted;
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const sub = [
        state.selectedProgrammerName || state.selectedProgrammerId || '',
        sig.label || sig.id || '',
        b ? (`Bucket: ${b.label}`) : '',
        b ? (`Status: ${b.status}`) : ''
      ].filter(Boolean).join(' • ');
      wrapText(ctx, sub, pad, pad + 44, w - pad*2, 14);

      // Mini heatline
      const x0 = pad;
      const y0 = pad + 78;
      const cell = 16;
      const gap = 4;
      series.forEach((pt, i) => {
        const x = x0 + i*(cell+gap);
        ctx.fillStyle = milaColorForPoint(sig, pt.value);
        ctx.fillRect(x, y0, cell, cell);
        ctx.strokeStyle = border;
        ctx.strokeRect(x, y0, cell, cell);
        ctx.fillStyle = muted;
        ctx.font = '10px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillText(pt.label, x, y0 + cell + 12);
      });

      // Table header
      const ty = pad + 140;
      ctx.strokeStyle = border;
      ctx.beginPath();
      ctx.moveTo(pad, ty);
      ctx.lineTo(w - pad, ty);
      ctx.stroke();

      ctx.fillStyle = muted;
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const cols = Math.min(headers.length, 6);
      const colW = (w - pad*2) / cols;
      for (let ci=0; ci<cols; ci++) {
        const hx = pad + ci*colW;
        ctx.fillText(String(headers[ci] || '').slice(0, 18), hx, ty + 14);
      }

      // Rows (top N)
      ctx.fillStyle = text;
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const startY = ty + 26;
      for (let ri=0; ri<Math.min(rows.length, maxRows); ri++) {
        const row = rows[ri];
        for (let ci=0; ci<cols; ci++) {
          const x = pad + ci*colW;
          ctx.fillText(String(row[ci] ?? '').slice(0, 22), x, startY + ri*rowH);
        }
      }

      ctx.fillStyle = muted;
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Exported ' + new Date().toISOString(), pad, h - pad);

      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      const base = safeFileToken(state.selectedProgrammerName || state.selectedProgrammerId || 'esm');
      downloadCanvasPng(canvas, `esm-rca-${base}-${stamp}`);
    }

    function exportCurrentCsv() {
      if (rcaState.open && rcaState.tableExport) {
        handleRcaCsvExport();
        return;
      }
      if (rcaState.open && rcaState.tableCsv) return exportRcaCsv();
      if (!state.lastRenderModel) return alert('Nothing to export yet (refresh first).');
      exportHeatmapCsv(state.lastRenderModel);
    }

    function exportCurrentPng() {
      if (rcaState.open && rcaState.signal) return exportRcaPng();
      if (!state.lastRenderModel) return alert('Nothing to export yet (refresh first).');
      exportHeatmapPng(state.lastRenderModel);
    }

    /* ---------- Event Listeners ---------- */
    function wireUi() {
      // Build tag (subtle corner badge)
      const bc = document.getElementById('buildCorner');
      if (bc) {
        const iso = new Date().toISOString().replace('T',' ').replace('Z',' UTC');
        bc.textContent = 'build ' + iso;
      }

      const safeRefresh = () => refreshAll().catch(e => {
        setStatus('Refresh failed: ' + (e?.message || e), 'err');
        console.error(e);
      });

      // Login modal controls
      document.getElementById('cancelLoginBtn')?.addEventListener('click', () => showLoginModal(false));
      document.getElementById('closeModalBtn')?.addEventListener('click', () => showLoginModal(false));
      document.getElementById('retryAuthBtn')?.addEventListener('click', async () => {
        showLoginModal(true, 'Re-checking Adobe session…');
        const ok = await checkAuthentication();
        if (ok) {
          showLoginModal(false);
          await autoSelectProgrammerAndBoot();
        } else {
          showLoginModal(true, 'Still not authenticated. If you just logged in, wait a moment and try again.');
        }
      });

      // Auth / Session
      document.getElementById('authBtn')?.addEventListener('click', async () => {
        // Always open login popup (also useful to refresh session)
        await initiateAdobeLogin();
      });
      document.getElementById('authGateBtn')?.addEventListener('click', async () => {
        await initiateAdobeLogin();
      });

      // Media Company / App selection
      document.getElementById('programmerSelect')?.addEventListener('change', async (e) => {
        const pid = e.target.value;
        if (!pid) return;
        await onProgrammerSelected(pid);
      });

      document.getElementById('appSelect')?.addEventListener('change', async (e) => {
        const guid = e.target.value;
        if (!guid) return;
        await onAppSelected(guid);
      });

      // Advanced tools
      document.getElementById('btnManualCreds')?.addEventListener('click', async () => {
        const pid = state.selectedProgrammerId || document.getElementById('programmerSelect')?.value || '';
        if (!pid) return alert('Select a Media Company first.');

        const cid = prompt('Enter client_id (cid) for this Media Company:', '')?.trim();
        if (!cid) return;
        const csc = prompt('Enter client_secret (csc) for this Media Company:', '')?.trim();
        if (!csc) return;

        const client = {
          client_id: cid,
          client_secret: csc,
          appGuid: state.selectedAppGuid || '',
          appName: state.selectedAppName || 'manual',
          createdAt: new Date().toISOString(),
          source: 'manual'
        };
        setStoredClientForProgrammer(pid, client);
        setEsmClient(client);

        setStatus('ESM client: manually set + cached', 'ok');
        await bootAfterEsmReady();
      });

      document.getElementById('btnResetClient')?.addEventListener('click', async () => {
        const pid = state.selectedProgrammerId || document.getElementById('programmerSelect')?.value || '';
        if (!pid) return;
        if (!confirm('Forget stored client_id/client_secret for this Media Company and re-provision via DCR?')) return;

        clearStoredClientForProgrammer(pid);
        state.esmClient = null;
        clearTokenForCurrentClient();

        setStatus('Client cleared. Re-provisioning…', 'warn');
        try {
          await ensureEsmClientReady({ allowProvision: true });
          await bootAfterEsmReady();
        } catch (e) {
          setStatus('Re-provision failed: ' + (e?.message || e), 'err');
        }
      });

      document.getElementById('btnClearToken')?.addEventListener('click', () => {
        clearTokenForCurrentClient();
        alert('Cleared cached access token.');
      });

      // Exports (context aware)
      document.getElementById('btnExportCsv')?.addEventListener('click', () => exportCurrentCsv());
      document.getElementById('btnExportPng')?.addEventListener('click', () => exportCurrentPng());

      // Core UX controls
      document.getElementById('btnRefresh')?.addEventListener('click', () => safeRefresh());
      document.getElementById('lookbackValue')?.addEventListener('change', () => { setupAutoRefresh(); safeRefresh(); });
      document.getElementById('lookbackValue')?.addEventListener('blur', () => { setupAutoRefresh(); safeRefresh(); });
      document.getElementById('lookbackUnit')?.addEventListener('change', () => { setupAutoRefresh(); safeRefresh(); });
      document.getElementById('lookDirection')?.addEventListener('change', () => { setupAutoRefresh(); safeRefresh(); });
      document.getElementById('refreshSec')?.addEventListener('change', () => setupAutoRefresh());
      document.getElementById('autoRefresh')?.addEventListener('change', () => setupAutoRefresh());
      document.getElementById('searchBox')?.addEventListener('input', () => safeRefresh());

      // Filters
      document.getElementById('fltr_requestorid')?.addEventListener('change', async () => {
        const reqSel = document.getElementById('fltr_requestorid');
        if (reqSel) {
          // Any interaction means the browser auto-selected-first-option guard can be disabled.
          setFilterTouched(reqSel, true);
        }
        await refreshMvpdSelector();
        safeRefresh();
      });
      document.getElementById('fltr_mvpdId')?.addEventListener('change', () => {
        const mvpdSel = document.getElementById('fltr_mvpdId');
        if (mvpdSel) setFilterTouched(mvpdSel, true);
        safeRefresh();
      });

      document.getElementById('btnClearFilters')?.addEventListener('click', async () => {
        const reqSel = document.getElementById('fltr_requestorid');
        const mvpdSel = document.getElementById('fltr_mvpdId');
        if (reqSel) {
          [...reqSel.options].forEach(o => o.selected = false);
          setFilterTouched(reqSel, false);
        }
        if (mvpdSel) {
          [...mvpdSel.options].forEach(o => o.selected = false);
          setFilterTouched(mvpdSel, false);
        }
        __hideMvpdSelector();
        safeRefresh();
      });

      enableClickToggleMultiSelect(document.getElementById('fltr_requestorid'));
      enableClickToggleMultiSelect(document.getElementById('fltr_mvpdId'));

      // Drawer UX
      document.getElementById('btnCloseDrawer')?.addEventListener('click', () => closeDrawer());
      document.getElementById('drawer')?.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'drawer') closeDrawer();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && rcaState.open) closeDrawer();
      });

      document.getElementById('btnDownloadCsv')?.addEventListener('click', () => {
        handleRcaCsvExport();
      });

      document.getElementById('btnCopyLink')?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(location.href);
          alert('Link copied to clipboard');
        } catch {
          prompt('Copy link:', location.href);
        }
      });

      document.getElementById('btnRunDict')?.addEventListener('click', () => {
        runDictQuery().catch(console.warn);
      });
    }

    /* ---------- Init ---------- */
    async function main() {
      wireUi();
      populateDictSelect();
      setAuthenticatedUi(false);
      setStatus(UNAUTH_MESSAGE, 'warn');

      // Apply initial theme immediately (no fetch required)
      applyTheme(document.body.getAttribute('data-theme') || 'boom');

      // Check Adobe console session and (if possible) auto-boot.
      const ok = await checkAuthentication();
      if (ok) {
        await autoSelectProgrammerAndBoot();
      }
    }

    main().catch(e => {
      console.error(e);
      alert('Failed to initialize: ' + (e?.message || e));
    });</script>
</body>
</html>
